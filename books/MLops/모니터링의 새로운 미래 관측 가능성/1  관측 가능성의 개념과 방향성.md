시스템을 운영하는 데 모니터링의 역할은 매우 중요하다.

## 1.1 관측 가능성의 세 가지 요소

### 1.1.1 모니터링과 차이점

- 관측 가능성의 정의는 다음과 같다.

> 시스템에서 외부로 출력되는 값만을 사용해서, 시스템의 내부 상태를 이해하고 예측하는 것

관측 가능성은 모니터링을 대체하는 개념이 아니다.

하지만 다수 유사한 점을 가지고 있다.

그림에서 보여주는 것처럼 모니터링은 블랙박스와 화이트박스 영역을 포함하지만, 관측 가능성은 화이트박스와 예측 영역을 포함한다 .

관측 가능성이 지향하는 목표는 내부 시스템에 대한 자세한 이해를 기반으로 미래에 발생할 이벤트를 예측하는 것이고, 이러한 예측을 바탕으로 IT 운영을 자동화하는 것이다.

관측 가능성은 학술적 용어일뿐 새로운 개념은 아니다.

예를 들어 ES로 로그를 관리하거나, 다이나트레이스, APM을 사용해서 처리량과 지연시간을 모니터링하고, 인플럭스 데이터베이스와 텔레그래프, 다양한 에이전트를 통해서 메트릭을 수집하고 측정하는 것이 이러한 것에 속한다.

만약 이러한 도구를 사용해왔다면 이미 어떤 형태로든 관측 가능성을 구현해온 것이다.

관측 가능성에서는 APM 대신에 추적이라고 부르며, 계측과 텔레메트리라는 용어를 범용적으로 사용한다.

익스포터, 컬렉터 등 어려운 용어로 인해서 관측 가능성을 새로운 개념으로 이해하곤 한다.

예를 들어 스플렁크는 로그, 뉴렐릭은 성능 관리, 프로메테우스는 메트릭에 전문성을 가지고 있다.

- 관측 가능성은 **화이트박스 모니터링**을 포함하며, **블랙박스 모니터링**과 다르다. 블랙박스 모니터링이 제공하는 정보는 상세하지 못하므로 상세한 디버깅 정보로 활용하기 어렵다. 이는 관측 가능성의 목적에 부합하지 않는다.
- 관측 가능성은 애플리케이션 내부의 상태를 디버깅할 수 있는 정보를 제공하므로 장애가 발생했을 경우 신속하고 수월하게 대응할 수 있다.
- 관측 가능성에서는 제공된 결과를 보고 이해하는 수준에 그치지 않고, 원하는 계측을 추가할 수 있다. 그걸 통해 보다 자세하게 이해할 수 있을 뿐 아니라 향후 발생할 가능성이 높은 장애에 대한 예측이 가능하다.

모니터링은 전체적인 시스템 상태를 이해하는 데 적합하다.

모든 것을 수집하고 모니터링하기보다 가능한 샘플링을 사용햐 적은 데이터를 사용하더라도 의미 있고 예측 가능한 결과를 도출해 내는 것이 좋은 모니터링 방법이다.

블랙박스 모니터링은 애플리케이션과 시스템 메트릭에 집중한다. 반면 관측 가능성은 클라우드 네이티브처럼 분산되고 복잡한 시스템에서 발생하는 이벤트에 대한 통찰력 그리고 태그, 로그 등을 결합해서 서비스에 대한 콘텍스트 정보를 제공하는 것이 목표다.

근래 많은 벤더와 고객들이 언급하는 관측 가능성의 세 가지 요소는 메트릭, 로그, 추적이다.

관측 가능성은 주로 인프라와 애플리케이션의 데이터를 수집한다.

이 책에서는 인프라와 네트워크 레벨의 문제 원인을 이해하고, 이를 해결하는 방법과 절차를 **가시성**이라고 지칭한다.

이번 책에서는 그라파나, 후속작에서는 오픈서치와 다양한 오픈소스를 사용해 유연하고 확장성 있는 관측 가능성을 구축하는 방법을 설명한다.

### 1.1.2 관측 가능성 구성 요소

#### 메트릭

일정 시간 동안 측정된 데이터를 집계하고 이를 수치화한다. 예를 들어 큐의 대기, 메시지 개수, 사용 중인 CPU와 메모리의 크기, 서비스에서 초당 처리하는 개수 등이 있다.

메트릭은 전체적인 시스템의 상태를 보고하는 데 특히 유용하며, 일반적으로 히스토그램 또는 게이지 등 차트를 사용해 시각적으로 표현한다.

#### 로그

로그는 애플리케이션 실행 시 생성되는 텍스트라인으로 구조적인 JSON 형태나 비구조적인 텍스트 형식으로 출력된다.

#### 추적

**추적(tracing)**은 마이크로서비스가 시스템을 경유하며 트랜잭션을 처리하는 과정에서 발생하는 세부적인 정보를 보여준다.

분산 마이크로서비스 간 복잡한 상호작용이 발생하는 클라우드 네이티브 운영 환경에서 생기는 문제점은 그 현상을 이해하고 해결하는 데 과거의 툴과 로그, 메트릭만으로는 한계가 있다.

## 1.2 메트릭

### 1.2.1 가용성

가용성 신호는 시스템의 전반적인 상태와 정상 작동 여부를 거시적 관점에서 측정하며, SLI(Service Level Indicater)로 정량화 한다.

SLI는 SLO(Service Level Objective)라고 불리는 임계 기준을 달성해야 하며, SLO는 SLI의 상한과 하한 범위를 지정한다.

SLO를 사업적으로 합의한 수준 또는 SLA(Service Level Agreement)에 명시된 제공 수준보다 제한적이거나 보수적인 추정치다.

SLA를 위반할 위험이 생겼을 때 사전 경고를 제공하고, 실제로 SLA를 위반하는 상태에 이루지 않도록 방지하는 것이 핵심이다.

메트릭은 가용성을 측정하는 주요 관찰 수단이며 SLI를 측정하는 지표다.

### 1.2.2 구글의 골든 시그널

주요 SLO 지표는 가용성 외에도 지연과 에러가 있다.

이는 구글 SRE에서 제시하는 지표와 중복되므로 함꼐 알아보돌록 한다.

구글 SRE 팀에서는 메트릭을 수집할 때 네 가지 골든 시그널에 집중해야 한다고 강조한다.

#### 지연

빈번하게 발생하는 지연은 에러가 아닌 경우가 많다.

지연과 에러를 구분해야 한다.

지연을 확인할 수 있는 차트는 다양하다.

시계열, 히트맵, 히스토그램 차트는 지연을 시각화할 수 있다.

그라파나에서 제공하는 히스토그램을 사용하여 지연시간의 분포를 시각화할 수 있고 다양한 유형의 Prom(Prometheus)QL로 지연을 계산할 수 있다.

지연은 잠재적인 장애를 예측할 수 있는 유용한 신호로, 서비스 요청 후 완료까지 걸리는 시간을 측정한다.

이 신호에서 많은 것을 판단할 수 있다.

지연이 증가하면 서비스 품질이 저하되는 것을 예측할 수 있다.

하지만 이 신호를 에러와 연관 짓는 것은 주의를 기울여야 한다.

예를 들어, 요청 처리 중에 애플리케이션이 신속하게 응답했지만, 에러가 발생했을 경우 지연은 짧지만 기대한 결과가 아니다.

에러는 지연 없이 빠르게 처리되는 경향이 있고, 정상 응답은 지연을 포함하는 경우가 많다.

따라서 1초의 지연을 포함하는 정상 응답과 60초의 지연을 포함하는 정상 응답을 동일하다고 볼 수 없다.

따라서 60초 지연은 에러로 판단하거나 타임아웃으로 에러 처리를 하는 것이 현명하다.

이는 SLI를 명확하게 정의해야 하는 이유이기도 하다.

#### 에러

에러의 기준을 명확히 설정한다.

USE(Utilization Saturation and Erros) 대시보드 외에도 이상치와 에러를 포함한 별도의 **대시보드**를 생성해야 한다.

- 각 에러는 추적 ID와 연결되어 있다. 추적 화면을 통해 보다 상세한 근본 원인을 분석할 수 있다.
- 다양한 유형의 에러를 포함한다. 이상 탐지, 인프라, 애플리케이션에서 발생하는 다양한 유형의 에러가 서로 구분되어 출력된다.
- 에러는 세 가지 상태를 가지고 있다. 초기에는 정상이지만, 에러가 처음 발견되면 대기 상태로 변한다. 에러가 계속 활성 상태를 유지할 경우에는 파이어링 상태로 변하고, 알람을 전송한다. 에러 대시보드는 에러 상태의 변화를 **시계열**로 출력한다.

에러는 문제점과 에러 내용을 직접적으로 출력한다는 점에서 명시적이다.

하지만 애플리케이션 개발에는 수십 개 유형의 에러가 발생할 수 있다. (이를 그룹화)하는 과정은 중의적이며, 개인의 경험에 따라서 다르게 판단할 수 있다.

즉 개발자와 운영자의 주관이 개입될 수 있는 여지가 크다.

예를 들어 HTTP 500과 잘못된 응답이 있는 200이 있다고 가정해보자. 후자는 모니터링하기가 쉽지 않은데, HTTP 코드에만 전적으로 의지할 수 없기 때문이다.

즉 응답 코드만으로 정상과 에러를 구분하기 쉽지 않다.

```PromQL
sum(rate(hotrod_frontend_http_requests_total{{status_code="4xx"}[{{.window}}]}))
/
total_query: sum(rate(hotrod_fronted_http_requests_total[{{.window}}]))
```

SLO 지표는 멀티 윈도와 멀티 레이트를 지원해야 하므로 복잡하다.

#### 트래픽

트래픽은 발생하는 요청의 양을 뜻한다. 그것은 관찰되는 시스템의 유형, 초당 요청의 수, 네트워크 입출력 등에 따라 다양하다.

네트워크 트래픽을 계산하는 프로메테우스 PromQL은 다음과 같다.

```PromQL
irate(node_network_receive_packets_total{instance="$node", job="$job})[$__rate_interval]
```

트래픽이 급격하게 많아지거나 임계치를 초과하거나 포화 상태가 되면 지연과 에러가 발생하며, 최종적으로 장애에 이른다.

트래픽은 다른 신호와 연관성이 많은데, 지연과 에러가 발생하더라도 중단 없이 적정 수준의 트래픽을 처리할 수 있는 시스템을 구축하는 것이 클라우드 네이티브의 사상이다.

골든 시그널의 원칙은 트래픽의 증가에 따른 지연과 에러를 최소화하고 최종적으로 장애에 이르지 않도록 설계하는 것이다.

장애가 발생하더라도 사용자 서비스를 제공하기 위한 최소한의 트래픽은 처리해주는 것을 권고하고 있다.

#### 포화

**포화**는 리소스가 현재 얼마나 채워졌는지와 얼마나 가득 채울 수 있는지를 나타내는 것이다.

전체 총대역폭과 처리 가능한 트래픽에 대비해서 현재 트래픽 혹은 대ㅔ역폭이 어느 정도인지 이해할 수 있는 지표인 셈이다.

포화를 통해 향후 트래픽이 증가했을 경우에 이용 가능한 자원 총사용률을 예측할 수 있다.

포화 상태가 되지 않도록 시스템을 설계하는 것이 중요한데, 동적인 트래픽에 맞추어 스케일하는 방법을 제공하는 것이 적합ㅎ다.

애플리케이션 레벨에서 오토스케일링, 데이터베이스의 샤딩 등이 좋은 예다.

신호를 명확히 구분하고 개선하기 위해서는 개발자, 운영자 등 관련 구성원이 함께 협업하고 개선하려고 노력해야 한다.

SLO 대시보드의 개발 시 참고할 사항은 다음과 같다.

- SRE 대시보드에 SLO를 출력한다. 필수적인 SLO는 에러율, 지연시간, 가용성 등이 있다.
- SLO 대시보드에는 오류 예싼과 번 레이트를 다양한 윈도에 따라서 알람과 연계하여 출력해야 한다.
- 프로메테우스 레코딩 규칙과 알람 규칙으로 구현할 수 있으며, 이러한 규칙은 자동 생성 방식을 선호한다.
- 쿠버네티스 API 서버와 코어 DNS, AWS 클라우드 워치, 데이터독 등 다양한 데이터로부터 데이터를 수집할 수 있다.

신호를 이해하고 기본적인 대시보드와 알람을 개발하는 방법에 대해서 이해하는 것이 우선이므로 이 책에서는 SLO의 요구 사항보다는 신호에 더 집중했다.

SLO에 대한 내용은 후속작에서 다룰 예정이다.

관측 가능성과 가시성 등은 네트워크와 많은 관련이 있다.

하지만 네트워크에서 발생하는 데이터는 너무나 방대해서 운영자는 그것이 정상인지 잡음인지 구분하지 못하는 경우가 대부분이다.

또한, 최종 사용자가 문제점을 보고하거나 장애에 이르기 전까지 문제점과 장애 발생 가능성을 인식하지 못하는 경우가 발생한다.

### 1.2.3 메트릭 유형

#### 카운터

카운터는 모니터링하는 이벤트의 누적 개수 혹은 크기를 표현한다.

일반적으로 rate 함수와 함께 이벤트를 추적하는 데 많이 사용한다.

#### 게이지

게이지는 카운터와 달리 증가하거나 감소하는 임의의 값을 나타내는 메트릭이고, 현재 상태를 표현하는 메트릭 타입이다. 게이지를 사용하는 메트릭의 예는 다음과 같다.

- 데이터베이스에 연결된 커넥션 개수
- 현재 동작하는 스레드 개수
- 사용률

#### 요약

요약은 응답의 크기와 대기시간을 추적하는 데에도 사용하며, 측정한 이벤트의 합계와 카운트를 모두 제공한다. 집계가 필요하거나 범위와 분포에 대해서 측정하는 경우에는 히스토그램을 권장한다.

범위와 분포에 관계없이 정확한 백분위수가 필요하다면 요약이 적합하다.

#### 히스토그램

히스토그램은 시간 경과에 따른 추세와 데이터가 단일 범주에서 어떻게 분포되어 있는지를 나타낸다.

분포를 이해하는 방법에는 분위수 외에도 표준편차와 그래프가 있다.

히스토그램은 분위수를 주로 사용한다.

분위 수는 오름차순 혹은 내림차순으로 정렬되어있는 전체 자료를 특정 개수로 나눌 때 그 기준이 되는 수다.

예를 들어 이분위수는 자료 전체를 2등분하는 수, 사분위수는 자료 전체를 4등분하는 수라는 의미다.

### 1.2.4 시계열 데이터

관측 가능성에서는 시계열 데이터를 다루는데, 이를 차트로 표현하고 시각화해야 한다.

정해진 시간 내의 분포와 변화를 출력하기 위해서는 적합한 차트 형식은 히스토그램이다.

그라파나 히스토그램은 각 범위 내에 있는 데이터 포인트의 수를 표시하여 숫자 데이터를 시각적으로 출력한다.

Loki는 히스토그램과 유사한 차트를 사용하며, 이를 통해 특정 시간 동안의 분포를 이해할 수 있을 뿐 아니라 추적의 간트 화면으로 전환할 수 있다.

프로메테우스 이그젬플러는 추적에 대한 근사치를 시계열로 표현한다.

메트릭-로그의 상관관계를 표현할 수 있다.

상관관계는 시스템의 복잡성을 낮추고 이해도를 높여준다. 상관관계를 효과적으로 활용하면 운영자와 갭라자는 복잡한 문제를 신속하게 해결할 수 있으며, 통계적으로 계산하고 상관계수를 구할 수도 있다.

## 1.3 추적

### 1.3.1 추적 구성 요소

### 1.3.2 추적 데모

## 1.4 로그

### 1.4.1 로그 관리

### 1.4.2 로그 표준화

## 1.5 상관관계

### 1.5.1 상관관계의 필요성

### 1.5.2 상관관계 구현 방안

## 1.6 관측 가능성 데모

### 1.6.1 데모의 방향성

### 1.6.2 관측 가능성 데모 목록

## 1.7 관측 가능성 목표

### 1.7.1 레퍼런스 아키텍처

### 1.7.2 핵심 목표

## 1.8 관측 가능성 오픈소스

## 1.9 관측 가능성 방향성
