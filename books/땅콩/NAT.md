# 배경: 사설망과 공인망

IPv4는 2³²의 경우의 수를 제공하며, 이는 약 42억 개의 IP 주소를 의미합니다. 하지만 전 세계적으로 기기와 사용자가 증가하면서 공인 IP 주소는 할당 가능 수를 초과했습니다. 이는 **공인망**에서의 문제를 나타내며, **사설망**은 이를 보완하기 위한 대안으로 사용됩니다.

**사설망(Private Network)**은 공인망과는 다른 IP 주소 체계를 내부적으로 사용할 수 있습니다. 이는 **RFC 1918**과 **RFC 4193** 표준에 따라 규정되며, 내부적으로 네트워크를 관리하고 데이터를 통신합니다.

내부망에서 외부망으로 데이터를 보내려면 사용 중인 **사설 IP 주소(Private IP)**를 **공인 IP 주소(Public IP)**로 변환해야 하며, 이때 **NAT(Network Address Translation)** 기술이 필요합니다.

---

# NAT(Network Address Translation)

**NAT**는 **IP 패킷의 TCP/UDP 포트 번호**와 **소스 및 목적지 IP 주소**를 변환하여 네트워크 트래픽을 라우터를 통해 관리하는 기술입니다. NAT는 내부망과 외부망 간의 통신을 가능하게 하고, 네트워크 보안을 강화하며 공인 IP 주소의 부족 문제를 해결합니다. 또한, NAT는 **게이트웨이(Gateway)** 역할을 하기도 합니다.

## NAT의 상세 동작

- IP 주소뿐만 아니라 **TCP/UDP 포트 번호**도 변환할 수 있습니다.
- 이 기능을 **PAT(Port Address Translation)** 또는 **NAPT(Network Address and Port Translation)**라고 부릅니다.

### NAT를 통한 웹 요청 흐름 예시

1. 사용자가 `www.naver.com`에 접속하려고 요청을 보냅니다.
2. NAT는 다음과 같은 IP 주소와 포트를 변환하여 트래픽을 관리합니다:

   | 출발지 IP   | 출발지 Port | 목적지 IP       | 목적지 Port |
   | ----------- | ----------- | --------------- | ----------- |
   | 10.10.10.10 | 9999        | 125.209.222.142 | 80          |
   | 52.15.77.39 | 9999        | 125.209.222.142 | 80          |
   | 52.15.77.39 | 80          | 10.10.10.10     | 9999        |

3. NAT 동작 과정:

   - 클라이언트의 사설 IP와 포트를 공인 IP와 포트로 변환하여 요청을 웹서버로 보냅니다.
   - 웹서버가 요청을 처리하고 응답을 반환합니다.
   - NAT 장비는 응답 패킷의 목적지 IP와 포트를 클라이언트의 사설 IP와 포트로 변환하여 전달합니다.

4. NAT는 이러한 변환을 기억하는 상태(**Stateful**)로 동작하며, 요청과 응답의 관계를 추적합니다.

---

# NAT의 종류

1. **Static NAT(1:1 매핑)**: 하나의 사설 IP를 하나의 공인 IP에 정적으로 매핑.
2. **Dynamic NAT(1:N 매핑)**: 여러 사설 IP를 공인 IP 풀(pool)에서 동적으로 매핑.
3. **NAPT(PAT 포함)**: IP 주소뿐만 아니라 포트 번호까지 변환하여 N명의 사용자를 하나의 공인 IP로 처리.

---

# NAT의 세부 동작: SNAT과 DNAT

- **SNAT(Source NAT)**: 출발지 IP를 변환.
- **DNAT(Destination NAT)**: 목적지 IP를 변환.

---

# 세션 테이블과 Stateful 동작

NAT를 수행하는 장비는 네트워크 트래픽을 추적하고 관리하기 위해 **세션 테이블(Session Table)**을 사용합니다. 이 테이블은 트래픽의 소스/목적지 IP와 포트를 기록하며, 규칙에 따라 NAT를 수행합니다.

- **Stateful**: NAT 장비는 세션 상태를 추적하여, 이전 요청에 대한 응답 패킷을 적절히 변환하고 전달합니다.
- **세션 장비(Session Device)**: 방화벽과 같은 장비는 정해진 규칙에 따라 NAT를 수행하며, 세션 테이블에 기록된 정보를 활용합니다.

---

# VPN의 작동 원리와 NAT

**VPN(Virtual Private Network)**는 가상의 사설 네트워크로, 원격지에서도 사설망에 접속할 수 있도록 도와줍니다. VPN은 **Private Network**의 관점에서 NAT를 활용하며, 다음과 같은 특징을 가집니다:

1. **Virtual(가상화)**: 물리적 네트워크 대신 가상 터널을 통해 데이터가 전송됩니다.
2. **보안성**: NAT와 암호화를 사용하여 데이터 보안을 강화합니다.
3. **트래픽 관리**: NAT를 통해 사설망과 공인망 간의 데이터 교환을 수행합니다.

VPN과 NAT의 조합은 사설망을 효율적으로 관리하며, 보안을 강화하고 공인 IP 주소 부족 문제를 해결합니다.

# NAT의 장점과 한계

### 장점

- **공인 IP 절약**: 다수의 사설 IP를 하나의 공인 IP로 매핑해, 공인 IP 자원의 낭비를 방지합니다.
- **보안 강화**: 내부 네트워크의 IP 주소가 외부에 노출되지 않아, 네트워크 보안성이 향상됩니다.
- **유연한 네트워크 설계**: NAT를 통해 동일한 사설 IP 대역을 여러 네트워크에서 사용할 수 있어, 네트워크 설계가 유연해집니다.

### 한계

- **추적 어려움**: 외부에서 내부 사설 IP를 추적하기 어렵기 때문에, 특정 기기의 문제를 찾기 어려울 수 있습니다.
- **성능 저하**: NAT는 트래픽을 변환하면서 추가적인 처리 과정을 요구하므로, 네트워크 장비의 성능이 저하될 수 있습니다.
- **End-to-End 연결 제한**: P2P(Peer-to-Peer) 서비스나 VoIP(Voice over IP) 같은 애플리케이션에서 직접적인 연결을 어렵게 할 수 있습니다. 이를 해결하기 위해 **UPnP(Universal Plug and Play)**나 **포트 포워딩(Port Forwarding)**을 사용해야 합니다.

---

# NAT Traversal

**NAT Traversal** 은 NAT 뒤에 있는 기기와 외부 네트워크 간의 직접 통신을 가능하게 하는 기술입니다.

이는 주로 P2P 애플리케이션, VoIP, 온라인 게임에서 활용됩니다.

특히 네이버 부스트캠프에서는 WebRTC를 이용한 서비스가 많아 이러한 내용이 익숙하신 분들이 많을 것 같습니다.

### 주요 기법

- **STUN(Session Traversal Utilities for NAT)**: 클라이언트가 공인 IP와 포트를 알 수 있게 도와주는 프로토콜.
- **TURN(Traversal Using Relays around NAT)**: NAT를 우회하기 위해 중계 서버를 사용하는 기법.
- **ICE(Interactive Connectivity Establishment)**: STUN과 TURN을 조합하여 최적의 연결 경로를 찾는 기법.

---

# NAT와 IPv6

IPv6는 128비트 주소 체계를 제공하여 사실상 무한대에 가까운 IP 주소를 제공합니다. 따라서 IPv4에서 NAT가 필요했던 이유 중 하나인 **공인 IP 부족 문제**를 해결합니다.

### IPv6에서의 NAT 필요성

- **주소 부족 해결**: IPv6는 공인 IP를 기기별로 할당할 수 있으므로 NAT가 필수적이지 않습니다.
- **End-to-End 연결성**: IPv6는 NAT 없이도 End-to-End 연결성을 보장합니다.
- **보안 문제**: NAT의 보안 기능을 대신할 IPv6 보안 프로토콜(IPsec)이 제공됩니다.

하지만 IPv6로의 완전한 전환이 이루어지지 않은 상황에서는 여전히 NAT와 IPv6가 함께 사용되는 경우가 있습니다.

# NAT와 방화벽(Firewall)

NAT는 기본적으로 트래픽을 관리하며 보안성을 향상시킬 수 있습니다. 하지만 NAT만으로는 완전한 보안이 보장되지 않으므로, 방화벽과 함께 사용되는 경우가 많습니다.

- **NAT**: 주로 IP와 포트를 변환하여 트래픽을 라우팅합니다.
- **방화벽**: 트래픽의 허용 여부를 결정하고, 규칙 기반으로 보안을 강화합니다.

## NAT의 대안: 프록시(Proxy)

**프록시 서버**는 NAT와 유사한 역할을 하지만, 애플리케이션 계층에서 동작합니다.

### 주요 차이점

- NAT: 네트워크 계층(IP)에서 동작.
- 프록시: 애플리케이션 계층(HTTP, FTP 등)에서 동작.

### 사용 예

- **캐싱**: 자주 요청되는 데이터를 저장하여 성능을 향상.
- **콘텐츠 필터링**: 특정 웹사이트 접근 제한.

---

## NAT와 DNS

NAT는 IP 변환을 담당하고, **DNS(Domain Name System)**는 도메인 이름을 IP 주소로 변환합니다. 이 둘은 네트워크 통신에서 협력하여 동작합니다.

### 동작 예시

1. 사용자가 `www.example.com`에 접속을 요청합니다.
2. DNS 서버가 해당 도메인의 공인 IP 주소를 반환합니다.
3. NAT 장비는 내부 IP 주소를 공인 IP로 변환하여 요청을 외부로 보냅니다.

### DNS와 NAT 간 문제

- **DNS 리졸루션 문제**: 내부 기기가 NAT를 통해 외부와 통신할 때, 잘못된 IP가 반환될 수 있습니다.
- **Split DNS**: 내부 네트워크와 외부 네트워크에서 다른 DNS 결과를 제공하여 이를 해결합니다.
