# 1. 소켓을 작성한다

## 1.1 프로토콜 스택의 내부 구성

- OS에 내장된 네트워크 제어 소프트웨어인 프로토콜 스택과 네트워크용 하드웨어(LAN 어댑터)를 알아본다.
- TCP/IP 소프트웨어는 계층 구조로 되어 있으며, 상위 계층이 하위 계층에 작업을 의뢰하는 방식이다.

**구성 요소:**

- 네트워크 애플리케이션: 웹 브라우저, 메일 클라이언트, 웹 서버, 메일 서버 등
- Socket 라이브러리: 리졸버 내장
- 프로토콜 스택: TCP, UDP, IP
- LAN 드라이버
- LAN 어댑터

**프로토콜 스택 역할:**

- TCP는 데이터를 안정적으로 송수신하고, UDP는 짧은 제어용 데이터를 송수신한다.
- IP는 패킷을 운반하며, 패킷 운반 중 오류는 **ICMP**가 처리하고, MAC 주소는 **ARP**로 확인한다.

## 1.2 소켓의 실체는 통신 제어용 정보

- 프로토콜 스택은 제어 정보를 기록하는 메모리 영역을 가지고 있으며, 여기서 소켓이 제어된다.
- 소켓의 실체는 제어 정보이며, IP 주소, 포트 번호 등의 통신 상태 정보를 포함한다.

## 1.3 Socket을 호출했을 때의 동작

- 소켓 호출 시 메모리 영역이 확보되고, 디스크립터가 애플리케이션에 반환된다.
- 디스크립터는 이후 통신 시 소켓을 식별하는 데 사용된다.

# 2. 서버에 접속한다

## 2.1 접속의 의미

- 소켓 생성 후, **connect**를 호출하여 클라이언트의 IP 주소, 포트 번호를 서버에 전달한다.
- 서버 측에서도 클라이언트와 마찬가지로 IP 주소와 포트 번호를 설정하여 통신 준비를 한다.
- 데이터 송수신을 위한 버퍼 메모리를 확보하며, 접속 동작을 통해 통신이 가능해진다.

## 2.2 헤더를 통한 제어 정보 기록

- 통신 시 제어 정보는 TCP, IP, 이더넷 등의 헤더에 기록되어 송수신된다.
- 제어 정보는 소켓에 기록되어 통신 상태를 관리하지만, 상대측은 헤더로만 제어 정보를 받는다.

## 2.3 접속 동작의 실제

- **connect** 호출 시, TCP 담당 부분에서 송수신처의 포트 번호를 포함한 **SYN 비트**가 설정된 헤더가 생성된다.
- 패킷이 서버에 도착하면 서버 측에서도 **SYN** 및 **ACK** 비트를 사용해 클라이언트에 응답을 보낸다.
- 클라이언트는 응답을 받고 서버와의 연결이 완료되었음을 확인한다.

# 3. 데이터를 송수신한다

## 3.1 프로토콜 스택에 HTTP 리퀘스트 메시지를 넘긴다

- **write**를 호출하여 HTTP 리퀘스트 메시지를 프로토콜 스택에 전달하면, 데이터는 송신 버퍼에 저장된다.
- 데이터를 일정 크기 이상 버퍼에 저장하거나, 시간이 경과하면 송신 동작이 이루어진다.

## 3.2 데이터가 클 때는 분할하여 보낸다

- 데이터가 한 패킷에 들어가지 않는 경우 **MSS**(최대 세그먼트 크기)에 맞춰 데이터를 분할해 전송한다.
- TCP 헤더를 추가하여 송신하고, IP 담당 부분을 통해 송신 동작을 실행한다.

## 3.3 ACK 번호로 패킷 도착 확인

- TCP는 **시퀀스 번호**와 **ACK 번호**를 통해 패킷이 올바르게 도착했는지 확인한다.
- 수신한 데이터가 누락되지 않았다면, 수신 측에서 ACK 번호를 송신 측에 돌려보낸다.

## 3.4 패킷 왕복 시간에 따른 ACK 대기 시간 조정

- ACK 번호가 돌아올 때까지 기다리는 시간을 **타임아웃 값**으로 설정하며, 네트워크 상태에 따라 조정한다.
- 혼잡한 네트워크에서는 대기 시간이 길어질 수 있으며, 이 시간을 적절히 설정해야 효율을 높일 수 있다.

## 3.5 윈도우 제어 방식을 이용한 ACK 번호 관리

- TCP는 **윈도우 제어** 방식으로, ACK 번호를 기다리지 않고 복수의 패킷을 송신할 수 있다.
- 수신 가능한 데이터 양을 미리 통지하여 송신 측이 이를 초과하지 않도록 제어한다.

## 3.6 ACK 번호와 윈도우 통지를 함께 보낸다

- 수신 측은 ACK 번호와 윈도우 통지를 가능한 한 합쳐서 한 번에 송신한다.
- 여러 ACK 번호가 발생한 경우, 최종 ACK 번호만 보내고 중간 값은 생략한다.

## 3.7 HTTP 응답 메시지를 수신한다

- 응답 메시지가 돌아오면, 수신 버퍼에 저장된 데이터를 애플리케이션에 전달한다.
- 데이터가 도착하지 않으면 잠시 대기하며, 응답이 도착하면 즉시 처리한다.

# 4. 서버에서 연결을 끊어 소켓을 말소한다

## 4.1 데이터 송신 완료 후 연결을 끊는다

- 데이터 송수신이 완료되면 **close**를 호출하여 연결을 끊는다.
- 서버 측에서 먼저 close를 호출하고, 클라이언트는 이를 수신한 후 응답을 보내며 연결이 종료된다.

## 4.2 소켓을 말소한다

- 클라이언트와 서버의 데이터 송수신이 모두 완료되면, 소켓이 말소된다.

# 5. IP와 이더넷의 패킷 송수신 동작

- IP 담당 부분은 패킷을 생성하고, 이더넷을 통해 신호를 송수신한다.
- IP 주소는 데이터를 목적지로 운반하는 데 사용되며, MAC 주소는 이더넷 레벨에서 사용된다.

# 6. UDP 프로토콜을 이용한 송수신 동작

- UDP는 TCP와 달리 연결을 유지하지 않고 데이터를 전송하며, 패킷의 순서나 도착 여부를 보장하지 않는다.
- 주로 빠른 전송이 필요한 경우, 짧은 제어용 데이터 전송에 사용된다.
