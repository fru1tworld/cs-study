# 일관성 해시(Consistent Hashing)

## 1. 개념

일관성 해시(Consistent Hashing)는 분산 시스템에서 데이터의 균등한 분배와 부하 분산을 위해 사용되는 해싱 기법이다. 기존의 모듈러 해싱(Modular Hashing) 방식은 노드 추가/제거 시 해시 값을 재계산해야 하는 단점이 있지만, 일관성 해시는 이러한 문제를 해결하여 **확장성(Scalability)과 안정성(Fault Tolerance)**을 보장한다.

## 2. 기존 해싱 방식의 문제점

기본적인 해싱 기법은 아래와 같이 작동한다.
`hash(key) mod N`

- 여기서 `N`은 서버(노드)의 개수이다.
- 새로운 노드가 추가되거나 기존 노드가 제거되면 해시 함수의 결과가 크게 달라져 많은 데이터가 다른 노드로 이동해야 한다.
- 데이터 이동이 많아질수록 **캐시 미스(Cache Miss)**가 발생하고, 성능 저하 문제가 생긴다.

## 3. 일관성 해시(Consistent Hashing)의 원리

일관성 해시는 원형(Ring) 구조를 사용하여 데이터 재배치를 최소화한다.

### (1) 해시 공간을 원형으로 표현

- 해시 함수의 결과를 `0 ~ 2^32 - 1` 범위의 값으로 설정하고, 이를 원형 링(Ring)으로 나타낸다.
- 각 노드(Server)는 특정 위치에 매핑된다.

### (2) 키를 해싱하여 해당하는 노드에 할당

- 데이터의 키(Key)도 같은 해시 함수를 사용해 원형에 매핑된다.
- 특정 키의 데이터는 **시계 방향으로 가장 가까운 노드에 저장**된다.

### (3) 노드 추가 및 제거 시 영향 최소화

- 노드를 추가하면 해당 노드의 일부 키만 이동하며, 다른 노드는 영향을 받지 않는다.
- 노드를 제거할 때도 해당 노드의 키만 이웃 노드로 이동하므로 데이터 이동이 최소화된다.

## 4. 가상 노드(Virtual Nodes)

- 해시 충돌 문제를 방지하고 **부하 분산(Load Balancing)을 최적화**하기 위해 **가상 노드(Virtual Nodes, VNodes)** 개념이 사용된다.
- 하나의 물리 노드를 여러 개의 가상 노드에 매핑하여 균등하게 데이터를 분배한다.
- 특정 노드가 과부하 상태가 되는 문제를 완화할 수 있다.

## 5. 장점과 단점

### ✅ 장점

- **노드 추가/제거 시 데이터 이동 최소화** → 확장성이 뛰어남.
- **고가용성(High Availability)** → 특정 노드가 다운되더라도 영향을 최소화.
- **부하 분산(Load Balancing) 가능** → 가상 노드를 활용하여 균등한 데이터 분배 가능.

### ❌ 단점

- **해시 충돌 가능성** → 해시 함수 설계가 중요함.
- **일반 해싱보다 구현이 복잡** → 가상 노드, 링 구조 등을 관리해야 함.

## 6. 일관성 해시의 사용 사례

- **분산 캐시 시스템** (ex: Memcached, Redis Cluster)
- **분산 스토리지 시스템** (ex: Amazon DynamoDB, Cassandra)
- **로드 밸런싱**
- **P2P 네트워크** (ex: BitTorrent, Chord DHT)
