# 6장 키-값 저장소 설계

## 문제 이해 및 설계 범위 확정

CAP 이론

- 일관성: 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.
- 가용성: 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.
- 파티션 감내: 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동자하여야 한다는 것을 뜻한다.

CAP 정리는 두 가지를 충족하려면 반드시 나머지는 희생되어야 한다는 것을 의미한다.

### 실세계의 분산 시스템

분산 시스템은 파티션 문제를 피할 수 없다.

그리고 파티션 문제가 발생하면 우리는 일관성과 가용성 사이에서 하나를 선택해야 한다.

### 일관성 모델

일관성 모델은 키-값 저장소를 설계할 때 고려해야 할 또 하나의 중요한 요소다.

- 강한 일관성(strong consistency):모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다.
- 약한 일관성(weak consistency): 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
- 결과적 일관성(eventual consistency) 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영(즉, 동기화)되는 모델이다.

강한 일관성은 고가용성 시스템에는 적합하지 않아서 결과적 일관성 모델을 택하고 있다.

### 비 일관성 해소 기법: 데이터 버저닝

데이터를 다중화하면 가용성은 높아지지만 사본 간 일관성이 깨질 가능성은 높아진다. 버저닝과 벡터 시계는 그 문제를 해결하기 위한 기술이다.

버저닝은 데이터를 변경할 때마다 새로운 버전을 만드는 것을 의미한다. 따라서 각 버전의 데이터는 변경 불가능하다.

벡터 시계는 충돌을 발견하고 자동으로 해결해 낼 버저닝 시스템에 대한 보편적으로 사용되는 기술이다.

벡터 시계는 선행, 후행 버전을 판별해서 다른 버전과 충돌이 있는지 판별하는데 쓰인다.

### 일시적 장애 처리

느슨한 정족수 접근법은 정족수 요구사항을 강제하는게 아니라 쓰기 연산을 수행할 W개의 건강한 서버와 읽기 연산을 수행할 R개의 건강한 서버를 해시 링에서 고른다.

이때 장애 상태인 서버는 무시한다.

### 영구적 장애 처리

단서 후 임시 위탁 기법은 일시적 장애를 처리하기 위한 것이다. 영구적인 노드의 장애 상태는 어떻게 처리해야할까?
그런 상황을 처리하기 위해 반-엔트로피 프로토콜을 구현하여 사본들을 동기화할 것이다.

반-엔트로피 프로토콜은 사본들을 비교하여 최신 버전으로 갱신하는 과정을 포함한다.

사본 간의 일관성이 망가진 상태를 탐지하고 전송 데이터의 양을 줄이기 위해서는 머클 트리를 사용할 것이다.

## 요약

| 목표/문제                         | 기술                                       |
| --------------------------------- | ------------------------------------------ |
| 대규모 데이터 저장                | 안정 해시를 사용해 서버들에 부하 분산      |
| 읽기 연산에 대한 높은 가용성 보장 | 데이터를 여러 데이터센터에 다중화          |
| 쓰기 연산에 대한 높은 가용성 보장 | 버저닝 및 벡터 시계를 사용한 충돌 해소     |
| 데이터 파티션                     | 안정 해시                                  |
| 점진적 규모 확장성                | 안정 해시                                  |
| 다양성(heteroeneity)              | 안정 해시                                  |
| 조절 가능한 데이터 일관성         | 정족수 합의                                |
| 일시적 장애 처리                  | 느슨한 정족수 프로토콜과 단서 후 임시 위탁 |
| 영구적 장애 처리                  | 머클 트리                                  |
| 데이터 센터 장애 대응             | 여러 데이터 센터에 걸친 데이터 다중화      |
