# 13 스레드 안전성과 락 최적화

## 13.2 스레드 안전성

스레드 안전성이라는 용어가 있다.
스레드 안전성을 브라이언 게츠가 다음과 같이 정의하였다.

여러 스레드가 한 객체에 동시에 접근할 때 어떤 런타임 환경이든 다음 두 조건을 모두 충족하면 객체를 호출하는 행위가 올바른 결과를 얻을 수 있다면 그 객체는 스레드 안전하다

- 특별한 스레드 스케줄링이나 대체 실행 수단을 고려할 필요 없다.
- 추가적인 동기화 수단이나 호출자 측에서 조율이 필요없다.

한편 많은 시나리오에서는 많이 누그러진 정의를 사용한다.
객체를 호출하는 행위를 단일 호출로 제한한다.

### 13.2.1 자바 언어의 스레드 안전성

자바에서 스레드 안전성을 제대로 이해하려면 안전하냐 아니냐라는 이분법적 사고에서 벗어나야 한다.

스레드 안전성은 안전함의 정도에 따라 여러 단계로 분류된다.

- 불변
  - 변하지 않는다는 뜻이다. final 키워드는 불변이므로 안전하다. String의 경우 불변이다. 그 외에도 열거 타입 Long,Double 과 같은 타입은 불변이다. 단 Number의 AtomicInteger와 AtomicLong은 불변이 아니다.
- 절대적 스레드 안전
  - 절대적 스레드 안전은 스레드 안전성 정의를 완벽하게 충족한다. "어떤 런타임 환경에서든 호출자가 추가적인 동기화 조치를 할 필요가 없다"는 조건은 사실 비용이 많이 들거나 비현실적일 수 있다. 그래서 스레드 안전하다고 표시된 클래스 대부분이 절대적 스레드 안전을 의미하지 않는다. 그런데 synchronized가 붙어 있어도 호출자가 추가로 동기화할 필요가 없다는 뜻은 아니다.
- 조건부 스레드 안전
  - 흔히 스레드 안전하다고 말할 때의 안전 수준을 말한다. 안전한 객체는 단일한 작업을 별도 보호 조치 없이 스레드로부터 안전하게 수행한다. 하지만 특정 순서로 연달아 호출하는 경우는 추가로 동기화해야할 수 있다.
- 스레드 호환
  - 호출자가 적절히 조치하면 멀티스레드에서 안전할 수 있다.
- 스레드 적대적
  - Thread 클래스의 suspend와 resume 메서드는 한 스레드 객체를 공유하면서 동시에 suspend와 resume를 호출했을 떄 교착에 빠질 수 있다. 이런 이유로 두 메서드는 폐기대상으로 지정됐다.

### 13.2.2 스레드 안전성 구현

## 13.3 락 최적화

### 13.3.1 스핀 락과 적응형 스핀

### 13.3.2 락 제거

### 13.3.3 락 범위 확장

### 13.3.4 경량 락

### 13.3.5 편향 락

## 13.4 마치며
