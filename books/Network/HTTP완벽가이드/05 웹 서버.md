# 5장 웹 서버

웹 서버는 HTTP 요청을 처리하고 응답을 제공한다.

## 5.1 다채로운 웹 서버

웹 서버는 HTTP 및 그와 관련된 TCP 커넥션 처리를 구현한 것이다.

웹 서버는 자신이 제공하는 리소스를 관리하고 웹 서버를 설정, 통제, 확장하기 위한 관리 기능을 제공한다.

웹 서버는 다양한 형태와 크기로 제공된다:
- 다목적 소프트웨어 웹 서버 (Apache, Nginx 등)
- 임베디드 웹 서버 (프린터, 가전제품 등)
- 간단한 최소 기능 웹 서버

## 5.2 간단한 펄 웹 서버

간단한 HTTP 서버는 몇 줄의 코드로도 작성할 수 있다.

## 5.3 진짜 웹 서버가 하는 일

1. 커넥션을 맺는다 - 클라이언트의 접속을 받아들이거나, 원치 않는 클라이언트라면 닫는다
2. 요청을 받는다 - HTTP 요청 메시지를 네트워크로부터 읽어들인다
3. 요청을 처리한다 - 요청 메시지를 해석하고 행동을 취한다
4. 리소스에 접근한다 - 메시지에서 지정한 리소스에 접근한다
5. 응답을 만든다 - 올바른 헤더를 포함한 HTTP 응답 메시지를 생성한다
6. 응답을 보낸다 - 응답을 클라이언트에게 돌려준다
7. 트랜잭션을 로그로 남긴다 - 로그파일에 트랜잭션 완료에 대한 기록을 남긴다

## 5.4 단계 1: 클라이언트 커넥션 수락

클라이언트가 이미 서버에 대해 열려있는 지속적 커넥션을 갖고 있다면, 클라이언트는 요청을 보내기 위해 그 커넥션을 사용할 수 있다.

그렇지 않으면 클라이언트는 서버에 대한 새 커넥션을 열 필요가 있다.

### 새 커넥션 다루기

클라이언트가 웹 서버에 TCP 커넥션을 요청하면, 웹 서버는 그 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출하여 커넥션 맞은편에 어떤 클라이언트가 있는지 확인한다.

### 클라이언트 호스트명 식별

대부분의 웹 서버는 "역방향 DNS"를 사용해서 클라이언트의 IP 주소를 클라이언트의 호스트명으로 변환하도록 설정되어 있다.

### ident를 통해 클라이언트 사용자 알아내기

ident 프로토콜은 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낸다.

## 5.5 단계 2: 요청 메시지 수신

커넥션에 데이터가 도착하면, 웹 서버는 네트워크 커넥션에서 그 데이터를 읽어들이고 파싱하여 요청 메시지를 구성한다.

요청 메시지를 파싱할 때:
- 요청줄을 파싱하여 요청 메서드, 지정된 리소스의 식별자(URI), 버전 번호를 찾는다
- 메시지 헤더들을 읽는다
- 헤더의 끝을 의미하는 빈 줄로 끝나는 요청 헤더를 읽어들인다
- 요청 본문이 있다면 읽어들인다 (Content-Length로 길이 파악)

### 내부 표현

몇몇 웹 서버는 요청 메시지를 쉽게 다룰 수 있도록 내부의 자료 구조에 저장한다.

### 커넥션 입력/출력 처리 아키텍처

고성능 웹 서버는 수천 개의 커넥션을 동시에 열 수 있도록 지원한다:
- 단일 스레드 웹 서버
- 멀티프로세스와 멀티스레드 웹 서버
- 다중 I/O 서버
- 다중 멀티스레드 웹 서버

## 5.6 단계 3: 요청 처리

웹 서버가 요청을 받으면, 서버는 요청으로부터 메서드, 리소스, 헤더, 본문(없을 수도 있는)을 얻어내어 처리한다.

## 5.7 단계 4: 리소스의 매핑과 접근

웹 서버는 리소스 서버다. HTML 페이지나 JPEG 이미지 같은 미리 만들어진 콘텐츠를 제공한다.

### Docroot

웹 서버는 여러 종류의 리소스 매핑을 지원하지만, 가장 단순한 형태의 리소스 매핑은 요청 URI를 웹 서버의 파일 시스템 안에 있는 파일 이름으로 사용하는 것이다.

일반적으로 웹 서버 파일 시스템의 특별한 폴더를 웹 콘텐츠를 위해 예약해둔다. 이 폴더를 문서 루트(document root) 혹은 docroot라고 부른다.

### 디렉터리 목록

웹 서버는 경로가 파일이 아닌 디렉터리를 가리키는, 디렉터리 URL에 대한 요청을 받을 수 있다.

대부분의 웹 서버는 클라이언트가 디렉터리 URL을 요청했을 때 다음과 같이 몇 가지 다른 행동을 취하도록 설정할 수 있다:
- 에러를 반환한다
- 디렉터리 대신 특별한 색인 파일을 반환한다
- 디렉터리를 탐색해서 그 내용을 담은 HTML 페이지를 반환한다

### 동적 콘텐츠 리소스 매핑

웹 서버는 URI를 동적 리소스에 매핑할 수도 있다. 즉, 요청에 맞게 콘텐츠를 생성하는 프로그램에 URI를 매핑하는 것이다.

### 서버사이드 인클루드(Server-Side Includes, SSI)

많은 웹 서버가 서버사이드 인클루드도 지원한다. 만약 어떤 리소스가 서버사이드 인클루드를 포함하고 있는 것으로 설정되어 있다면, 서버는 그 리소스의 콘텐츠를 클라이언트에게 보내기 전에 처리한다.

### 접근 제어

웹 서버는 각 리소스에 접근 제어를 할당할 수 있다.

## 5.8 단계 5: 응답 만들기

서버가 리소스를 식별하면, 서버는 요청 메서드로 서술되는 동작을 수행한 뒤 응답 메시지를 반환한다.

응답 메시지는 응답 상태 코드, 응답 헤더, 응답 본문(생성되었다면)을 포함한다.

### 응답 엔터티

트랜잭션이 응답 본문을 생성한다면, 그 내용을 응답 메시지와 함께 돌려보낸다.

### MIME 타이핑

웹 서버는 응답 본문의 MIME 타입을 결정해야 하는 책임이 있다:
- mime.types 파일을 이용
- 매직 타이핑(Magic typing) 사용
- 유형 명시(Explicit typing)
- 유형 협상(Type negotiation)

## 5.9 단계 6: 응답 보내기

웹 서버는 여러 클라이언트에 대한 많은 커넥션을 가질 수 있다.

그 중 몇몇은 아무것도 하지 않는 상태이고 몇몇은 서버로 데이터를 보내고 있으며, 또 몇몇은 클라이언트로 돌려줄 응답 데이터를 실어 나르고 있다.

서버는 커넥션 상태를 추적해야 하며 지속적인 커넥션은 특별히 주의해서 다룰 필요가 있다.

## 5.10 단계 7: 로깅

마지막으로, 트랜잭션이 완료되었을 때 웹 서버는 트랜잭션이 어떻게 수행되었는지에 대한 로그를 로그파일에 기록한다.

대부분의 웹 서버는 로깅에 대한 여러 가지 설정 옵션을 제공한다.

