# 6장 프락시

## 6.1 웹 중개자

웹 프락시 서버는 클라이언트의 입장에서 트랜잭션을 수행하는 중개인이다.

HTTP 프락시 서버는 웹 서버이기도 하고 웹 클라이언트이기도 하다.

### 개인 프락시와 공유 프락시

프락시 서버는 하나의 클라이언트가 독점적으로 사용할 수도 있고 여러 클라이언트가 공유할 수도 있다.

- **개인 프락시(private proxy)**: 하나의 클라이언트만을 위한 프락시
- **공유 프락시(public proxy)**: 여러 클라이언트가 함께 사용하는 프락시

### 프락시 대 게이트웨이

엄격하게 말하면 프락시는 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결하고, 게이트웨이는 서로 다른 프로토콜을 사용하는 둘 이상을 연결한다.

게이트웨이는 클라이언트와 서버가 서로 다른 프로토콜로 말하더라도 서로 간의 트랜잭션을 완료할 수 있도록 해주는 프로토콜 변환기처럼 동작한다.

## 6.2 왜 프락시를 사용하는가

프락시 서버는 실용적이고 유용한 여러 일을 한다:

### 어린이 필터

초등학교는 어린이에게 교육 사이트를 제공하면서 동시에 성인 콘텐츠를 차단하는 데 프락시를 사용할 수 있다.

### 문서 접근 제어자

프락시 서버는 많은 웹 서버들과 웹 리소스에 대한 단일한 접근 제어 전략을 구현하고 감사 추적(audit trail)을 하기 위해 사용될 수 있다.

### 보안 방화벽

네트워크 보안 엔지니어는 종종 보안을 강화하기 위해 프락시 서버를 사용한다.

프락시 서버는 조직 안에 들어오거나 나가는 응용 레벨 프로토콜의 흐름을 네트워크의 한 지점에서 통제한다.

### 웹 캐시

프락시 캐시는 인기 있는 문서의 로컬 사본을 관리하고 해당 문서에 대한 요청이 오면 빠르게 제공하여, 느리고 비싼 인터넷 커뮤니케이션을 줄인다.

### 대리 프락시(Surrogate)

몇몇 프락시는 웹 서버인 것처럼 위장한다. 그래서 대리(surrogate) 혹은 리버스 프락시(reverse proxy)로 불리는 이런 프락시들은 진짜 웹 서버 요청을 받지만, 웹 서버와는 달리 요청받은 콘텐츠의 위치를 찾아내기 위해 다른 서버와 커뮤니케이션을 시작한다.

### 콘텐츠 라우터

프락시 서버는 인터넷 트래픽 조건과 콘텐츠의 종류에 따라 요청을 특정 웹 서버로 유도하는 콘텐츠 라우터로 동작할 수 있다.

### 트랜스코더

프락시 서버는 콘텐츠를 클라이언트에게 전달하기 전에 본문 포맷을 수정할 수 있다.

### 익명화 프락시(Anonymizer)

익명화 프락시는 HTTP 메시지에서 신원을 식별할 수 있는 특성들(클라이언트 IP 주소, From 헤더, Referer 헤더, 쿠키, URI 세션 아이디)을 적극적으로 제거함으로써 개인 정보 보호와 익명성 보장에 기여한다.

## 6.3 프락시는 어디에 있는가

### 프락시 서버 배치

프락시는 어떻게 배치하느냐에 따라 활용 방법이 달라진다:

#### 출구(Egress) 프락시

로컬 네트워크의 출구에 박아 넣을 수 있다. 로컬 네트워크와 더 큰 인터넷 사이를 오가는 트래픽을 제어한다.

#### 접근(입구) 프락시

고객으로부터의 모든 요청을 종합적으로 처리하기 위해 ISP 접근 지점에 위치한다.

#### 대리 프락시

네트워크의 가장 끝에 있는 웹 서버들의 바로 앞에 위치하여 웹 서버로 향하는 모든 요청을 처리하고 필요할 때만 웹 서버에게 자원을 요청할 수 있다.

#### 네트워크 교환 프락시

캐시를 이용해 인터넷 교차로의 혼잡을 완화하고 트래픽 흐름을 감시하기 위해 네트워크 사이의 인터넷 피어링 교환 지점들에 놓일 수 있다.

### 프락시 계층

프락시들은 프락시 계층(proxy hierarchy)이라고 불리는 연쇄를 구성할 수 있다.

프락시 계층에서, 메시지는 최종적으로 원 서버에 도착할 때까지 프락시와 프락시를 거쳐 이동한다.

### 어떻게 프락시가 트래픽을 처리하는가

클라이언트 트래픽이 프락시로 가도록 만드는 방법 네 가지:

1. **클라이언트를 수정한다**
2. **네트워크를 수정한다**: 인터셉트 프락시
3. **DNS 이름공간을 수정한다**: 대리 프락시
4. **웹 서버를 수정한다**

## 6.4 클라이언트 프락시 설정

현대의 많은 웹 클라이언트들은, 수동 혹은 자동 프락시 설정을 지원한다.

### 클라이언트 프락시 설정: 수동

많은 브라우저에서 프락시를 명시적으로 설정할 수 있다.

### 클라이언트 프락시 설정: PAC 파일

수동 프락시 설정은 융통성이 없고 확장 가능하지 않다.

### 클라이언트 프락시 설정: WPAD

WPAD(Web Proxy Autodiscovery Protocol)은 여러 발견 메커니즘들의 상승 작용을 이용해, 브라우저에게 알맞은 PAC 파일을 자동으로 찾아주는 알고리즘이다.

## 6.5 프락시 요청의 미묘한 특징들

### 프락시 URI는 서버 URI와 다르다

웹 서버와 웹 프락시 메시지의 문법은 같지만, 한 가지 예외가 있다.

클라이언트가 프락시 대신 서버로 요청을 보낼 때, 요청의 URI가 다르다.

클라이언트가 웹 서버로 요청을 보낼 때:
```
GET /index.html HTTP/1.0
```

클라이언트가 프락시로 요청을 보낼 때:
```
GET http://www.example.com/index.html HTTP/1.0
```

### 가상 호스팅에서 일어나는 같은 문제

"명시적인 프락시"는 요청 메시지가 완전한 URI를 갖도록 요구하지만, 가상으로 호스팅 되는 웹 서버는 부분 URI를 요구한다.

### 인터셉트 프락시는 부분 URI를 받는다

클라이언트가 보통의 방식으로 (완전한 URI가 아닌) 부분 URI를 포함하는 요청을 보내기 때문에, 프락시는 이를 연결하려는 본래 서버를 찾아야 한다.

### 프락시는 프락시 요청과 서버 요청을 모두 다룰 수 있다

다목적 프락시 서버는 요청 메시지의 완전한 URI와 부분 URI를 모두 지원해야 한다.

### 전송 중 URI 변경

프락시 서버는 메시지를 다음 홉으로 보내기 전에, 요청 URI를 다시 쓸 수 있는 잠재적 능력을 갖고 있다.

### URI 클라이언트 자동확장과 호스트명 분석(Hostname Resolution)

브라우저는 프락시의 존재 여부에 따라 요청 URI를 다르게 분석한다.

### 프락시 없는 URI 분석

프락시가 없다면, 사용자가 타이핑한 URI를 이용해서 서버에 연결한다.

### 명시적인 프락시를 사용할 때의 URI 분석

명시적인 프락시를 사용한다면, 브라우저는 사용자가 타이핑한 URI를 완전한 URI로 만들어서 프락시로 보낸다.

## 6.6 메시지 추적

오늘날의 웹 요청은 종종 클라이언트와 서버 사이의 여러 프락시를 거쳐서 이동한다.

###  Via 헤더

Via 헤더 필드는 메시지가 지나는 각 중간 노드(프락시나 게이트웨이)의 정보를 나열한다.

메시지가 또 다른 노드를 지날 때마다, 중간 노드는 Via 목록의 끝에 반드시 추가되어야 한다.

### TRACE 메서드

프락시 서버는 메시지가 전달될 때 메시지를 바꿀 수 있다.

프락시 흐름을 더 쉽게 들여다볼 수 있도록 HTTP/1.1의 TRACE 메서드가 있다.

TRACE 요청은 목적지 서버로 향하는 도중에 어떤 프락시를 지나가든 간에, 그들 프락시가 각각 그 요청에 자신의 Via 헤더를 붙여나간다.

### Max-Forwards

TRACE와 OPTIONS 요청의 프락시 홉 개수를 제한한다.

Max-Forwards 요청 헤더 필드는 TRACE를 포함한 특정 요청이 몇 번 더 다음 홉으로 전달될 수 있는지를 제어한다.

## 6.7 프락시 인증

프락시는 접근 제어 장치로서 제공될 수 있다.

HTTP는 사용자가 유효한 접근 권한 자격을 프락시에 제출하지 않는 한 콘텐츠에 대한 요청을 차단하는 프락시 인증이라는 메커니즘을 정의하고 있다.

## 6.8 프락시 상호운용성

### OPTIONS: 지원하는 기능 알아보기

HTTP OPTIONS 메서드는 서버나 웹 서버의 특정 리소스가 어떤 기능을 지원하는지(어떤 메서드가 가능한지 등) 클라이언트(혹은 프락시)가 알아볼 수 있게 해준다.

### Allow 헤더

Allow 엔터티 헤더 필드는, 요청 URI에 의해 식별되는 자원에 대해 지원되는 메서드들이나 서버가 지원하는 모든 메서드(요청 URI가 *인 경우)를 열거한다.

