# 20. 리다이렉션과 부하 균형

## 20.1 왜 리다이렉트인가 ?

- 신뢰할 수 있는 HTTP 트랜잭션의 수행
- 지연 최소화
- 네트워크 대역폭 절약

## 20.2 리다이렉트할 곳

서버, 프락시, 캐시, 게이트웨이는 클라이언트가 그들에게 HTTP 요청을 보내고 그들이 그것을 처리한다는 관점에서 보면, 클라이언트에게 있어 모두 서버라고 할 수 있다.

웹 서버는 IP별로 요청을 다룬다. 똑같이 복제된 서버들로 요청을 분산한다는 것은 같은 URL에 대해 여러 곳에서 온 요청들을 각각 최적의 웹 서버로 보내겠다는 것을 의미한다.

## 20.3 리다이렉션 프로토콜의 개요

리다이렉션의 목표는 HTTP 메시지를 가용한 웹 서버로 가급적 빨리 보내는 것이다.

- 브라우저 애플리케이션의 사용자는 브라우저가 클라이언트 메시지를 프락시 서버로 보내도록 설정할 수 있다.
- DNS 분석자는 메시지의 주소를 지정할 때 사용될 아이피 주소를 선택한다. 이 아이피 주소는 클라이언트의 지리적 위치에 따라 달라질 수 있다.
- 메시지는 주소가 지정된 여러 개의 패킷으로 나뉘어 네트워크를 통과한다. 스위치와 라우터들은 패킷이 TCP/IP 주소를 검증하고 그에 근거하여 패킷을 어떻게 라우팅할 것인지를 결정한다.
- 웹 서버는 HTTP 리다이렉트를 이용해 요청이 다른 웹 서버로 가도록 할 수 있다.

이 표는 메시지를 서버로 리다이렉트하기 위해 사용되는 리다이렉션 방법들을 요약했다.
| 메커니즘 | 어떻게 동작하나 | 재 라우팅의 근거 | 제약사항 |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| HTTP 리다이렉션 | 우선 HTTP 요청은 콘텐츠를 제공하기에 최적인 웹 서버를 선택해줄 첫 번째 웹 서버로 간다. 그 웹 서버는 클라이언트에게 선택한 서버로의 HTTP 리다이렉트를 보내준다. 클라이언트는 선택된 서버에게 다시 요청을 보낸다. | 라운드 로빈 부하 균형 회전 지연 최소화, 최단 거리 선정 등의 여러 옵션들. | 느릴 수 있다. 모든 트랜잭션이 추가 리다이렉트 단계를 포함하게 된다. 또한 반드시 첫 번째 웹 서버가 요청 부하를 다룰 수 있어야 한다. |
| DNS 리다이렉션 | DNS 서버가 URL의 호스트 명에 대한 응답으로 어떤 IP 주소를 사용할지 결정한다. | 라운드 로빈 부하 형, 회전 ㄱ지연 최소화, 최단거리 선정 등의 여러 옵션 | DNS 서버를 설정할 필요가 있다. |
| 아이피 맥 포워딩 | 스위치나 라우터 같은 네트워크 요소가 패킷의 목적지 주소를 읽는다. 만약 패킷이 리다이렉트되어야 한다면, 스위치는 그 패킷에게 서버나 프락시의 목적지 MAC주소를 준다 | 대역폭을 절약하고 QOS 서비스를 개선한다. 부하 균형 | 서버나 프락시가 클라이언트의 IP 주소를 잃어버릴 수 있다. |
| IP 주소 포워딩 | 레이어 4 스위치는 패킷의 목적지 포트를 평가하고, 리다이렉트 패킷의 아이피 주소를 프락시나 미러링된 서버의 아이피 주소로 바꾼다. | 대역폭을 절약하고 QOS 를 개선한다. 부하 균형 | 서버나 프락시가 클라이언트의 IP 주소를 잃어버릴 수 있다. |

메시지를 프락시 서버로 리다이렉트 하기 위해 사용되는 리다이렉션 방법을 요약한다.

| 메커니즘                    | 어떻게 동작하나                                                                                                                                                                                                       | 재라우팅의 근거                                                                        | 제약사항                                                                                                                                                                              |
| --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 명시적인 브라우저 설정      | 웹 브라우저는 가까운 프락시에게 HTTP 메시지를 보내도록 설정된다. 최종 사용자나 브라우저를 관리하는 서비스가 이 설정을 한다.                                                                                           | 대역폭을 절약하고 QOS를 개선한다. 부하 균형                                            | 브라우저의 설정 능력에 의존한다.                                                                                                                                                      |
| 프락시 자동설정             | 웹브라우저는 설정 서버로부터 PAC 파일을 검색한다. 이 PAC 파일은 브라우저에게 각 URL에 대해 어떤 프락시를 사용해야 하는지 알려준다.                                                                                    | 대역폭을 절약하고 QOS를 개선한다. 부하 균형                                            | 브라우저는 반드시 설정된 서버로 질의를 보내도록 설정되어있어야 한다.                                                                                                                  |
| 웹 프락시 자동발견 프로토콜 | 웹 브라우저는 설정 서버에게 PAC 파일에 대한 URL을 물어본다. PAC만 사용할 때와는 달리 브라우저에 특정 서버가 설정되어야 할 필요가 없다.                                                                                | 설정 서버는 HTTP 요청 헤더에서 얻은 정보에 근거해 PAC 파일의 URL을 결정한다. 부하 균형 | 브라우저는 반드시 설정된                                                                                                                                                              |
| 웹 캐시 조직 프로토콜       | 라우터 패킷의 목적지 주소를 평가하고 프락시나 미러링된 서버의 아이피 주소와 함께 리다이렉트 패킷을 캡슐화한다. 기존의 많은 라우터들과 함께 일한다. 패킷은 캡슐화될 수 있지만, 클라이언트의 아이피 주소는 잃지 않는다. | 대역폭을 절약하고 QOS를 개선한다. 부하 균형                                            | 반드시 WCCP를 지원하는 브라우저를 사용해야 한다. 위상적인 제약이 약간 있다.                                                                                                           |
| 인터넷 캐시 프로토콜        | 프락시 캐시는 형제 캐시의 무리에게 요청받은 콘텐츠에 대해 질의할 수 있다. 또한 캐시 계층을 지원한다.                                                                                                                  | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는 것은 원 서버로부터 얻는 것보다 빠르다.         | 콘텐츠를 요청할 때 오직 URL만을 사용하기 때문에 캐시 적중이 아님에도 적중인 것처럼 동작할 우려가 있다.                                                                                |
| 캐시 배열 라우팅 프로토콜   | 프락시 캐시 해싱 프로토콜, 캐시가 요청을 부모 캐시로 전달할 수 있도록 해준다. ICP와는 달리 캐시의 콘텐츠는 분산되고 캐시들의 무리는 하나의 큰 캐시처럼 동작한다.                                                      | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는 것은 원 서버로부터 얻는 것보다 빠르다.         | CARP는 형제 관계를 지원할 수 없다. 모든 CARP 클라이언트는 반드시 설정에 동의해야 한다. 그렇지 않으면 다른 클라이언트들은 같은 URI를 다른 부모에게 보내게 되어 적중률이 감소할 것이다. |
| 하이퍼텍스트 캐싱 프로토콜  | 참여하는 프락시 캐시는 형제 캐시의 무리에게 요청받은 콘텐츠에 대해 질의할 수 있ㄷ . 미세 조정된 캐시 질의에 HTTP 1.0과 1.1 헤더를 지원한다.                                                                           | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는게 원 서버로부터 얻는 것보다 빠르다.            | -                                                                                                                                                                                     |

## 20.4 일반적인 리다이렉션 방법

### 20.4.1 HTTP 리다이렉션

웹 서버는 다른 곳에 요청을 보내보라고 말해주는 짧은 리다이렉트 메시지를 클라이언트에게 돌려줄 수 있다.

HTTP 200 대신 302를 통해 부하 분산을 한다.

요청의 방향을 변경할 수 있지만 다음과 같은 몇 가지 단점이 있다.

- 어떤 서버로 리다이렉트할지 결정하려면 원 서버는 상당히 많은 처리를 해야한다. 때로는 거의 페이지 자체를 제공할 때 필요한 것과 같은 양의 처리가 필요하다.
- 페이지에 접근할 때마다 두 번의 왕복이 필요하기 때문에, 사용자가 더 오래 기다리게 된다.
- 만약 리다이렉트 서버가 고장 나면, 사이트도 고장난다.

### 20.4.2 DNS 리다이렉션

DNS 리졸버는 클라이언트의 운영체제일 수 있고, 클라이언트의 네트워크에 있는 DNS 서버이거나 혹은 더 원격에 있는 DNS 서버일 수 있다.

DNS는 하나의 도메인에 여러 아이피 주소가 결부되는 것을 허용하며, DNS 분석자는 여러 아이피 주소를 반환하도록 설정되거나 프로그래밍될 수 있다.

그래서 다양한 바업으로 구현될 수 있다.
