# 07 쿠버네티스 볼륨과 스토리지

## 볼륨의 필요성

### 컨테이너의 임시 파일 시스템

- 컨테이너 재시작 시 데이터 손실
- 파드 내 컨테이너 간 파일 공유 필요
- 영구 데이터 저장 필요

### 쿠버네티스 볼륨

- 파드 내 모든 컨테이너가 접근 가능한 디렉토리
- 파드의 라이프사이클과 연결

## 볼륨 타입

### emptyDir

파드가 노드에 할당될 때 생성되는 빈 디렉토리

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: cache
          mountPath: /cache
  volumes:
    - name: cache
      emptyDir: {}
```

**사용 사례:**

- 임시 데이터 저장
- 컨테이너 간 파일 공유
- 캐시 데이터

### hostPath

노드의 파일 시스템을 파드에 마운트

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: host-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: host-volume
          mountPath: /host
  volumes:
    - name: host-volume
      hostPath:
        path: /data
        type: Directory
```

**주의사항:**

- 노드에 종속적
- 보안 위험
- 단일 노드 테스트용으로 주로 사용

## 영구 볼륨 (Persistent Volume, PV)

### 개념

클러스터 레벨의 스토리지 리소스

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-example
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  hostPath:
    path: /mnt/data
```

### 접근 모드 (Access Modes)

- **ReadWriteOnce (RWO)**: 단일 노드에서 읽기/쓰기
- **ReadOnlyMany (ROX)**: 여러 노드에서 읽기 전용
- **ReadWriteMany (RWX)**: 여러 노드에서 읽기/쓰기

### 회수 정책 (Reclaim Policy)

- **Retain**: 수동으로 회수
- **Delete**: PVC 삭제 시 PV도 삭제
- **Recycle**: 데이터 삭제 후 재사용 (deprecated)

## 영구 볼륨 클레임 (Persistent Volume Claim, PVC)

### 개념

사용자의 스토리지 요청

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-example
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard
```

### 파드에서 PVC 사용

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-pvc
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: data
          mountPath: /data
  volumes:
    - name: data
      persistentVolumeClaim:
        claimName: pvc-example
```

## 스토리지 클래스 (StorageClass)

### 동적 프로비저닝

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-storage
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
  fsType: ext4
```

### PVC에서 StorageClass 사용

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dynamic-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-storage
  resources:
    requests:
      storage: 10Gi
```

## 주요 볼륨 타입 비교

### 클라우드 제공자별 볼륨

- **AWS EBS**: `awsElasticBlockStore`
- **GCP Persistent Disk**: `gcePersistentDisk`
- **Azure Disk**: `azureDisk`

### 네트워크 스토리지

- **NFS**: `nfs`
- **CephFS**: `cephfs`
- **GlusterFS**: `glusterfs`

### 예시: NFS 볼륨

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nfs-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: nfs-volume
          mountPath: /data
  volumes:
    - name: nfs-volume
      nfs:
        server: nfs-server.example.com
        path: /exported/path
```

## ConfigMap과 Secret을 볼륨으로 마운트

### ConfigMap 볼륨

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: config-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: config
          mountPath: /etc/config
  volumes:
    - name: config
      configMap:
        name: app-config
```

### Secret 볼륨

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: secret
          mountPath: /etc/secret
          readOnly: true
  volumes:
    - name: secret
      secret:
        secretName: app-secret
```

## StatefulSet과 볼륨

### volumeClaimTemplates

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx
          volumeMounts:
            - name: www
              mountPath: /usr/share/nginx/html
  volumeClaimTemplates:
    - metadata:
        name: www
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
```

## 볼륨 스냅샷

### VolumeSnapshot

```yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: snapshot-1
spec:
  volumeSnapshotClassName: csi-snapclass
  source:
    persistentVolumeClaimName: pvc-example
```

### 스냅샷에서 복원

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-from-snapshot
spec:
  dataSource:
    name: snapshot-1
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

## 모범 사례

### 적절한 볼륨 타입 선택

- **임시 데이터**: emptyDir
- **설정 파일**: ConfigMap/Secret
- **영구 데이터**: PVC + PV
- **상태 유지 애플리케이션**: StatefulSet + volumeClaimTemplates

### 스토리지 관리

- 동적 프로비저닝 사용
- StorageClass로 스토리지 정책 표준화
- PVC 크기 신중히 설정
- 백업 및 스냅샷 전략 수립

### 보안

- Secret 볼륨은 readOnly로 마운트
- hostPath 사용 자제
- 적절한 접근 권한 설정

## 교훈

1. **볼륨은 파드의 데이터 영속성을 제공한다**
2. **PV와 PVC로 스토리지를 추상화한다**
3. **StorageClass로 동적 프로비저닝을 활용한다**
4. **StatefulSet으로 상태 유지 애플리케이션을 관리한다**
5. **적절한 볼륨 타입을 선택하라**
6. **볼륨 스냅샷으로 데이터를 백업한다**
