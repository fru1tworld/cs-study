# 09 헬스 체크와 옵저버빌리티

## 헬스 체크의 중요성

### 자가 치유 (Self-healing)

- 컨테이너 상태 모니터링
- 비정상 컨테이너 자동 재시작
- 트래픽 라우팅 제어

## Liveness Probe

### 개념

컨테이너가 정상 동작하는지 확인

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-pod
spec:
  containers:
    - name: app
      image: nginx
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 3
        periodSeconds: 3
```

### Probe 방식

**HTTP GET**

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
    httpHeaders:
      - name: Custom-Header
        value: Value
  initialDelaySeconds: 15
  periodSeconds: 10
```

**TCP Socket**

```yaml
livenessProbe:
  tcpSocket:
    port: 3306
  initialDelaySeconds: 15
  periodSeconds: 10
```

**Exec Command**

```yaml
livenessProbe:
  exec:
    command:
      - cat
      - /tmp/healthy
  initialDelaySeconds: 5
  periodSeconds: 5
```

## Readiness Probe

### 개념

컨테이너가 트래픽을 받을 준비가 되었는지 확인

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: readiness-pod
spec:
  containers:
    - name: app
      image: myapp:1.0
      readinessProbe:
        httpGet:
          path: /ready
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 5
```

### Liveness vs Readiness

- **Liveness**: 실패 시 컨테이너 재시작
- **Readiness**: 실패 시 서비스에서 제외 (재시작 안 함)

## Startup Probe

### 개념

느리게 시작되는 컨테이너를 위한 프로브

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: startup-pod
spec:
  containers:
    - name: slow-app
      image: slow-startup-app:1.0
      startupProbe:
        httpGet:
          path: /startup
          port: 8080
        failureThreshold: 30
        periodSeconds: 10
      livenessProbe:
        httpGet:
          path: /health
          port: 8080
        periodSeconds: 5
```

## Probe 설정 파라미터

### 타이밍 설정

- **initialDelaySeconds**: 첫 프로브 실행 전 대기 시간
- **periodSeconds**: 프로브 실행 간격
- **timeoutSeconds**: 프로브 타임아웃
- **successThreshold**: 성공으로 간주할 연속 성공 횟수
- **failureThreshold**: 실패로 간주할 연속 실패 횟수

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
```

## 로깅

### 표준 출력 로그

```bash
# 파드 로그 확인
kubectl logs <pod-name>

# 특정 컨테이너 로그
kubectl logs <pod-name> -c <container-name>

# 실시간 로그
kubectl logs -f <pod-name>

# 이전 컨테이너 로그
kubectl logs <pod-name> --previous
```

### 로그 수집 패턴

**Sidecar 패턴**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: log-sidecar
spec:
  containers:
    - name: app
      image: myapp
      volumeMounts:
        - name: logs
          mountPath: /var/log
    - name: log-forwarder
      image: fluent/fluentd
      volumeMounts:
        - name: logs
          mountPath: /var/log
  volumes:
    - name: logs
      emptyDir: {}
```

## 메트릭

### Metrics Server

```bash
# Metrics Server 설치
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# 노드 메트릭 확인
kubectl top nodes

# 파드 메트릭 확인
kubectl top pods
```

### 커스텀 메트릭

- Prometheus로 메트릭 수집
- Grafana로 시각화
- HPA (Horizontal Pod Autoscaler)와 연동

## 디버깅

### Pod 디버깅

```bash
# 파드 상세 정보
kubectl describe pod <pod-name>

# 파드 이벤트 확인
kubectl get events --field-selector involvedObject.name=<pod-name>

# 파드 내 명령 실행
kubectl exec -it <pod-name> -- /bin/bash

# 임시 디버깅 컨테이너
kubectl debug <pod-name> -it --image=busybox
```

### 네트워크 디버깅

```bash
# 서비스 엔드포인트 확인
kubectl get endpoints <service-name>

# DNS 테스트
kubectl run -it --rm debug --image=busybox --restart=Never -- nslookup <service-name>

# 네트워크 정책 확인
kubectl describe networkpolicy
```

## Prometheus와 Grafana

### Prometheus 설치

```bash
# Helm으로 설치
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack
```

### 메트릭 수집

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
spec:
  selector:
    app: myapp
  ports:
    - port: 8080
```

## 분산 추적

### Jaeger

- 마이크로서비스 간 트랜잭션 추적
- 성능 병목 지점 파악
- 서비스 의존성 시각화

## 모범 사례

### Probe 설정

- 적절한 initialDelaySeconds 설정
- 애플리케이션 시작 시간 고려
- failureThreshold를 너무 낮게 설정하지 않기
- 가벼운 헬스 체크 엔드포인트 구현

### 로깅

- 구조화된 로그 (JSON) 사용
- 적절한 로그 레벨 설정
- 민감한 정보 로깅 주의
- 중앙 집중식 로그 관리

### 모니터링

- 핵심 메트릭 정의 (골든 시그널)
  - Latency (지연 시간)
  - Traffic (트래픽)
  - Errors (오류율)
  - Saturation (포화도)
- 알림 설정
- 대시보드 구성

## 교훈

1. **Liveness Probe로 자가 치유 구현**
2. **Readiness Probe로 트래픽 제어**
3. **Startup Probe로 느린 시작 처리**
4. **로그와 메트릭으로 옵저버빌리티 확보**
5. **Prometheus와 Grafana로 모니터링 구축**
6. **적절한 디버깅 도구 활용**
