# 5. 볼륨, 마우늩 클레임을 이용한 데이터 퍼시스턴스

## 5.1 쿠버네티스에서 컨테이너 파일 시스템이 구축되는 과정

파드 속 컨테이너의 파일 시스템은 여러 가지의 출처를 합쳐 구성된다.

먼저 컨테이너 이미지가 파일 시스템의 초기 내용을 제공하고 이 위에 컨테이너가 기록 가능한 레이어가 얹혀진다.

이미지에 들어 있떤 일일을 이 수정한다거나 새로운 파일을 기록하는 작업 이 바로 이 레이어에서 일어난다.

일반적으로 파드 속 컨테이너의 생애 주기는 해당 컨테이너의 생애 주기를 따른다는 점과 파드의 재시작은 그 안에 들어 있는 컨테이너의 재시작이라는 점이다.

우리는 컨테이너의 파일 시스템을 다른 출처에서도 구성할 수 있다는 것을 배웠다.

볼륨을 정의할 때 emptyDir를 정의할 수 있고
파드가 재시작되더라도 유지된다는 장점이 있다.

예를 들어 임시저장 목적이라면 모든 애플리케이션이 사용할 수 있다.

따라서 로컬 캐시에 적합하다.

한편 공디렉터리는 파드와 생애 주기를 함께하므로 대체되어 새 파드를 만들면 처음 상태인 빈 디렉터리가 된다.

## 5.2 볼륨과 마운트로 노드에 데이터 저장하기

이제 데이터를 특정 노드에 고정시킬지 말지를 결정해야한다.
데이터가 특정 노드에 고정도니다는 것은 대체 파드가 이전 파드와 동일한 노드에만 배치되도록 해야 한다는 의미다.

반대로 데이터를 특정 노드에 고정시키지 않는다면 어떤 노드에도 대체 파드를 배치할 수 있다.

쿠버네티스에는 이와 관련된 많은 선택지가 있지만, 우선 우리가 원하는 것이 무엇이고, 그중에서 클러스터에서 사용 가능한 것이 무엇인지 파악해야 한다.

그리고 파드의 정의에 이를 명확히 밝혀야한다.

가장 간단한 것은 노드의 특정 디렉터리를 가리키게 하는 것이다.

공디렉터리 볼륨보다 오래 유지되는 볼륨은 노드 디스크를 가리키는 볼륨이다.

호스트 경로의 한계는 물리적으로 기록되는 곳이 노드이므로 쿠버네티스가 클러스터의 모든 노드에 동일한 데이터의 복제본으로 만들어 주지는 못한다.

## 5.3 전체에서 접근 가능하도록 데이터 저장하기

앞서 파드는 컴퓨팅 계층의 추상이며, 서비스는 네트워크 계층의 추상이라고 설명했다.

스토리지 계층의 추상으로는 영구볼륨과 영구볼륨클레임이 있다.

영구볼륨은 사용 가능한 스토리지 조각을 정의한 쿠버네티스 리소스다.

영구볼륨은 클러스터 관리자가 만드는데, 각각의 영구볼륨에는 이를 구현하는 스토리지 시스템에 대한 볼륨 정의가 들어 있다.

파드가 영구볼륨 클레임을 사용할 수 있으려면 이 클레임이 먼저 영구볼륨과 연결되어야 한다.

## 5.4 스토리지의 유형과 동적 볼륨 프빚비저닝

정적 볼륨 프프ㄹ비저닝 방식은 모든 쿠버네티스 클러스터에서 사용할 수 있다는 점이 장점이다.

스토리지 유형은 표준 쿠버네티스 리소스로 생성되는데, 스토리지 유형의 정의에 따라 세 가지 필드로 이 스토리지가 어떻게 동작할지 저장한다.

provisioner: 영구 볼륨이 필요해질 때 영구 볼륨ㅇㄹ 만드는 주체. 플랫폼에 따라 관리 주체가 달라진다.
reclaimPolicy: 연결되었떤 클레임이 삭제되었을 때 남아 있는 볼륨을 어떻게 처리할지 지정한다. 삭제할 수 있고 남겨둘 수도 있다.
volumeBindingMode: 영구 볼륨 클레임이 생성되자마자 바로 영구 볼륨을 생성해서 연결하지. 아니면 해당 클레임을 사용하는 파드가 생성될 때 영구볼륨을 생성할지 선택할 수 있다.

이 세가지 속성을 조합하여 클러스터에 우리가 원하는 스토리지 유형을 선택할 수 있다.형

## 5.5 스토리지를 선택할 때 고려할점

앞서 쿠버네티스에서 스토리지를 다루는 방법을 설명했다.

대개 파드 정의에 포함된 영구볼륨클레임에서 필요한 스토리지 용량과 사용자 정의 스토리지 유형을 지정하면 된다.

데이터베이스 같은 상태를 가지는 애플리케이션도 쿠버네티스에서 실행해야 할까 ?

데이터 복제본 기능과 함께 고가용성을 확보할 수 있겠지만 그렇다고 당장 오라클 데이터베이스의 구독을 해지하고 쿠버네티스에서 동작하는 MySQL을 이전할 필요는 없다.
