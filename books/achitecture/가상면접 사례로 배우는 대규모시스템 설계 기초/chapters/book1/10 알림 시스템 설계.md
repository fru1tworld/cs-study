# 10장 알림 시스템 설계

알림은 모바일 푸시 알림(mobile push notification), SMS 메시지, 이메일 세 가지로 분류할 수 있다.

## 1단계: 문제 이해 및 설계 범위 확정

### 요구사항

- 푸시 알림, SMS 메시지, 이메일 세 가지 알림 유형을 지원해야 한다
- 연성 실시간 시스템이다. 가능한 한 빨리 전달되어야 하지만, 시스템에 높은 부하가 걸렸을 때는 약간의 지연은 무방하다
- iOS, 안드로이드, 랩톱/데스크톱을 지원해야 한다
- 알림은 클라이언트 애플리케이션 뿐만 아니라 서버 측에서도 만들어 낼 수 있어야 한다
- 사용자가 알림을 받지 않도록 설정할 수 있어야 한다
- 하루에 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 한다

## 2단계: 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

#### iOS 푸시 알림

알림을 보내기 위해서는 다음 세 가지 컴포넌트가 필요하다:

- 알림 제공자(provider): 알림 요청을 만들어 애플 푸시 알림 서비스(APNS)로 보내는 주체다
- APNS: 애플이 제공하는 원격 서비스다. 푸시 알림을 iOS 장치로 보내는 역할을 담당한다
- iOS 단말: 푸시 알림을 수신하는 사용자 단말이다

#### 안드로이드 푸시 알림

안드로이드 푸시 알림도 비슷한 절차로 전송된다. APNS 대신 FCM(Firebase Cloud Messaging)을 사용한다는 점만 다르다.

#### SMS 메시지

SMS 메시지를 보낼 때는 보통 트윌리오(Twilio), 넥스모(Nexmo) 같은 제3 사업자의 서비스를 많이 이용한다.

#### 이메일

이메일을 보낼 때도 센드그리드(Sendgrid), 메일침프(Mailchimp) 같은 상용 서비스를 많이 이용한다.

### 연락처 정보 수집 절차

알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 사용자가 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.

### 알림 전송 및 수신 절차

#### 개략적 설계안 (초안)

- 서비스: 마이크로서비스, 크론잡, 분산 시스템 컴포넌트
- 알림 시스템: 알림 전송/수신 처리의 핵심
- 제3자 서비스: APNS, FCM, SMS, Email 서비스
- iOS, 안드로이드, SMS, 이메일 단말

#### 개선된 설계안

##### 문제점

- SPOF(Single Point Of Failure): 알림 서버가 하나뿐이므로, 장애가 발생할 경우 전체 서비스가 중단된다
- 규모 확장성: 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다
- 성능 병목: 알림 시스템이 모든 것을 처리하다 보면 시스템이 과부하 상태에 빠질 수 있다

##### 개선 사항

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다

### 개선된 설계안의 상세 컴포넌트

#### 알림 서버

- 알림 전송 API 제공
- 알림 전송을 위한 페이로드를 만들어 메시지 큐에 넣는다
- 제3자 서비스와의 통신은 담당하지 않는다

#### 메시지 큐

알림 서버와 작업 서버 사이의 결합을 느슨하게 만들어 준다. 시스템의 견고함(robustness)과 확장성을 보장하는 핵심 컴포넌트다.

#### 작업 서버

메시지 큐에서 전송할 알림을 꺼내서 제3자 서비스로 전달하는 역할을 담당하는 서버다.

#### 제3자 서비스

APNS, FCM, SMS, Email 서비스 등이다. 확장성을 고려한 설계가 중요하다. 예를 들어, 새로운 서비스를 통합하거나 기존 서비스를 제거할 때 매끄럽게 처리될 수 있어야 한다.

#### iOS, 안드로이드, SMS, 이메일

사용자가 알림을 수신하는 단말이다.

## 3단계: 상세 설계

### 안정성

#### 데이터 손실 방지

알림 전송 시스템에 있어 가장 중요한 요구사항 가운데 하나는 알림이 소실되면 안 된다는 것이다.

알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현한다.

#### 알림 중복 전송 방지

같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 가능하지 않다. 다만 중복을 최소화할 수는 있다.

간단한 해결책은 알림이 전송될 때마다 이벤트 ID를 붙이는 것이다. 알림이 도착하면 전송 이력을 검사하여 이미 전송된 적이 있는지 확인한다.

### 추가로 필요한 컴포넌트

#### 알림 템플릿

알림은 형식이 비슷한 경우가 많다. 따라서 알림 템플릿을 사용하면 인자나 스타일, 추적 링크 등을 일일이 만들지 않아도 된다.

#### 알림 설정

사용자가 알림 설정을 상세히 조정할 수 있도록 해야 한다. 이 정보는 알림 설정 테이블에 보관한다.

#### 전송률 제한

한 사용자가 받을 수 있는 알림의 빈도를 제한한다. 너무 많은 알림을 보내면 사용자가 알림을 아예 꺼버릴 수 있다.

#### 재시도 메커니즘

제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다. 같은 문제가 계속 발생하면 개발자에게 통지한다.

#### 푸시 알림과 보안

iOS와 안드로이드 앱의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다.

#### 큐 모니터링

알림 시스템을 모니터링할 때 중요한 메트릭 하나는 큐에 쌓인 알림의 개수다. 이 수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리하고 있지 못하다는 뜻이다.

#### 이벤트 추적

알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는 데 중요하다.

## 4단계: 마무리

이 설계의 몇 가지 유용한 추가 개선사항:

- 안정성: 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘을 구현한다
- 보안: 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey와 appSecret 등의 메커니즘을 이용한다
- 이벤트 추적 및 모니터링: 시스템을 제대로 이해하려면 알림이 만들어지고, 전송되고, 전달되는 과정 전체를 추적하고 모니터링할 수 있어야 한다
- 사용자 설정: 사용자가 알림 설정을 조정할 수 있도록 한다
- 전송률 제한: 사용자에게 알림을 보내는 빈도를 제한한다
