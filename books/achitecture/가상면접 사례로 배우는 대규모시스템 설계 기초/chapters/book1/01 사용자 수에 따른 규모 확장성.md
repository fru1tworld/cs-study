# 1장 사용자 수에 따른 규모 확장성

## 단일 서버

모든 컴포넌트가 단 한대의 단일 서버에서 실행되는 간단한 시스템

## 데이터베이스

사용자가 늘면 여러 서버를 두어야 하고 보통 트래픽 처리, 데이터베이스 용으로 나눈다.

- RDBMS
- NoSQL(Not only SQL)
  - key-value store, graph store, column store, document store
  - 일반적으로 JOIN 지원하지 않음
- NoSQL을 고려해볼 수 있는 분야
  - 아주 낮은 latency가 요구됨
  - 비정형이라 관계형 데이터가 아님
  - serialize, deserialize를 할 수 있기만 하면 됨
  - 아주 많은 양의 데이터를 저장할 필요가 있음

## 수직 규모 확장 vs 수평 규모 확장

- scale up(수직 규모 확장)
  - 서버에 고사양 자원 추가
- scale out(수평 규모 확장)
  - 더 많은 서버를 추가
- 따라서 수직 규모 확장에는 한계가 존재함. 또한 자동복구(failover)나 다중화(redundancy)를 제공하지 않음
- 대규모는 수평적 규모 확장이 보다 적절함

- 로드 밸런서 : 로드밸런서는 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 함

- master-slave 관계 : 원본과 사본을 따로 저장하고 쓰기 연산을 master에서 진행 slave는 읽기 연산을 지원
  - 이점: 더 나은 성능, 안정성, 가용성
- 부 서버가 다운되면 주서버로 이전될 수 있음, 새로운 부 서버가 장애 서버를 대체함
- 주 서버가 다운되면 부 서버가 일을 대체하는데 프로덕션 환경에서는 실제보다 더 복잡하다.

  - 최신 상태가 아닐 수 있음
  - 복구 스크립트를 추가해야하거나, 다중 마스터, 원형 다중화를 하면 대처하는데 도움이 될 수 있음

- 업데이트된 설계안
  - DNS로부터 로드밸런서의 공개 IP를 받는다.
  - HTTP 요청은 서버1, 2로 전달된다.
  - 웹 서버의 query 는 부 서버에서 처리
  - 웹 서버의 Command는 주 서버에서 처리
- latency 개선
  - 캐시와 CDN(Content Delivery Network)로 개선가능

## 캐시

- 자주 참조되거나 값비싼 연산결과를 넣어둠
- 주의점 : 데이터 일관성(consistency), DB
- 캐시 서버가 한대라면 SPOF(Single Point Of Failure)가 될 수 있음
  - 어떤 특정 지점에서의 장애가 전체 시스템의 동작을 중단시켜버릴 수 있는 경우
- 캐시 메모리: 너무 낮으면 eviction 되어 캐시 성능이 떨어짐
- 데이터 방출 정책, 보관 데이터의 만료 정책등을 고민해볼 수 있음
- 방출 정책(LRU, LFU, FIFO 등을 고민해볼 수 있음)
  - 마지막 사용 시점이 가장 오래된(Least Recently Used)
  - 가장 빈도가 낮은 데이터를 보내는 정책(Least Frequently Used)

## 콘텐츠 전송 네트워크

- CDN
  - 정적 콘텐츠를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크( 이미지 비디오 JS 파일 등을 캐시할 수 있음)
  - 동적 콘텐츠는 요청 경로, 질의 문자열, 쿠키, 요청 헤더 등의 정보를 기반하여 HTML 페이지를 캐시함
  - 고려사항
    - 비용
    - 적절한 만료 시한 설정
    - 장애 대처
    - 콘텐츠 무효화

## 무상태 웹 계층

- 상태 정보를 웹 계층에서 제거해야한다.
- 상태 정보를 DB에 저장할 필요가 있다.
- 이렇게 웹 계층에서는 상태 정보가 없고 필요할때 가져오는 것을 무상태 웹 계층이라 한다.
- 무상태 웹 계층의 이유
  - 같은 클라이언트는 같은 서버로 전송을 해야 인증 실패를 하지 않음
  - 이를 위해 로드밸런서에서 고정 세션을 제공하는데 이는 로드밸런서에 부하가 됨
  - 그 외 여러가지로 서버의 장애 및 로드 밸런스 뒷단에 서버 추가 및 삭제가 까다로움

## 데이터 센터

두 개의 데이터 센터를 이용할 경우 장애가 없다면 가장 가까운 곳으로 데이터 센터가 이동된다.

이 절차를 지리적 라우팅(geoDNS-routing, geo-routing)이라 한다.

데이터 센터의 장애가 발생하면 다른 데이터 센터로 전송된다.

다중 데이터 센터 구현을 위한 기술적 난제

- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야한다.
- 데이터 동기화 : 데이터 센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면 장애가 자동으로 복구되어 트래픽이 다른 데이터베이스를 우회해도 없을 수 있음 따라서 일반적으로는 여러 데이터 센터에 걸쳐 다중화를 해놨음
- 테스트와 배포: 여러 데이터 센터를 사용한다면 여러 위치에서 테스트를 할 필요가 있음
  - 자동화 배포 도구는 모든 데이터 센ㅌ너에 동일한 서비스가 설치되도록 하는데 중요한 역할을 함

시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴포넌트를 분리하여 각기 독립적으로 확장할 수 있어야함 이를 위해 메시지 큐를 사용하여 분산 시스템을 구현하려고함

## 메시지 큐

메시지 큐는 메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트

- 버퍼 역할을 하며 비동기로 전송
- 생산자또는 발행자(producer/publisher)가 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행(publish)한다.

서비스 또는 서버 간 결합이 느슨해져서 규모 확장성이 보장되어야하는 애플리케이션을 구성하기 좋다.

## 로그, 메트릭 그리고 자동화

로그: 에러 로그를 모니터링하는 것이 중요하고 서버 단위로 모니터링도 가능하지만 로그를 단일 서비스로 모아주는 도구를 활용하면 더 좋다.
메트릭: 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악할 수도 있다. 메트릭 가운데 특히 유용한 것을 몇 가지 살펴보면 다음과 같다.

- 호스트 단위 메트릭: CPU, Memory, 디스크 I/O 에 관한 메트릭
- 종합 메트릭: 데이터베이스 계층의 성능, 캐시 계층의 성능
- 핵심 비즈니스 로직 메트릭: 일별 능동 사용자, 수익, 재방문 같은 것들
  자동화: 지속적인 통합을 도와주는 도구를 활용하면 좋음 CI/CD

## 데이터베이스의 규모 확장

저장할 데이터가 많아지면 데이터베이스에 대한 부하도 증가한다.
그때가 오면 데이터베이스를 증설할 방법을 찾아야 한다.

### 수직적 확장

- 고성능의 자원(CPU, RAM)의 증설 예를 들어 아마존 AWS의 RDB는 24TB RAM을 갖춘 서버도 상품으로 제공함
  약점:

- 하드웨어에는 한계가 있으므로 무한 증설할 수 없다.
- SPOF로 인한 위험성이 크다.
- 비용이 많이 든다. 고성능 서버로 갈수록 가격이 오름

### 수평적 확장

수평적 확장은 샤딩이라고도 부르는데 샤드라고 부르는 작은 단위로 분할하는 기술을 말한다.
모든 샤드는 같은 스키마를 쓰지만 샤드에 보관된 데이터는 사이에 중복이 없다.
중요한 것은 샤딩 키를 어떻게 정하는지가 어려운 문제인데 이를 파티션 키라고도 부른다.

- 데이터의 재 샤딩: 재 샤딩은 하나의 샤드로는 감당이 어려울 때 샤드 간 데이터 분포가 균등하지 못하여 다른 샤드에 비해 더 빠르게 소모가 진행 될 때(샤드 소진). 이때 안정 해시 기법을 활용하면 해결됨
- 유명인사 문제: 핫스팟 키 문제라고도 부르는데, 특정 샤드에 질의가 집중되어, 서버에 과부하가 걸리는 문제
- 조인과 비정규화: 일단 하나의 데이터베이스를 여러 샤드 서버로 쪼개고 나면 여러 샤드에 걸친 데이터를 조인하기가 힘들어진다. 이를 해결하는 한 가지 방법은 비정규화하여 하나의 테이블에서 질의가 수행될 수 있도록 하는 것이다.

### 백만 사용자, 그 이상

요약하면 다음과 같다.

웹 계층은 무상태 계층으로
모든 계층에 다중화 도입
가능한 한 많은 데이터를 캐시할 것
여러 데이터 센터를 지원할 것
정적 콘텐츠는 CDN을 통해 서비스할 것
데이터 계층은 샤딩을 통해 그 규모를 확장할 것
각 계층은 독립적 서비스로 분할할 것
시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것
