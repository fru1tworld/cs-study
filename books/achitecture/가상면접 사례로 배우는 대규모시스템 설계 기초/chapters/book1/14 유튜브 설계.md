# 14장 유튜브 설계

유튜브를 시청하거나 공유하거나 업로드한 적이 없는 사람은 거의 없을 것이다. 2020년 기준으로 5억 명이 넘는 사용자가 매일 10억 시간 이상을 유튜브에서 보낸다. 이 장에서는 유튜브 같은 비디오 스트리밍 서비스를 설계해본다.

## 1단계: 문제 이해 및 설계 범위 확정

### 기능 요구사항

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성, 규모 확장성, 안정성
- 지원 클라이언트: 모바일 앱, 웹브라우저, 스마트 TV

### 개략적 규모 추정

- DAU: 5백만 명
- 한 사용자는 하루 평균 5개의 비디오를 시청
- 10%의 사용자가 하루에 1개의 비디오를 업로드
- 비디오 평균 크기는 300MB
- 저장을 위한 총 일일 저장 공간: 5백만 명 X 10% X 300MB = 150TB
- CDN 비용: 유튜브가 아마존 클라우드프론트를 사용한다고 가정하면, 1GB 당 0.02달러. 따라서 150TB 스트리밍 비용은 150,000GB X 0.02달러 = 3,000달러/일

## 2단계: 개략적 설계안 제시 및 동의 구하기

비디오 스트리밍 서비스를 만들기 위해서는 다음 세 컴포넌트가 필요하다:

- 클라이언트: 사용자는 컴퓨터, 휴대전화, 스마트 TV를 통해 유튜브를 시청할 수 있다
- CDN: 비디오는 CDN에 저장된다. 재생 버튼을 누르면 CDN으로부터 스트리밍된다
- API 서버: 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다

### 비디오 업로드 절차

비디오를 업로드하는 절차는 다음과 같다:

1. 비디오 업로드: 사용자가 자신의 단말에서 비디오를 업로드한다
2. 업로드가 완료되면, 비디오 메타데이터 서버는 데이터베이스와 캐시를 갱신한다
3. 메타데이터 서버는 업로드가 완료되었음을 알린다

#### 메타데이터 업데이트

메타데이터에는 비디오 URL, 크기, 해상도, 포맷, 사용자 정보 등이 포함된다. 이 정보는 샤딩 및 다중화가 적용된 메타데이터 DB와 캐시에 보관한다.

#### 메타데이터 DB와 캐시

비디오 메타데이터는 샤딩과 다중화가 적용된 데이터베이스에 보관하여 성능과 가용성을 높인다. 메타데이터 캐시는 성능을 높이기 위한 것이다.

### 비디오 스트리밍 절차

비디오 스트리밍은 다운로드와는 다르다. 다운로드는 전체 비디오가 사용자 단말로 복사되어야 재생할 수 있지만, 스트리밍은 동영상 스트림의 일부만 도착해도 바로 재생할 수 있다.

스트리밍 프로토콜은 비디오 스트리밍을 위해 데이터를 전송하는 표준화된 방법이다. 인기 있는 스트리밍 프로토콜:

- MPEG-DASH: Moving Picture Experts Group의 Dynamic Adaptive Streaming over HTTP
- Apple HLS: HTTP Live Streaming
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming (HDS)

비디오는 클라이언트의 기기에 바로 스트리밍되지 않는다. CDN에서 재생된다.

### 비디오 인코딩

비디오 인코딩이 중요한 이유:

- 원본 비디오는 많은 저장 공간을 차지한다
- 상당수 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. 따라서 여러 단말과 대역폭 수준에 맞는 비디오를 준비해야 한다
- 네트워크 대역폭은 한정적이다. 고화질 비디오를 보낼 수 있도록 높은 대역폭을 보장해야 한다
- 모바일 사용자는 데이터 요금제를 사용하므로, 낮은 해상도의 비디오를 선호한다

인코딩 포맷에는 다음이 있다:

- 비트레이트: 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위
- 코덱: 압축 및 압축 해제 알고리즘

## 3단계: 상세 설계

### 비디오 트랜스코딩 아키텍처

비디오 트랜스코딩이 중요한 이유:

- 원본 비디오는 저장 공간을 많이 차지한다
- 많은 단말과 브라우저는 특정 비디오 포맷만 지원한다
- 사용자에게 고화질 비디오를 제공하려면 네트워크 대역폭을 충분히 확보해야 한다
- 네트워크 상태가 좋지 않은 사용자를 위해 저화질 비디오도 준비해야 한다

### 유향 비순환 그래프(DAG) 모델

비디오 트랜스코딩을 위해서는 다양한 단계를 거쳐야 한다. 페이스북의 스트리밍 비디오 엔진은 DAG 프로그래밍 모델을 도입했다.

DAG 모델은 태스크를 단계별로 나눌 수 있고, 일부는 병렬적으로 실행할 수 있다.

### 비디오 트랜스코딩 아키텍처

#### 전처리기

비디오 분할, DAG 생성, 캐시 데이터 등의 역할을 한다.

- 비디오 분할: GOP(Group of Pictures) 단위로 분할한다
- DAG 생성: 클라이언트 프로그래머가 DAG를 만들 수 있도록 설정 파일을 사용한다
- 데이터 캐시: 전처리기는 분할된 비디오를 임시 저장소에 보관한다

#### DAG 스케줄러

DAG 그래프를 단계별로 분할한 다음, 자원 관리자의 태스크 큐에 집어넣는다.

#### 자원 관리자

자원 관리자는 자원 배분을 효과적으로 수행하는 역할을 한다. 다음 세 개의 큐와 태스크 스케줄러로 구성된다:

- 태스크 큐: 실행할 태스크를 보관하는 우선순위 큐
- 작업 서버 큐: 작업 서버의 사용률 정보를 보관하는 우선순위 큐
- 실행 큐: 현재 실행 중인 태스크와 작업 서버 정보를 보관

#### 태스크 작업 서버

DAG 에 정의된 작업을 수행한다. 작업 종류:

- 검사: 비디오 품질 확인
- 썸네일: 비디오 썸네일 이미지 생성
- 워터마크: 비디오에 워터마크 추가

#### 임시 저장소

비디오나 메타데이터 등을 저장하는 임시 저장소다. 데이터는 비디오 처리가 완료되면 삭제된다.

저장소 선택 기준:

- 데이터 종류
- 데이터 크기
- 데이터 접근 빈도
- 데이터 유효 기간

#### 인코딩 완료 비디오 저장소

인코딩이 끝난 비디오를 보관하는 곳이다. CDN으로 옮길 준비가 끝난 비디오다.

### 시스템 최적화

#### 속도 최적화: 비디오 병렬 업로드

비디오를 작은 GOP 단위로 분할하여 병렬적으로 업로드한다.

#### 속도 최적화: 업로드 센터를 사용자 근거리에 지정

CDN을 업로드 센터로 활용한다.

#### 속도 최적화: 모든 절차를 병렬화

느슨하게 결합된 시스템을 만들고, 병렬성을 높이기 위해 메시지 큐를 도입한다.

#### 안전성 최적화: 사전에 서명된 업로드 URL

사전 서명된(pre-signed) 업로드 URL을 사용하여 허가된 사용자만이 올바른 장소에 비디오를 업로드하도록 한다.

#### 안전성 최적화: 비디오 보호

디지털 저작권 관리(DRM) 시스템, AES 암호화, 워터마크 등을 사용한다.

#### 비용 최적화

CDN은 비용이 많이 드는 컴포넌트다.

최적화 전략:

- 인기 비디오만 CDN에서 서비스하고 다른 비디오는 비디오 서버에서 서비스한다
- 인기가 높지 않은 비디오는 인코딩할 필요가 없을 수 있다
- 일부 비디오는 특정 지역에서만 인기가 높다. 다른 지역에까지 옮기지 않는다
- 직접 CDN을 구축한다

### 오류 처리

대규모 시스템에서 오류는 피할 수 없다. 오류에는 두 종류가 있다:

- 회복 가능 오류(recoverable error): 작업을 몇 차례 재시도하면 해결될 수 있는 오류
- 회복 불가능 오류(non-recoverable error): 비디오 포맷이 잘못되는 등의 오류

오류 처리 전략:

- 업로드 오류: 몇 차례 재시도
- 비디오 분할 오류: 전체 비디오를 서버에 전달하지 못한 경우, GOP 경계가 깨진 곳에서 오류 발생
- 트랜스코딩 오류: 재시도
- 전처리기 오류: DAG 그래프를 재생성
- DAG 스케줄러 오류: 태스크 스케줄링을 다시 한다
- 자원 관리자 큐 장애: 복제본 사용
- 태스크 작업 서버 장애: 다른 서버에서 재시도
- API 서버 장애: API 서버는 무상태 서버이므로, 새 요청은 다른 API 서버로 우회
- 메타데이터 캐시 서버 장애: 데이터는 다중화되어 있다. 한 노드가 죽으면 다른 노드에서 데이터를 가져온다
- 메타데이터 데이터베이스 서버 장애:
  - 주 서버가 죽으면 부 서버 가운데 하나를 주 서버로 승격
  - 부 서버가 죽으면 다른 부 서버를 통해 읽기 연산 처리. 새로운 부 서버를 교체

## 4단계: 마무리

추가로 논의할 만한 것들:

- API 서버 규모 확장: API 서버는 무상태이므로, 수평적 규모 확장이 쉽다
- 데이터베이스 규모 확장: 데이터베이스 다중화 및 샤딩 적용
- 라이브 스트리밍: 높은 지연시간 요구사항, 순차적 비디오 업로드, 다른 종류의 오류 처리가 필요하다
- 비디오 삭제: 저작권을 침해하거나 포르노 등의 콘텐츠는 삭제되어야 한다
