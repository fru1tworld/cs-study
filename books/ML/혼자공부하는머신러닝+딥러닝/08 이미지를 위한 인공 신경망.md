# 8. 이미지를 위한 인공 신경망

## 8.1 합성곱 신경망

### 합성곱

**합성곱(convolution)**은 밀집층과 비슷하게 입력과 가중치를 곱한 뒤 절편을 더하는 선형 계산이다.

하지만 밀집층과 달리 합성곱은 입력 데이터 전체에 가중치를 적용하는 것이 아니라 일부에 가중치를 곱한다.

### 합성곱 신경망

**합성곱 신경망(convolutional neural network, CNN)**은 합성곱 층을 사용하는 인공 신경망이다.

```python
from tensorflow import keras

model = keras.Sequential()
model.add(keras.layers.Conv2D(32, kernel_size=3, activation='relu',
                               padding='same', input_shape=(28, 28, 1)))
model.add(keras.layers.MaxPooling2D(2))
```

### 필터와 특성 맵

합성곱 층에서 사용하는 가중치를 **필터(filter)** 또는 **커널(kernel)**이라고 부른다.

필터는 입력에 곱해져서 **특성 맵(feature map)**을 만든다.

### 패딩

**패딩(padding)**은 입력 배열의 주위를 가상의 원소로 채우는 것이다.

**세임 패딩(same padding)**은 입력과 특성 맵의 크기를 동일하게 만들기 위해 입력 주위에 0으로 패딩한다.

**밸리드 패딩(valid padding)**은 패딩 없이 순수한 입력 배열에서만 합성곱을 하여 특성 맵을 만든다.

### 풀링

**풀링(pooling)**은 합성곱 층에서 만든 특성 맵의 가로세로 크기를 줄이는 역할을 한다.

**최대 풀링(max pooling)**은 풀링 영역에서 최댓값을 고른다.

**평균 풀링(average pooling)**은 풀링 영역의 평균값을 계산한다.

```python
model.add(keras.layers.MaxPooling2D(2))
```

### 스트라이드

**스트라이드(stride)**는 필터가 입력 위를 이동하는 크기를 말한다.

일반적으로 스트라이드는 1을 사용하고, 풀링 층에서 특성 맵의 크기를 줄인다.

## 8.2 합성곱 신경망을 사용한 이미지 분류

### 컬러 이미지

컬러 이미지는 RGB 채널로 구성되어 있다. 즉 3차원 배열이다.

```python
# (높이, 너비, 채널)
train_input = train_input.reshape(-1, 28, 28, 1)
val_input = val_input.reshape(-1, 28, 28, 1)
```

### 합성곱 신경망 모델 만들기

```python
model = keras.Sequential([
    keras.layers.Conv2D(32, kernel_size=3, activation='relu',
                        padding='same', input_shape=(28, 28, 1)),
    keras.layers.MaxPooling2D(2),
    keras.layers.Conv2D(64, kernel_size=3, activation='relu',
                        padding='same'),
    keras.layers.MaxPooling2D(2),
    keras.layers.Flatten(),
    keras.layers.Dense(100, activation='relu'),
    keras.layers.Dropout(0.4),
    keras.layers.Dense(10, activation='softmax')
])
```

### 드롭아웃

**드롭아웃(dropout)**은 은닉층에 있는 뉴런의 출력을 랜덤하게 꺼서 과대적합을 막는 기법이다.

훈련하는 동안 드롭아웃이 적용되지만, 평가나 예측을 수행할 때는 적용되지 않는다.

```python
model.add(keras.layers.Dropout(0.4))
```

## 8.3 합성곱 신경망의 시각화

### 가중치 시각화

합성곱 층의 가중치는 이미지로 시각화할 수 있다.

```python
# 첫 번째 합성곱 층의 가중치
conv1 = model.layers[0]
weights = conv1.get_weights()

# 가중치 시각화
import matplotlib.pyplot as plt

fig, axs = plt.subplots(4, 8, figsize=(10, 5))
for i in range(32):
    row = i // 8
    col = i % 8
    axs[row, col].imshow(weights[0][:, :, 0, i], cmap='gray_r')
    axs[row, col].axis('off')
```

### 특성 맵 시각화

합성곱 층에서 만든 특성 맵을 시각화하면 합성곱 층이 어떤 특징을 학습했는지 이해할 수 있다.

```python
# 합성곱 층까지만 출력하는 모델
conv_acti = keras.Model(model.input, model.layers[0].output)

# 특성 맵 출력
feature_maps = conv_acti.predict(train_input[0:1])

# 특성 맵 시각화
fig, axs = plt.subplots(4, 8, figsize=(15, 8))
for i in range(32):
    row = i // 8
    col = i % 8
    axs[row, col].imshow(feature_maps[0,:,:,i], cmap='gray_r')
    axs[row, col].axis('off')
```

## 핵심 키워드

- **합성곱**: 입력 데이터 일부에 가중치를 곱하는 선형 계산
- **합성곱 신경망**: 합성곱 층을 사용하는 인공 신경망
- **필터**: 합성곱 층에서 사용하는 가중치
- **특성 맵**: 필터를 입력에 적용하여 만든 출력
- **패딩**: 입력 배열 주위를 가상의 원소로 채우는 것
- **풀링**: 특성 맵의 가로세로 크기를 줄이는 역할
- **드롭아웃**: 은닉층의 뉴런 출력을 랜덤하게 꺼서 과대적합을 막는 기법
