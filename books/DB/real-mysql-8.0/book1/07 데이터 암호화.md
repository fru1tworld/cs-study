# 07 데이터 암호화

## MySQL 데이터 암호화 개요

데이터 암호화는 저장된 데이터의 보안을 위해 필수적인 기능이다. MySQL 8.0은 다양한 암호화 기능을 제공한다.

## InnoDB 테이블스페이스 암호화

### 테이블 암호화

```sql
-- 암호화된 테이블 생성
CREATE TABLE encrypted_table (
    id INT PRIMARY KEY,
    sensitive_data VARCHAR(255)
) ENCRYPTION='Y';

-- 기존 테이블 암호화
ALTER TABLE table_name ENCRYPTION='Y';

-- 암호화 해제
ALTER TABLE table_name ENCRYPTION='N';
```

### 파일별 테이블스페이스 암호화

```sql
-- 개별 테이블 파일 암호화
CREATE TABLE secure_data (
    id INT PRIMARY KEY,
    credit_card VARCHAR(20)
) ENCRYPTION='Y';

-- 확인
SELECT
    TABLE_SCHEMA,
    TABLE_NAME,
    CREATE_OPTIONS
FROM INFORMATION_SCHEMA.TABLES
WHERE CREATE_OPTIONS LIKE '%ENCRYPTION%';
```

## 암호화 키 관리

### 키링 플러그인 (Keyring Plugin)

#### keyring_file (기본)

```ini
[mysqld]
early-plugin-load=keyring_file.so
keyring_file_data=/var/lib/mysql-keyring/keyring
```

#### keyring_encrypted_file (암호화된 키링)

```ini
[mysqld]
early-plugin-load=keyring_encrypted_file.so
keyring_encrypted_file_data=/var/lib/mysql-keyring/keyring-encrypted
keyring_encrypted_file_password=password
```

#### keyring_okv (Oracle Key Vault)

```ini
[mysqld]
early-plugin-load=keyring_okv.so
keyring_okv_conf_dir=/usr/local/mysql/keyring_okv
```

### 마스터 키 로테이션

```sql
-- 마스터 키 교체
ALTER INSTANCE ROTATE INNODB MASTER KEY;

-- 자동 로테이션 (cron 등으로 주기적 실행)
```

## 바이너리 로그 암호화

### 활성화

```ini
[mysqld]
binlog_encryption=ON

-- 또는 동적으로 변경
SET GLOBAL binlog_encryption=ON;
```

### 바이너리 로그 암호화 키

```sql
-- 바이너리 로그 마스터 키 교체
ALTER INSTANCE ROTATE BINLOG MASTER KEY;
```

## Redo 로그 암호화

### 설정

```ini
[mysqld]
innodb_redo_log_encrypt=ON
```

### 특징

- Redo 로그 파일 암호화
- 크래시 복구 시에도 보안 유지
- 성능 영향 최소화

## Undo 로그 암호화

### 설정

```ini
[mysqld]
innodb_undo_log_encrypt=ON
```

### 언두 테이블스페이스 암호화

```sql
-- 모든 언두 테이블스페이스 암호화
ALTER UNDO TABLESPACE undo_001 SET ENCRYPTION='Y';
ALTER UNDO TABLESPACE undo_002 SET ENCRYPTION='Y';
```

## 일반 테이블스페이스 암호화

### 암호화된 테이블스페이스 생성

```sql
-- 암호화된 테이블스페이스 생성
CREATE TABLESPACE encrypted_ts
    ADD DATAFILE 'encrypted_ts.ibd'
    ENCRYPTION='Y';

-- 테이블을 암호화된 테이블스페이스에 생성
CREATE TABLE secure_table (
    id INT PRIMARY KEY,
    data VARCHAR(255)
) TABLESPACE=encrypted_ts;
```

## 데이터베이스 수준 암호화

### 기본 암호화 설정

```ini
[mysqld]
# 새로 생성되는 테이블 기본 암호화
default_table_encryption=ON
```

### 스키마 기본 암호화

```sql
-- 데이터베이스 생성 시
CREATE DATABASE secure_db DEFAULT ENCRYPTION='Y';

-- 기존 데이터베이스 변경
ALTER DATABASE secure_db DEFAULT ENCRYPTION='Y';

-- 확인
SELECT
    SCHEMA_NAME,
    DEFAULT_ENCRYPTION
FROM INFORMATION_SCHEMA.SCHEMATA;
```

## SSL/TLS 연결 암호화

### SSL 설정

```ini
[mysqld]
# SSL 인증서 설정
ssl-ca=/path/to/ca.pem
ssl-cert=/path/to/server-cert.pem
ssl-key=/path/to/server-key.pem

# SSL 필수 연결
require_secure_transport=ON
```

### 사용자별 SSL 요구

```sql
-- SSL 연결 필수 사용자
CREATE USER 'secure_user'@'%'
    IDENTIFIED BY 'password'
    REQUIRE SSL;

-- X509 인증서 요구
CREATE USER 'cert_user'@'%'
    IDENTIFIED BY 'password'
    REQUIRE X509;

-- 특정 인증서 요구
CREATE USER 'specific_user'@'%'
    IDENTIFIED BY 'password'
    REQUIRE SUBJECT '/C=KR/ST=Seoul/O=Company/CN=client'
    AND ISSUER '/C=KR/ST=Seoul/O=Company/CN=CA';
```

### SSL 연결 확인

```sql
-- 현재 연결 상태
SHOW STATUS LIKE 'Ssl_cipher';
\s  -- 상태 확인

-- SSL 변수 확인
SHOW VARIABLES LIKE '%ssl%';

-- 연결 정보
SELECT
    USER,
    HOST,
    SSL_CIPHER
FROM performance_schema.users;
```

## 애플리케이션 레벨 암호화

### AES 암호화 함수

```sql
-- AES 암호화
SELECT AES_ENCRYPT('sensitive_data', 'encryption_key');

-- AES 복호화
SELECT AES_DECRYPT(encrypted_column, 'encryption_key');

-- 사용 예제
UPDATE users
SET credit_card = AES_ENCRYPT(credit_card, 'secret_key')
WHERE user_id = 123;

SELECT
    user_id,
    AES_DECRYPT(credit_card, 'secret_key') AS credit_card
FROM users
WHERE user_id = 123;
```

### 해시 함수

```sql
-- SHA2 해시 (비밀번호 등)
SELECT SHA2('password', 256);

-- MD5 (보안성 낮음, 권장 안 함)
SELECT MD5('data');
```

## 암호화 성능 영향

### 벤치마크

```sql
-- 암호화 오버헤드 측정
SELECT COUNT(*) FROM encrypted_table;  -- 암호화
SELECT COUNT(*) FROM normal_table;     -- 비암호화

-- I/O 통계
SELECT * FROM performance_schema.file_summary_by_instance
WHERE FILE_NAME LIKE '%encrypted_table%';
```

### 성능 최적화

```ini
[mysqld]
# 버퍼 풀 크기 증가 (암호화/복호화 캐싱)
innodb_buffer_pool_size = 8G

# 암호화 스레드 수
innodb_encryption_threads = 4

# Redo 로그 크기
innodb_log_file_size = 1G
```

## 암호화 모니터링

### 암호화 상태 확인

```sql
-- 테이블 암호화 상태
SELECT
    TABLE_SCHEMA,
    TABLE_NAME,
    CREATE_OPTIONS
FROM INFORMATION_SCHEMA.TABLES
WHERE CREATE_OPTIONS LIKE '%ENCRYPTION%';

-- 테이블스페이스 암호화
SELECT
    NAME,
    ENCRYPTION
FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;

-- 암호화 진행 상태
SELECT * FROM performance_schema.data_lock_waits
WHERE REQUESTING_THREAD_ID IN (
    SELECT THREAD_ID FROM performance_schema.threads
    WHERE NAME LIKE '%encryption%'
);
```

### 키링 상태

```sql
-- 키링 플러그인 상태
SELECT
    PLUGIN_NAME,
    PLUGIN_STATUS,
    PLUGIN_TYPE
FROM INFORMATION_SCHEMA.PLUGINS
WHERE PLUGIN_NAME LIKE 'keyring%';

-- 마스터 키 정보
SHOW VARIABLES LIKE 'keyring%';
```

## 암호화 마이그레이션

### 기존 테이블 암호화

```sql
-- 단계적 암호화
ALTER TABLE large_table ENCRYPTION='Y', ALGORITHM=INPLACE, LOCK=NONE;

-- 백그라운드 암호화 (innodb_encryption_threads > 0)
SET GLOBAL innodb_encryption_threads=4;
```

### 전체 데이터베이스 암호화 스크립트

```sql
-- 모든 테이블 암호화 (신중하게 사용)
SELECT CONCAT(
    'ALTER TABLE ',
    table_schema, '.', table_name,
    ' ENCRYPTION=''Y'';'
)
FROM information_schema.tables
WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    AND engine = 'InnoDB';
```

## 규정 준수 (Compliance)

### GDPR

- 개인 정보 암호화
- 데이터 접근 제어
- 암호화 키 관리

### PCI DSS

- 신용카드 정보 암호화
- 전송 중 암호화 (SSL/TLS)
- 키 관리 및 교체

### HIPAA

- 의료 정보 암호화
- 접근 로그
- 암호화 정책

## Best Practices

1. **키 관리**: 안전한 키 저장소 사용
2. **키 로테이션**: 주기적인 마스터 키 교체
3. **선택적 암호화**: 민감한 데이터만 암호화
4. **SSL/TLS**: 전송 중 데이터 암호화
5. **모니터링**: 암호화 상태 정기 확인
6. **백업 암호화**: 백업 파일도 암호화
7. **성능 테스트**: 암호화 영향 사전 평가
8. **규정 준수**: 관련 법규 및 표준 준수

## 암호화 vs 비암호화 비교

### 장점

- 데이터 유출 시 보호
- 규정 준수
- 보안 강화

### 단점

- 성능 오버헤드 (5-15%)
- 관리 복잡성 증가
- 키 분실 시 데이터 복구 불가

## 결론

MySQL 8.0의 데이터 암호화 기능은 민감한 데이터 보호에 필수적이다. 적절한 암호화 전략과 키 관리를 통해 보안과 성능의 균형을 맞춰야 한다.
