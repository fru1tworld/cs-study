# 06 데이터 압축

## MySQL 데이터 압축 개요

데이터 압축은 디스크 공간 절약과 I/O 성능 향상을 위해 사용된다.

## 페이지 압축 (Transparent Page Compression)

### 특징

- 운영체제의 Sparse File과 Hole Punching 기능 활용
- 압축된 페이지만큼의 공간을 운영체제에 반환
- 투명하게 동작 (애플리케이션 변경 불필요)

### 페이지 압축 활성화

```sql
-- 테이블 생성 시
CREATE TABLE compressed_page (
    id INT PRIMARY KEY,
    data TEXT
) COMPRESSION='zlib';

-- 기존 테이블 변경
ALTER TABLE table_name COMPRESSION='zlib';

-- 압축 알고리즘: 'zlib', 'lz4', 'none'
```

### 시스템 변수

```ini
[mysqld]
innodb_compression_level = 6    # 압축 레벨 (1-9)
innodb_compression_failure_threshold_pct = 5
innodb_compression_pad_pct_max = 50
```

## 테이블 압축 (Table Compression)

### 특징

- InnoDB의 자체 압축 기능
- KEY_BLOCK_SIZE 지정 필요
- 압축 페이지는 버퍼 풀에 압축된 상태로 저장

### 테이블 압축 생성

```sql
-- 압축 테이블 생성
CREATE TABLE compressed_table (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    data TEXT
) ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8;

-- KEY_BLOCK_SIZE: 1, 2, 4, 8, 16 (KB)
```

### 압축 테이블로 변경

```sql
ALTER TABLE table_name
ROW_FORMAT=COMPRESSED
KEY_BLOCK_SIZE=8;
```

### 압축 효율 확인

```sql
-- INFORMATION_SCHEMA 조회
SELECT
    TABLE_NAME,
    ROW_FORMAT,
    CREATE_OPTIONS,
    TABLE_ROWS,
    DATA_LENGTH,
    INDEX_LENGTH,
    DATA_FREE
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA = 'database_name';

-- 압축 통계
SELECT * FROM INFORMATION_SCHEMA.INNODB_CMP;
SELECT * FROM INFORMATION_SCHEMA.INNODB_CMP_RESET;

-- 페이지별 압축 통계
SELECT * FROM INFORMATION_SCHEMA.INNODB_CMP_PER_INDEX;
```

## 압축 알고리즘

### zlib (기본)

- 압축률이 높음
- CPU 사용량이 높음
- 압축/압축 해제 속도가 느림

### LZ4

- 빠른 압축/압축 해제
- 압축률이 zlib보다 낮음
- 실시간 처리에 적합

```sql
-- LZ4 사용
CREATE TABLE lz4_table (
    id INT PRIMARY KEY,
    data TEXT
) COMPRESSION='lz4';
```

## InnoDB 버퍼 풀과 압축

### 압축 페이지 버퍼

- 압축된 페이지를 별도로 캐시
- 압축 해제 없이 바로 사용 가능

### 모니터링

```sql
-- 버퍼 풀 통계
SELECT * FROM INFORMATION_SCHEMA.INNODB_BUFFER_PAGE_LRU
WHERE COMPRESSED_SIZE > 0;

-- 압축 페이지 비율
SELECT
    ROUND(SUM(IF(COMPRESSED_SIZE > 0, 1, 0)) / COUNT(*) * 100, 2)
        AS compressed_pct
FROM INFORMATION_SCHEMA.INNODB_BUFFER_PAGE_LRU;
```

## 압축 성능 최적화

### KEY_BLOCK_SIZE 선택

```sql
-- 작은 값: 높은 압축률, 느린 성능
-- 큰 값: 낮은 압축률, 빠른 성능

-- 테스트를 통해 최적값 찾기
CREATE TABLE test_1k (...) KEY_BLOCK_SIZE=1;
CREATE TABLE test_2k (...) KEY_BLOCK_SIZE=2;
CREATE TABLE test_4k (...) KEY_BLOCK_SIZE=4;
CREATE TABLE test_8k (...) KEY_BLOCK_SIZE=8;
```

### 압축 실패 모니터링

```sql
-- 압축 실패 비율
SELECT
    COMPRESS_OPS,
    COMPRESS_OPS_OK,
    COMPRESS_TIME,
    UNCOMPRESS_OPS,
    UNCOMPRESS_TIME,
    ROUND((COMPRESS_OPS - COMPRESS_OPS_OK) / COMPRESS_OPS * 100, 2)
        AS failure_pct
FROM INFORMATION_SCHEMA.INNODB_CMP;
```

### 설정 조정

```ini
[mysqld]
# 압축 실패 임계값 (5% 기본)
innodb_compression_failure_threshold_pct = 5

# 압축 패딩 최대 비율
innodb_compression_pad_pct_max = 50

# 압축 레벨 (1-9, 6이 기본)
innodb_compression_level = 6
```

## MyISAM 테이블 압축

### myisampack 사용

```bash
# 테이블 압축
myisampack /var/lib/mysql/database_name/table_name

# 인덱스 재생성
myisamchk -rq /var/lib/mysql/database_name/table_name
```

### 특징

- 읽기 전용으로 변경됨
- 매우 높은 압축률
- 정적 데이터에 적합

## 압축 사용 시나리오

### 적합한 경우

1. **로그 데이터**: 대량의 로그, 변경 빈도 낮음
2. **아카이브 데이터**: 과거 데이터, 조회만 발생
3. **텍스트가 많은 데이터**: 게시글, 댓글 등
4. **디스크 공간이 부족한 경우**

### 부적합한 경우

1. **자주 업데이트되는 테이블**
2. **실시간 트랜잭션 처리**
3. **CPU 리소스가 부족한 환경**
4. **작은 레코드 크기**

## 압축 성능 테스트

### 테스트 쿼리

```sql
-- 압축 전후 크기 비교
SELECT
    table_name,
    ROUND(data_length / 1024 / 1024, 2) AS data_mb,
    ROUND(index_length / 1024 / 1024, 2) AS index_mb,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS total_mb
FROM information_schema.tables
WHERE table_schema = 'database_name';

-- 압축 통계 확인
SELECT
    page_size,
    compress_ops,
    compress_ops_ok,
    compress_time/1000000 AS compress_time_sec,
    uncompress_ops,
    uncompress_time/1000000 AS uncompress_time_sec
FROM information_schema.innodb_cmp;
```

## Best Practices

1. **테스트 필수**: 실제 데이터로 압축 효과 검증
2. **KEY_BLOCK_SIZE 최적화**: 데이터 특성에 맞게 선택
3. **모니터링**: 압축 실패율 주기적 확인
4. **선택적 적용**: 모든 테이블이 아닌 필요한 테이블만
5. **CPU 리소스 고려**: 압축/압축 해제에 CPU 사용
6. **백업 전략**: 압축 테이블의 백업 시간 증가 고려

## 압축 vs 비압축 트레이드오프

### 압축의 장점

- 디스크 공간 절약 (30-70%)
- I/O 감소
- 백업 크기 감소

### 압축의 단점

- CPU 오버헤드
- 압축/압축 해제 시간
- 버퍼 풀 효율 저하 가능성
- 복잡한 관리

## 결론

MySQL 8.0의 압축 기능은 디스크 공간 절약과 I/O 성능 개선에 효과적이다. 하지만 CPU 오버헤드와 관리 복잡성을 고려하여 적절한 상황에서 선택적으로 사용해야 한다.
