# 03 사용자 및 권한

## MySQL 사용자 계정

MySQL의 사용자 계정은 아이디와 호스트를 함께 명시해야 한다.

### 사용자 식별 방식

```sql
'user'@'host'

-- 예시
'admin'@'localhost'      -- 로컬호스트에서만 접속
'app'@'192.168.1.100'    -- 특정 IP에서만 접속
'user'@'%'               -- 모든 외부 호스트에서 접속
'user'@'192.168.1.%'     -- 특정 대역에서 접속
```

## 사용자 계정 관리

### 계정 생성

```sql
-- 기본 생성
CREATE USER 'username'@'host' IDENTIFIED BY 'password';

-- 비밀번호 없이 생성
CREATE USER 'username'@'host';

-- 인증 플러그인 지정
CREATE USER 'username'@'host'
    IDENTIFIED WITH caching_sha2_password BY 'password';

-- 비밀번호 옵션
CREATE USER 'username'@'host'
    IDENTIFIED BY 'password'
    PASSWORD EXPIRE INTERVAL 90 DAY
    PASSWORD HISTORY 3
    PASSWORD REUSE INTERVAL 90 DAY
    FAILED_LOGIN_ATTEMPTS 3
    PASSWORD_LOCK_TIME 2;
```

### 계정 변경

```sql
-- 비밀번호 변경
ALTER USER 'username'@'host' IDENTIFIED BY 'new_password';

-- 본인 비밀번호 변경
SET PASSWORD = 'new_password';

-- 계정 잠금
ALTER USER 'username'@'host' ACCOUNT LOCK;

-- 계정 잠금 해제
ALTER USER 'username'@'host' ACCOUNT UNLOCK;
```

### 계정 삭제

```sql
DROP USER 'username'@'host';

-- 여러 계정 동시 삭제
DROP USER 'user1'@'host1', 'user2'@'host2';
```

## 권한 관리

### 권한의 종류

#### 글로벌 권한

- 데이터베이스나 테이블 이외의 객체에 적용되는 권한
- GRANT 명령에서 특정 객체를 명시하지 못함
- 예: CREATE USER, CREATE ROLE, SHUTDOWN

#### 객체 권한

- 데이터베이스나 테이블을 제어하는 데 필요한 권한
- GRANT 명령으로 특정 객체를 명시
- 예: SELECT, INSERT, UPDATE, DELETE

#### 주요 권한 목록

```
ALL PRIVILEGES          모든 권한
ALTER                   테이블 구조 변경
CREATE                  데이터베이스, 테이블 생성
CREATE USER             사용자 생성
DELETE                  데이터 삭제
DROP                    데이터베이스, 테이블 삭제
EVENT                   이벤트 생성 및 삭제
EXECUTE                 스토어드 프로시저/함수 실행
GRANT OPTION            권한 부여
INDEX                   인덱스 생성 및 삭제
INSERT                  데이터 삽입
PROCESS                 프로세스 목록 조회
REFERENCES              외래 키 생성
RELOAD                  FLUSH 명령 실행
REPLICATION CLIENT      복제 클라이언트 접속
REPLICATION SLAVE       복제 슬레이브 설정
SELECT                  데이터 조회
SHOW DATABASES          데이터베이스 목록 조회
SHOW VIEW               뷰 정의 조회
SHUTDOWN                서버 종료
SUPER                   관리자 권한
TRIGGER                 트리거 생성 및 삭제
UPDATE                  데이터 수정
```

### 권한 부여

```sql
-- 전체 권한 부여
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'localhost';

-- 특정 데이터베이스에 권한 부여
GRANT SELECT, INSERT, UPDATE, DELETE
ON database_name.* TO 'user'@'host';

-- 특정 테이블에 권한 부여
GRANT SELECT, INSERT ON database_name.table_name
TO 'user'@'host';

-- 특정 컬럼에 권한 부여
GRANT SELECT (col1, col2), UPDATE (col1)
ON database_name.table_name TO 'user'@'host';

-- WITH GRANT OPTION (권한 부여 권한)
GRANT SELECT ON database_name.* TO 'user'@'host'
WITH GRANT OPTION;

-- 권한 적용
FLUSH PRIVILEGES;
```

### 권한 확인

```sql
-- 현재 사용자의 권한
SHOW GRANTS;
SHOW GRANTS FOR CURRENT_USER;

-- 특정 사용자의 권한
SHOW GRANTS FOR 'username'@'host';

-- 권한 테이블 직접 조회
SELECT * FROM mysql.user WHERE user='username';
SELECT * FROM mysql.db WHERE user='username';
SELECT * FROM mysql.tables_priv WHERE user='username';
```

### 권한 회수

```sql
-- 특정 권한 회수
REVOKE INSERT, UPDATE, DELETE
ON database_name.* FROM 'user'@'host';

-- 모든 권한 회수
REVOKE ALL PRIVILEGES ON *.* FROM 'user'@'host';

-- GRANT OPTION 회수
REVOKE GRANT OPTION ON database_name.* FROM 'user'@'host';
```

## 역할 (Role) - MySQL 8.0

### 역할 생성

```sql
-- 역할 생성
CREATE ROLE 'role_name';

-- 여러 역할 동시 생성
CREATE ROLE 'role1', 'role2', 'role3';

-- 역할에 권한 부여
GRANT SELECT, INSERT, UPDATE ON database_name.* TO 'role_name';
```

### 역할 활용

```sql
-- 사용자에게 역할 부여
GRANT 'role_name' TO 'user'@'host';

-- 여러 역할 부여
GRANT 'role1', 'role2' TO 'user'@'host';

-- 역할 활성화
SET ROLE 'role_name';
SET ROLE ALL;
SET ROLE DEFAULT;

-- 기본 역할 설정
ALTER USER 'user'@'host' DEFAULT ROLE 'role_name';
SET DEFAULT ROLE ALL TO 'user'@'host';
```

### 역할 관리

```sql
-- 역할 조회
SELECT * FROM mysql.role_edges;
SELECT * FROM information_schema.APPLICABLE_ROLES;

-- 역할 회수
REVOKE 'role_name' FROM 'user'@'host';

-- 역할 삭제
DROP ROLE 'role_name';
```

### 역할 활용 예시

```sql
-- 읽기 전용 역할
CREATE ROLE 'app_read';
GRANT SELECT ON app_db.* TO 'app_read';

-- 읽기/쓰기 역할
CREATE ROLE 'app_write';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.* TO 'app_write';

-- 관리자 역할
CREATE ROLE 'app_admin';
GRANT ALL PRIVILEGES ON app_db.* TO 'app_admin';

-- 사용자에게 역할 부여
GRANT 'app_read' TO 'user1'@'localhost';
GRANT 'app_write' TO 'user2'@'localhost';
GRANT 'app_admin' TO 'admin'@'localhost';

-- 기본 역할 설정
SET DEFAULT ROLE ALL TO 'user1'@'localhost';
```

## 비밀번호 관리

### 비밀번호 정책

```sql
-- 비밀번호 정책 확인
SHOW VARIABLES LIKE 'validate_password%';

-- 비밀번호 정책 설정 (my.cnf)
[mysqld]
validate_password.policy=MEDIUM
validate_password.length=8
validate_password.mixed_case_count=1
validate_password.number_count=1
validate_password.special_char_count=1
```

### 비밀번호 만료

```sql
-- 계정 생성 시 만료 정책 설정
CREATE USER 'user'@'host'
    IDENTIFIED BY 'password'
    PASSWORD EXPIRE INTERVAL 90 DAY;

-- 즉시 만료
ALTER USER 'user'@'host' PASSWORD EXPIRE;

-- 만료 안 함
ALTER USER 'user'@'host' PASSWORD EXPIRE NEVER;

-- 기본 정책 사용
ALTER USER 'user'@'host' PASSWORD EXPIRE DEFAULT;
```

### 비밀번호 재사용 제한

```sql
-- 비밀번호 이력 관리
ALTER USER 'user'@'host'
    PASSWORD HISTORY 6        -- 최근 6개 비밀번호 재사용 금지
    PASSWORD REUSE INTERVAL 365 DAY;  -- 365일 이내 재사용 금지
```

### 이중 비밀번호 (Dual Password)

```sql
-- 이전 비밀번호 유지하면서 새 비밀번호 설정
ALTER USER 'user'@'host'
    IDENTIFIED BY 'new_password' RETAIN CURRENT PASSWORD;

-- 이전 비밀번호 삭제
ALTER USER 'user'@'host' DISCARD OLD PASSWORD;
```

## 계정 잠금

### 로그인 실패 시 잠금

```sql
CREATE USER 'user'@'host'
    IDENTIFIED BY 'password'
    FAILED_LOGIN_ATTEMPTS 3      -- 3회 실패 시
    PASSWORD_LOCK_TIME 2;        -- 2일간 잠금

-- 무제한 잠금
PASSWORD_LOCK_TIME UNBOUNDED;
```

### 수동 잠금

```sql
-- 계정 잠금
ALTER USER 'user'@'host' ACCOUNT LOCK;

-- 계정 잠금 해제
ALTER USER 'user'@'host' ACCOUNT UNLOCK;
```

## 권한 테이블

### mysql 데이터베이스의 권한 테이블

```sql
mysql.user              -- 사용자 계정 및 글로벌 권한
mysql.db                -- 데이터베이스 단위 권한
mysql.tables_priv       -- 테이블 단위 권한
mysql.columns_priv      -- 컬럼 단위 권한
mysql.procs_priv        -- 스토어드 프로시저/함수 권한
mysql.proxies_priv      -- 프록시 권한
mysql.role_edges        -- 역할 관계
mysql.default_roles     -- 기본 역할
```

## 접속 제한

### 리소스 제한

```sql
CREATE USER 'user'@'host'
    IDENTIFIED BY 'password'
    WITH MAX_QUERIES_PER_HOUR 500         -- 시간당 최대 쿼리 수
         MAX_UPDATES_PER_HOUR 100         -- 시간당 최대 업데이트 수
         MAX_CONNECTIONS_PER_HOUR 50      -- 시간당 최대 접속 수
         MAX_USER_CONNECTIONS 5;          -- 동시 접속 수
```

### IP 기반 접근 제어

```sql
-- 특정 IP만 허용
CREATE USER 'user'@'192.168.1.100' IDENTIFIED BY 'password';

-- 특정 대역 허용
CREATE USER 'user'@'192.168.1.%' IDENTIFIED BY 'password';

-- 특정 도메인 허용
CREATE USER 'user'@'%.example.com' IDENTIFIED BY 'password';
```

## 보안 best practices

1. **최소 권한 원칙**: 필요한 최소한의 권한만 부여
2. **강력한 비밀번호**: 복잡한 비밀번호 정책 사용
3. **비밀번호 만료**: 정기적인 비밀번호 변경
4. **역할 활용**: 권한 관리를 역할 기반으로 구조화
5. **계정 분리**: 용도별로 계정 분리 (읽기, 쓰기, 관리)
6. **감사 로그**: 중요 작업에 대한 로그 기록
7. **SSL/TLS**: 암호화된 연결 사용
8. **정기 검토**: 불필요한 계정 및 권한 정기 검토

## 결론

MySQL 8.0의 향상된 사용자 및 권한 관리 기능을 활용하여 보안성과 관리 편의성을 동시에 높일 수 있다. 특히 역할(Role) 기능을 통해 권한 관리를 체계적으로 할 수 있다.
