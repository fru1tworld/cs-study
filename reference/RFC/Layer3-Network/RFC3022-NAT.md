# RFC 3022 - 전통적인 IP 네트워크 주소 변환기 (Traditional NAT)

```
Network Working Group                                       P. Srisuresh
Request for Comments: 3022                              Jasmine Networks
Obsoletes: 1631                                               K. Egevang
Category: Informational                                Intel Corporation
                                                            January 2001
```

## 이 메모의 상태

이 메모는 인터넷 커뮤니티를 위한 정보를 제공한다. 이것은 어떤 종류의 인터넷 표준도 명시하지 않는다. 이 메모의 배포는 무제한이다.

## 저작권 고지

Copyright (C) The Internet Society (2001). All Rights Reserved.

## 서문

이 문서에서 설명하는 NAT 동작은 RFC 1631에서 소개된 주소 변환을 확장하고 새로운 유형의 네트워크 주소 및 TCP/UDP 포트 변환을 포함한다. 또한, 이 문서는 RFC 1631에 게시된 체크섬 조정 알고리즘을 수정하고 NAT 동작과 제한사항을 상세히 논의하고자 한다.

## 요약

기본 네트워크 주소 변환(Basic NAT)은 IP 주소가 한 그룹에서 다른 그룹으로 매핑되는 방법으로, 최종 사용자에게 투명하다. 네트워크 주소 포트 변환(NAPT)은 많은 네트워크 주소와 그들의 TCP/UDP(전송 제어 프로토콜/사용자 데이터그램 프로토콜) 포트가 단일 네트워크 주소와 그 TCP/UDP 포트로 변환되는 방법이다. 이 두 가지 동작을 함께 전통적인 NAT라고 하며, 사설 주소를 가진 영역을 전역적으로 고유한 등록된 주소를 가진 외부 영역에 연결하는 메커니즘을 제공한다.

## 1. 소개

IP 주소 변환의 필요성은 네트워크의 내부 IP 주소가 프라이버시 이유로 또는 네트워크 외부에서 사용하기에 유효하지 않기 때문에 네트워크 외부에서 사용할 수 없을 때 발생한다.

로컬 도메인 외부의 네트워크 토폴로지는 여러 가지 방식으로 변경될 수 있다. 고객이 제공업체를 변경하거나, 회사 백본이 재구성되거나, 제공업체가 합병되거나 분할될 수 있다. 외부 토폴로지가 시간이 지남에 따라 변경될 때마다, 로컬 도메인 내의 노드에 대한 주소 할당도 외부 변경을 반영하도록 변경되어야 한다. 이러한 유형의 변경은 단일 주소 변환 라우터에 변경을 집중함으로써 도메인 내 사용자에게 숨길 수 있다.

기본 주소 변환은 (많은 경우, [NAT-TERM] 및 이 문서의 섹션 6에서 언급된 것을 제외하고) 사설 네트워크의 호스트가 외부 네트워크에 투명하게 접근하고 외부에서 선택적인 로컬 호스트에 대한 접근을 가능하게 할 것이다. 주로 내부 사용을 위해 네트워크가 설정되어 있고 가끔 외부 접근이 필요한 조직은 이 체계의 좋은 후보이다.

많은 소규모 사무실, 홈 오피스(SOHO) 사용자와 재택근무 직원은 사무실에 TCP/UDP 애플리케이션을 실행하는 여러 네트워크 노드를 가지고 있지만, 원격 네트워크에 접근하기 위해 서비스 제공업체로부터 원격 접근 라우터에 할당된 단일 IP 주소만 가지고 있다. 이 계속 증가하는 원격 접근 사용자 커뮤니티는 NAPT의 혜택을 받을 것이며, NAPT는 로컬 네트워크의 여러 노드가 라우터에 할당된 단일 IP 주소를 사용하여 원격 네트워크에 동시에 접근할 수 있게 해준다.

변환 방법을 사용하는 데는 제한이 있다. 세션에 관련된 모든 요청과 응답이 동일한 NAT 라우터를 통해 라우팅되어야 한다는 것이 필수이다. 이를 확인하는 한 가지 방법은 모든 IP 패킷이 도메인에서 발생하거나 도메인으로 향하는 스텁 도메인에 고유한 경계 라우터를 기반으로 NAT를 사용하는 것이다. 여러 NAT 장치로 이를 보장하는 다른 방법도 있다. 예를 들어, 사설 도메인은 다른 제공업체로의 두 개의 별개의 출구 지점을 가질 수 있으며, 사설 네트워크의 호스트로부터의 세션 흐름은 외부 호스트에 대해 가장 좋은 메트릭을 가진 NAT 장치를 통해 통과할 수 있다. NAT 라우터 중 하나가 실패하면, 다른 라우터가 모든 연결에 대한 트래픽을 라우팅할 수 있다. 그러나 이 접근 방식에는 주의할 점이 있는데, 재라우팅된 흐름이 새 NAT 라우터로의 전환 시점에 실패할 수 있다는 것이다. 이 잠재적인 문제를 극복하는 방법은 라우터가 동일한 NAT 구성을 공유하고 상태 정보를 교환하여 서로에 대한 안전한 백업을 보장하는 것이다.

주소 변환은 애플리케이션에 독립적이며 종종 페이로드 모니터링과 변경을 수행하는 애플리케이션별 게이트웨이(ALG)를 동반한다. FTP는 NAT 장치에 상주하는 가장 인기 있는 ALG이다. ALG 개입이 필요한 애플리케이션은 페이로드가 인코딩되어서는 안 되는데, 그렇게 하면 ALG가 페이로드를 복호화할 키를 가지고 있지 않는 한 ALG를 효과적으로 비활성화하기 때문이다.

이 솔루션은 IP 주소의 종단 간 의미를 빼앗고 네트워크에서 증가된 상태로 보상하는 단점이 있다. 결과적으로, NAT 장치가 경로 중에 있으면 IPSec에 의해 보장되는 종단 간 IP 네트워크 수준 보안이 종단 호스트에 적용된다고 가정할 수 없다. 그러나 이 접근 방식의 장점은 호스트나 라우터를 변경하지 않고 설치할 수 있다는 것이다.

"주소 영역", "투명 라우팅", "TU 포트", "ALG" 등 이 문서 전반에 걸쳐 사용되는 용어의 정의는 [NAT-TERM]에서 찾을 수 있다.

## 2. 전통적인 NAT 개요

이 문서에 제시된 주소 변환 동작을 "전통적인 NAT"라고 한다. 이 문서에서 탐구하지 않을 NAT의 다른 변형이 있다. 전통적인 NAT는 대부분의 경우 사설 네트워크 내의 호스트가 외부 네트워크의 호스트에 투명하게 접근할 수 있게 해준다. 전통적인 NAT에서 세션은 단방향으로, 사설 네트워크에서 외부로 향한다. 반대 방향의 세션은 미리 선택된 호스트에 대한 정적 주소 매핑을 사용하여 예외적으로 허용될 수 있다. 기본 NAT와 NAPT는 전통적인 NAT의 두 가지 변형으로, 기본 NAT에서의 변환은 IP 주소로만 제한되는 반면, NAPT에서의 변환은 IP 주소와 전송 식별자(예: TCP/UDP 포트 또는 ICMP 쿼리 ID)를 포함하도록 확장된다.

달리 언급되지 않는 한, 이 문서 전반에 걸친 주소 변환 또는 NAT는 전통적인 NAT, 즉 기본 NAT와 NAPT를 모두 의미한다. 아래 그림 1에 설명된 스텁 경계 라우터만 주소 변환을 수행하도록 구성될 수 있다.

```
        \ | /                 .                                /
   +---------------+  WAN     .           +-----------------+/
   |Regional Router|----------------------|Stub Router w/NAT|---
   +---------------+          .           +-----------------+\
                              .                      |         \
                              .                      |  LAN
                              .               ---------------
                        Stub border

            그림 1: 전통적인 NAT 구성
```

### 2.1 기본 NAT 개요

기본 NAT 동작은 다음과 같다. 사설 네트워크 주소 집합을 가진 스텁 도메인은 사설 주소 집합을 전역적으로 유효한 네트워크 주소 집합에 동적으로 매핑하여 외부 네트워크와 통신할 수 있게 된다. 로컬 노드의 수가 전역 집합의 주소보다 적거나 같으면, 각 로컬 주소에는 매핑할 전역 주소가 보장된다. 그렇지 않으면, 외부 네트워크에 동시에 접근할 수 있는 노드가 전역 집합의 주소 수로 제한된다. 개별 로컬 주소는 외부에 대한 보장된 접근을 보장하거나 고정 공용 주소를 통해 외부 호스트에서 로컬 호스트에 대한 접근을 허용하기 위해 특정 전역 주소에 정적으로 매핑될 수 있다. 동일한 주소 매핑을 사용하여 로컬 노드에서 여러 개의 동시 세션을 시작할 수 있다.

스텁 도메인 내의 주소는 해당 도메인에 로컬이며 도메인 외부에서는 유효하지 않다. 따라서 스텁 도메인 내의 주소는 다른 스텁 도메인에서 재사용할 수 있다. 예를 들어, 단일 클래스 A 주소를 많은 스텁 도메인에서 사용할 수 있다. 스텁 도메인과 백본 사이의 각 출구 지점에 NAT가 설치된다. 출구 지점이 둘 이상인 경우 각 NAT가 동일한 변환 테이블을 가지는 것이 매우 중요하다.

예를 들어, 그림 2의 예에서 스텁 A와 B는 모두 내부적으로 클래스 A 사설 주소 블록 10.0.0.0/8 [RFC 1918]을 사용한다. 스텁 A의 NAT에는 클래스 C 주소 블록 198.76.29.0/24가 할당되고, 스텁 B의 NAT에는 클래스 C 주소 블록 198.76.28.0/24가 할당된다. 클래스 C 주소는 전역적으로 고유하므로 다른 NAT 박스에서 사용할 수 없다.

```
                                    \ | /
                                  +---------------+
                                  |Regional Router|
                                  +---------------+
                                WAN |           | WAN
                                    |           |
                Stub A .............|....   ....|............ Stub B
                                    |           |
                  {s=198.76.29.7,^  |           |  v{s=198.76.29.7,
                   d=198.76.28.4}^  |           |  v d=198.76.28.4}
                    +-----------------+       +-----------------+
                    |Stub Router w/NAT|       |Stub Router w/NAT|
                    +-----------------+       +-----------------+
                          |                         |
                          |  LAN               LAN  |
                    -------------             -------------
                              |                 |
            {s=10.33.96.5, ^  |                 |  v{s=198.76.29.7,
             d=198.76.28.4}^ +--+             +--+ v d=10.81.13.22}
                             |--|             |--|
                            /____\           /____\
                          10.33.96.5       10.81.13.22

                      그림 2: 기본 NAT 동작
```

스텁 A 호스트 10.33.96.5가 스텁 B 호스트 10.81.13.22에 패킷을 보내려고 할 때, 전역적으로 고유한 주소 198.76.28.4를 목적지로 사용하고 패킷을 기본 라우터로 보낸다. 스텁 라우터는 네트워크 198.76.0.0에 대한 정적 경로가 있으므로 패킷이 WAN 링크로 전달된다. 그러나 NAT는 패킷이 전달되기 전에 IP 헤더의 출발지 주소 10.33.96.5를 전역적으로 고유한 198.76.29.7로 변환한다. 마찬가지로, 반환 경로의 IP 패킷도 유사한 주소 변환을 거친다.

이것은 호스트나 라우터에 변경이 필요하지 않다는 점에 주목하라. 예를 들어, 스텁 A 호스트가 관심 있는 한, 198.76.28.4는 스텁 B의 호스트가 사용하는 주소이다. 주소 변환은 대부분의 경우 종단 호스트에게 투명하다. 물론 이것은 단순한 예일 뿐이다. 탐구해야 할 수많은 문제가 있다.

### 2.2. NAPT 개요

조직이 사설 IP 네트워크와 서비스 제공업체에 대한 WAN 링크를 가지고 있다고 가정하자. 사설 네트워크의 스텁 라우터에는 WAN 링크에서 전역적으로 유효한 주소가 할당되고 조직의 나머지 노드는 로컬 의미만 가지는 IP 주소를 가진다. 이러한 경우, 사설 네트워크의 노드는 NAPT의 도움으로 단일 등록된 IP 주소를 사용하여 외부 네트워크에 동시에 접근할 수 있다. NAPT는 (로컬 IP 주소, 로컬 TU 포트 번호) 유형의 튜플을 (등록된 IP 주소, 할당된 TU 포트 번호) 유형의 튜플로 매핑할 수 있게 해준다.

이 모델은 대부분의 소규모 사무실 홈 오피스(SOHO) 그룹이 서비스 제공업체가 할당한 단일 IP 주소를 사용하여 외부 네트워크에 접근하는 요구사항에 적합하다. 이 모델은 등록된 IP 주소의 각 서비스 TU 포트당 로컬 노드를 정적으로 매핑하여 인바운드 접근을 허용하도록 확장될 수 있다.

아래 그림 3의 예에서, 스텁 A는 내부적으로 클래스 A 주소 블록 10.0.0.0/8을 사용한다. 스텁 라우터의 WAN 인터페이스에는 서비스 제공업체가 IP 주소 138.76.28.4를 할당한다.

```
                                     \ | /
                                   +-----------------------+
                                   |Service Provider Router|
                                   +-----------------------+
                                 WAN |
                                     |
                 Stub A .............|....
                                     |
         ^{s=138.76.28.4,sport=1024, |  v{s=138.76.29.7, sport = 23,
         ^ d=138.76.29.7,dport=23}   |  v d=138.76.28.4, dport = 1024}
                         +------------------+
                         |Stub Router w/NAPT|
                         +------------------+
                           |
                           |  LAN
     --------------------------------------------
        |        ^{s=10.0.0.10,sport=3017, |  v{s=138.76.29.7, sport=23,
        |        ^ d=138.76.29.7,dport=23} |  v d=10.0.0.10, dport=3017}
        |                                  |
       +--+      +--+                    +--+
       |--|      |--|                    |--|
      /____\    /____\                  /____\
     10.0.0.1  10.0.0.2   .....        10.0.0.10

      그림 3: 네트워크 주소 포트 변환(NAPT) 동작
```

스텁 A 호스트 10.0.0.10이 호스트 138.76.29.7에 텔넷 패킷을 보낼 때, 전역적으로 고유한 주소 138.76.29.7을 목적지로 사용하고 패킷을 기본 라우터로 보낸다. 스텁 라우터는 서브넷 138.76.0.0/16에 대한 정적 경로가 있으므로 패킷이 WAN 링크로 전달된다. 그러나 NAPT는 패킷이 전달되기 전에 IP 및 TCP 헤더의 출발지 주소 10.0.0.10과 출발지 TCP 포트 3017의 튜플을 전역적으로 고유한 138.76.28.4와 고유하게 할당된 TCP 포트, 예를 들어 1024로 변환한다. 반환 경로의 패킷은 대상 IP 주소와 대상 TCP 포트에 대해 유사한 주소 및 TCP 포트 변환을 거친다. 다시 한번, 이것은 호스트나 라우터에 변경이 필요하지 않다는 점에 주목하라. 변환은 완전히 투명하다.

이 설정에서는 TCP/UDP 세션만 허용되며 로컬 네트워크에서 시작되어야 한다. 그러나 DNS와 같이 인바운드 접근이 필요한 서비스가 있다. 조직이 인바운드 세션 접근을 허용하려는 다른 서비스도 있을 수 있다. 스텁 라우터에서 잘 알려진 TU 포트 서비스 [RFC 1700]를 사설 네트워크의 특정 노드로 향하도록 정적으로 구성할 수 있다.

TCP/UDP 세션 외에도, REDIRECT 메시지 유형을 제외한 ICMP 메시지도 NAPT 라우터에 의해 모니터링될 수 있다. ICMP 쿼리 유형 패킷은 TCP/UDP 패킷과 유사하게 변환되는데, ICMP 메시지 헤더의 식별자 필드가 등록된 IP 주소의 쿼리 식별자에 고유하게 매핑된다. ICMP 쿼리 메시지의 식별자 필드는 쿼리 송신자에 의해 설정되고 쿼리 응답자의 응답 메시지에서 변경되지 않고 반환된다. 따라서 (로컬 IP 주소, 로컬 ICMP 쿼리 식별자)의 튜플은 로컬 호스트의 모든 유형의 ICMP 쿼리를 고유하게 식별하기 위해 NAPT 라우터에 의해 (등록된 IP 주소, 할당된 ICMP 쿼리 식별자)의 튜플로 매핑된다. ICMP 오류 메시지에 대한 수정은 ICMP 페이로드와 IP 및 ICMP 헤더에 대한 수정을 포함하므로 이후 섹션에서 논의된다.

등록된 IP 주소가 스텁 라우터 WAN 인터페이스의 IP 주소와 동일한 NAPT 설정에서, 라우터는 자체에서 시작된 TCP, UDP 또는 ICMP 쿼리 세션과 로컬 네트워크의 노드에서 시작된 것을 구별해야 한다. 모든 인바운드 세션(TCP, UDP 및 ICMP 쿼리 세션 포함)은 대상 서비스 포트가 로컬 네트워크의 다른 노드에 정적으로 매핑되지 않는 한 NAT 라우터를 종단 노드로 하는 것으로 가정된다.

TCP, UDP 및 ICMP 쿼리 유형 이외의 세션은 NAPT 라우터가 서비스하는 로컬 노드에서 허용되지 않는다.

## 3.0. 세션의 변환 단계

전통적인 NAT와의 변환 단계는 [NAT-TERM]에서 설명한 것과 동일하다. 다음 하위 섹션에서는 전통적인 NAT에 특정한 항목을 식별한다.

### 3.1. 주소 바인딩:

기본 NAT에서, 첫 번째 아웃바운드 세션이 사설 호스트에서 시작될 때 사설 주소가 외부 주소에 바인딩된다. 그 이후에, 동일한 사설 주소에서 시작되는 다른 모든 아웃바운드 세션은 패킷 변환을 위해 동일한 주소 바인딩을 사용한다.

NAPT의 경우, 많은 사설 주소가 단일 전역적으로 고유한 주소에 매핑되며, 바인딩은 (사설 주소, 사설 TU 포트)의 튜플에서 (할당된 주소, 할당된 TU 포트)의 튜플로 이루어진다. 기본 NAT와 마찬가지로, 이 바인딩은 첫 번째 아웃바운드 세션이 사설 호스트의 (사설 주소, 사설 TU 포트) 튜플에 의해 시작될 때 결정된다. 일반적인 관행은 아니지만, 사설 호스트의 애플리케이션이 동일한 (사설 주소, 사설 TU 포트) 튜플에서 시작되는 여러 개의 동시 세션을 설정하는 것이 가능하다. 그러한 경우, (사설 주소, 사설 TU 포트) 튜플에 대한 단일 바인딩이 호스트의 동일한 튜플에서 시작되는 모든 세션에 관련된 패킷의 변환에 사용될 수 있다.

### 3.2. 주소 조회 및 변환:

주소 바인딩 또는 NAPT의 경우 (주소, TU 포트) 튜플 바인딩이 설정된 후, 바인딩을 사용하는 각 연결에 대해 소프트 상태가 유지될 수 있다. 동일한 세션에 속하는 패킷은 변환 목적으로 세션 조회의 대상이 된다. 변환의 정확한 특성은 다음 섹션에서 논의된다.

### 3.3. 주소 언바인딩:

주소 또는 (주소, TU 포트) 튜플 바인딩을 기반으로 하는 마지막 세션이 종료되면, 바인딩 자체가 종료될 수 있다.

## 4.0. 패킷 변환

NAT 관리 세션에 관련된 패킷은 양방향으로 변환을 거친다. 개별 패킷 변환 문제는 다음 하위 섹션에서 자세히 다룬다.

### 4.1. IP, TCP, UDP 및 ICMP 헤더 조작

기본 NAT 모델에서, 모든 패킷의 IP 헤더를 수정해야 한다. 이 수정에는 IP 주소(아웃바운드 패킷의 경우 출발지 IP 주소, 인바운드 패킷의 경우 목적지 IP 주소)와 IP 체크섬이 포함된다.

TCP ([TCP]) 및 UDP ([UDP]) 세션의 경우, 수정에는 TCP/UDP 헤더의 체크섬 업데이트가 포함되어야 한다. 이는 TCP/UDP 체크섬이 출발지 및 목적지 IP 주소를 포함하는 의사 헤더도 커버하기 때문이다. 예외로, 체크섬이 0인 UDP 헤더는 수정되어서는 안 된다. ICMP 쿼리 패킷 ([ICMP])의 경우, ICMP 헤더의 체크섬이 IP 주소를 커버하지 않으므로 ICMP 헤더에 추가 변경이 필요하지 않다.

NAPT 모델에서, IP 헤더에 대한 수정은 기본 NAT와 유사하다. TCP/UDP 세션의 경우, 수정은 TCP/UDP 헤더의 TU 포트 변환(아웃바운드 패킷의 경우 출발지 TU 포트, 인바운드 패킷의 경우 목적지 TU 포트)을 포함하도록 확장되어야 한다. ICMP 쿼리 패킷의 ICMP 헤더도 쿼리 ID와 ICMP 헤더 체크섬을 교체하도록 수정되어야 한다. 사설 호스트 쿼리 ID는 아웃바운드에서 할당된 ID로 변환되어야 하고 인바운드에서는 정확히 반대로 변환되어야 한다. ICMP 헤더 체크섬은 쿼리 ID 변환을 반영하도록 수정되어야 한다.

### 4.2. 체크섬 조정

NAT 수정은 패킷 기반이며 단순한 필드 변환 외에도 하나 이상의 체크섬 수정을 포함하므로 매우 계산 집약적일 수 있다. 다행히, 아래 알고리즘은 IP, TCP, UDP 및 ICMP 헤더에 대한 체크섬 조정을 매우 간단하고 효율적으로 만든다. 이러한 모든 헤더가 1의 보수 합을 사용하므로, 변환 전과 변환 후 주소 간의 산술 차이를 계산하고 이를 체크섬에 더하면 된다. 아래 알고리즘은 짝수 오프셋(즉, 아래의 optr이 헤더 시작에서 짝수 오프셋에 있어야 함)과 짝수 길이(즉, 아래의 olen과 nlen이 짝수여야 함)에 대해서만 적용 가능하다. 이에 대한 샘플 코드(C)는 다음과 같다.

```c
void checksumadjust(unsigned char *chksum, unsigned char *optr,
int olen, unsigned char *nptr, int nlen)
/* 가정: unsigned char는 8비트, long은 32비트.
  - chksum은 패킷의 체크섬을 가리킴
  - optr은 패킷의 이전 데이터를 가리킴
  - nptr은 패킷의 새 데이터를 가리킴
*/
{
  long x, old, new;
  x=chksum[0]*256+chksum[1];
  x=~x & 0xFFFF;
  while (olen)
  {
      old=optr[0]*256+optr[1]; optr+=2;
      x-=old & 0xffff;
      if (x<=0) { x--; x&=0xffff; }
      olen-=2;
  }
  while (nlen)
  {
      new=nptr[0]*256+nptr[1]; nptr+=2;
      x+=new & 0xffff;
      if (x & 0x10000) { x++; x&=0xffff; }
      nlen-=2;
  }
  x=~x & 0xFFFF;
  chksum[0]=x/256; chksum[1]=x & 0xff;
}
```

### 4.3. ICMP 오류 패킷 수정

ICMP 오류 메시지 ([ICMP])에 대한 변경은 외부 계층의 IP 및 ICMP 헤더에 대한 변경뿐만 아니라 ICMP 오류 메시지 페이로드 내에 포함된 패킷의 헤더에 대한 변경도 포함한다.

NAT가 종단 호스트에게 투명하려면, ICMP 오류 메시지의 페이로드 내에 포함된 IP 헤더의 IP 주소를 수정해야 하고, 포함된 IP 헤더의 체크섬 필드를 수정해야 하며, 마지막으로 페이로드에 대한 변경을 반영하도록 ICMP 헤더 체크섬도 수정해야 한다.

NAPT 설정에서, ICMP 내에 포함된 IP 메시지가 TCP, UDP 또는 ICMP 쿼리 패킷인 경우, TCP/UDP 헤더 내의 적절한 TU 포트 번호 또는 ICMP 쿼리 헤더의 쿼리 식별자 필드도 수정해야 한다.

마지막으로, ICMP 패킷의 IP 헤더도 수정해야 한다.

### 4.4. FTP 지원

가장 인기 있는 애플리케이션 중 하나인 "FTP" ([FTP])는 제어 세션 페이로드를 모니터링하여 이어지는 데이터 세션 매개변수를 결정하기 위해 ALG가 필요하다. FTP ALG는 대부분의 NAT 구현에서 필수적인 부분이다.

FTP ALG는 출발지 포트가 FTP이거나 목적지 포트가 FTP인 TCP 시퀀스 및 확인 응답 번호를 수정하기 위한 특별한 테이블이 필요하다. 테이블 항목에는 출발지 주소, 목적지 주소, 출발지 포트, 목적지 포트, 시퀀스 번호에 대한 델타 및 타임스탬프가 있어야 한다. 새 항목은 FTP PORT 명령이나 PASV 응답이 감지될 때만 생성된다. 시퀀스 번호 델타는 모든 FTP PORT 명령이나 PASV 응답에 대해 증가하거나 감소할 수 있다. 시퀀스 번호는 아웃바운드에서 이 델타만큼 증가하고 확인 응답 번호는 인바운드에서 이 델타만큼 감소한다.

FTP 페이로드 변환은 기본 NAT의 경우 사설 주소와 할당된 외부 주소(ASCII로 개별 옥텟으로 인코딩됨)로 제한된다. 그러나 NAPT 설정의 경우, 변환은 주소 옥텟 다음의 TCP 포트 옥텟(ASCII)을 포함하도록 확장되어야 한다.

### 4.5 DNS 지원

전통적인 NAT의 세션이 주로 사설 도메인에서 아웃바운드라는 점을 고려하면, DNS ALG는 다음과 같이 전통적인 NAT와 함께 사용하지 않아도 될 수 있다. 사설 도메인 내부의 DNS 서버는 내부 호스트와 가능하면 일부 외부 호스트에 대한 이름-IP 주소 매핑을 유지한다. 외부 DNS 서버는 외부 호스트에 대한 이름 매핑만 유지하고 내부 호스트에 대해서는 유지하지 않는다. 사설 네트워크에 내부 DNS 서버가 없는 경우, 모든 DNS 요청을 외부 DNS 서버로 보내 외부 호스트에 대한 주소 매핑을 찾을 수 있다.

### 4.6. IP 옵션 처리

Record Route, Strict Source Route 또는 Loose Source Route IP 옵션이 있는 IP 데이터그램은 중간 라우터의 IP 주소를 기록하거나 사용하는 것을 포함한다. NAT 중간 라우터는 이러한 옵션을 지원하지 않거나 옵션을 처리하는 동안 주소를 변환하지 않고 남겨둘 수 있다. 주소를 변환하지 않고 남겨두면 소스 경로를 따라 사설 주소가 종단 간에 노출된다. 각 라우터가 다음 홉 라우터만 봐야 하므로 이것이 패킷의 통과 경로 자체를 위태롭게 해서는 안 된다.

## 5. 기타 문제

### 5.1. 로컬 및 전역 주소의 분할

이 문서에서 설명한 대로 NAT가 작동하려면, IP 주소 공간을 두 부분으로 분할해야 한다 - 스텁 도메인 내부에서 사용되는 사설 주소와 전역적으로 고유한 주소. 주어진 주소는 사설 주소이거나 전역 주소여야 한다. 중복은 없다.

중복의 문제는 다음과 같다. 스텁 A의 호스트가 스텁 B의 호스트에 패킷을 보내려고 하는데, 스텁 B의 전역 주소가 스텁 A의 사설 주소와 겹친다고 가정하자. 이 경우, 스텁 A의 라우터는 스텁 B의 전역 주소를 자신의 사설 주소와 구별할 수 없다.

### 5.2. 사설 주소 공간 권장사항

[RFC 1918]은 사설 네트워크에 대한 주소 공간 할당에 대한 권장사항을 제공한다. 인터넷 할당 번호 기관(IANA)은 사설 인터넷을 위해 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16의 세 블록의 IP 주소 공간을 가지고 있다. CIDR 이전 표기법에서, 첫 번째 블록은 단일 클래스 A 네트워크 번호에 불과하고, 두 번째 블록은 16개의 연속된 클래스 B 네트워크의 집합이며, 세 번째 블록은 256개의 연속된 클래스 C 네트워크의 집합이다.

위에서 정의된 주소 공간의 IP 주소를 사용하기로 결정한 조직은 IANA 또는 인터넷 레지스트리와의 어떠한 조정 없이도 그렇게 할 수 있다. 따라서 이 주소 공간은 경계 라우터에서 NAT 동작이 활성화된 채로 많은 독립적인 조직에서 동시에 비공개로 사용될 수 있다.

### 5.3. NAT를 통한 라우팅

NAT를 실행하는 라우터는 사설 네트워크를 백본에 광고해서는 안 된다. 전역 주소를 가진 네트워크만 스텁 외부에서 알려질 수 있다. 그러나 NAT가 스텁 경계 라우터에서 수신하는 전역 정보는 일반적인 방식으로 스텁에서 광고될 수 있다.

일반적으로, NAT 스텁 라우터는 모든 외부 트래픽을 WAN 링크를 통해 서비스 제공업체 라우터로 전달하도록 구성된 정적 경로를 가지며, 서비스 제공업체 라우터는 NAT 패킷(즉, 목적지 IP 주소가 NAT 관리 전역 주소 목록 범위 내에 속하는 패킷)을 WAN 링크를 통해 NAT 라우터로 전달하도록 구성된 정적 경로를 가진다.

### 5.4. 기본 NAT에서 NAPT로의 전환

기본 NAT 설정에서, 사설 네트워크 노드 수가 매핑에 사용 가능한 전역 주소 수를 초과하면(예: 클래스 B 사설 네트워크가 클래스 C 전역 주소 블록에 매핑됨), 주소 목록의 마지막 전역 주소가 사용된 후 일부 로컬 노드에 대한 외부 네트워크 접근이 갑자기 차단된다. 이것은 매우 불편하고 제약적이다. 이러한 사건은 기본 NAT 라우터가 주소 목록의 마지막 전역 주소에 대해 NAPT 설정으로 전환하도록 선택적으로 허용함으로써 안전하게 피할 수 있다. 이렇게 하면 사설 네트워크의 호스트가 대부분의 애플리케이션에서 외부 노드 및 서비스에 대한 지속적이고 중단 없는 접근을 가질 수 있다. 그러나 기본 NAT에서 작동하던 일부 애플리케이션이 NAPT로의 전환으로 인해 갑자기 작동하지 않으면 혼란스러울 수 있다.

## 6.0. NAT 제한사항

[NAT-TERM]은 NAT의 모든 유형에 대한 제한사항을 광범위하게 다룬다. 다음 하위 섹션에서는 전통적인 NAT에 특정한 제한사항을 식별한다.

### 6.1. 프라이버시와 보안

전통적인 NAT는 세션이 사설 호스트에서 단방향이고 사설 호스트의 실제 주소가 외부 호스트에게 보이지 않으므로 프라이버시 메커니즘을 제공하는 것으로 볼 수 있다.

프라이버시를 강화하는 동일한 특성이 잠재적으로 문제(보안 위반 포함) 디버깅을 더 어렵게 만든다. 사설 네트워크의 호스트가 어떤 방식으로든 인터넷을 남용하고 있다면(예: 다른 기계를 공격하려고 하거나 대량의 스팸을 보내는 경우), 호스트의 IP 주소가 NAT 라우터에 숨겨져 있기 때문에 실제 문제 원인을 추적하기가 더 어렵다.

### 6.2. LAN 인터페이스에서 NAT 매핑된 전역 주소에 대한 ARP 응답

NAT는 스텁 도메인의 경계 라우터에서만 활성화되어야 한다. 기본 NAT와 NAPT를 설명하기 위해 문서에서 제공된 예는 NAT 라우터에서 외부 라우터(즉, 서비스 제공업체 라우터)로의 연결을 위한 WAN 링크를 유지했다. 그러나 WAN 링크가 LAN 연결로 대체되고 NAT 매핑에 사용되는 전역 주소 공간의 일부 또는 전체가 LAN 세그먼트와 동일한 IP 서브넷에 속하는 경우, NAT 라우터는 동일한 서브넷에 속하는 주소 범위에 대한 ARP 지원을 제공할 것으로 예상된다. 기본 NAT 설정에서 그러한 상황에서는 NAT 매핑된 전역 주소에 대한 ARP 요청에 자체 MAC 주소로 응답하는 것이 필수이다. NAT 라우터가 이러한 요청에 응답하지 않으면, 네트워크에서 이러한 주소의 소유권을 가진 다른 노드가 없으므로 응답되지 않는다.

이 시나리오는 NAPT 설정에서는 NAPT 매핑에 사용된 단일 주소가 NAT 라우터의 인터페이스 주소가 아닌 경우(예: 위의 5.4에서 설명한 기본 NAT에서 NAPT로의 전환의 경우)를 제외하고는 가능성이 낮다.

직접 연결된 서브넷의 주소 범위를 NAT 주소 매핑에 사용하면 서비스 제공업체 라우터에서의 정적 경로 구성이 불필요해진다.

저자들의 의견으로는 서비스 제공업체 라우터에 대한 LAN 링크는 매우 일반적이지 않다. 그러나 벤더는 만약을 위해 프록시 ARP를 선택적으로 지원하는 데 관심이 있을 수 있다.

### 6.3. NAPT 설정에서 아웃바운드 TCP/UDP 단편화 패킷 변환

NAPT 설정에서 아웃바운드 TCP/UDP 단편(즉, 사설 호스트에서 발생하는 것)의 변환은 실패할 운명이다. 이유는 다음과 같다. 첫 번째 단편만 변환 목적으로 패킷을 세션과 연결하는 데 필요한 TCP/UDP 헤더를 포함한다. 후속 단편은 TCP/UDP 포트 정보를 포함하지 않고 단순히 첫 번째 단편에 지정된 것과 동일한 단편화 식별자를 전달한다. 두 사설 호스트가 동일한 목적지 호스트로 단편화된 TCP/UDP 패킷을 발생시켰다고 가정하자. 그리고 그들이 동일한 단편화 식별자를 사용했다고 하자. 대상 호스트가 동일한 단편화 ID를 전달하고 동일한 할당된 호스트 주소에서 오는 두 개의 관련 없는 데이터그램을 수신하면, 두 데이터그램이 어느 세션에 속하는지 결정할 수 없다. 결과적으로 두 세션 모두 손상된다.

## 7.0. 현재 구현

이 문서에서 제공된 NAT 설명을 준수하는 많은 상업적 구현이 업계에서 이용 가능하다. Linux 공개 도메인 소프트웨어는 "IP masquerade"라는 이름으로 NAT를 포함한다. FreeBSD 공개 도메인 소프트웨어는 데몬으로 실행되는 NAPT 구현을 가지고 있다. 그러나 Linux 소스는 GNU 라이선스에 의해 적용되고 FreeBSD 소프트웨어는 UC Berkeley 라이선스에 의해 적용된다.

Linux와 FreeBSD 소프트웨어 모두 무료이므로 배포 비용보다 약간 더 많은 비용으로 CD-ROM을 구매할 수 있다. 또한 최신 패치와 함께 많은 FTP 사이트에서 온라인으로 이용 가능하다.

## 8.0. 보안 고려사항

[NAT-TERM]에서 NAT의 모든 변형에 대해 설명된 보안 고려사항은 전통적인 NAT에 적용된다.

## 참조

[NAT-TERM] Srisuresh, P. and M. Holdrege, "IP Network Address Translator (NAT) Terminology and Considerations", RFC 2663, August 1999.

[RFC 1918] Rekhter, Y., Moskowitz, B., Karrenberg, D., de Groot, G. and E. Lear, "Address Allocation for Private Internets", BCP 5, RFC 1918, February 1996.

[RFC 1700] Reynolds, J. and J. Postel, "Assigned Numbers", STD 2, RFC 1700, October 1994.

[RFC 1122] Braden, R., "Requirements for Internet Hosts -- Communication Layers", STD 3, RFC 1122, October 1989.

[RFC 1123] Braden, R., "Requirements for Internet Hosts -- Application and Support", STD 3, RFC 1123, October 1989.

[RFC 1812] Baker, F., "Requirements for IP Version 4 Routers", RFC 1812, June 1995.

[FTP] Postel, J. and J. Reynolds, "FILE TRANSFER PROTOCOL (FTP)", STD 9, RFC 959, October 1985.

[TCP] Defense Advanced Research Projects Agency Information Processing Techniques Office, "TRANSMISSION CONTROL PROTOCOL (TCP) SPECIFICATION", STD 7, RFC 793, September 1981.

[ICMP] Postel, J., "INTERNET CONTROL MESSAGE (ICMP) SPECIFICATION", STD 5, RFC 792, September 1981.

[UDP] Postel, J., "User Datagram Protocol (UDP)", STD 6, RFC 768, August 1980.

[RFC 2101] Carpenter, B., Crowcroft, J. and Y. Rekhter, "IPv4 Address Behaviour Today", RFC 2101, February 1997.

## 저자 주소

Pyda Srisuresh
Jasmine Networks, Inc.
3061 Zanker Road, Suite B
San Jose, CA 95134
U.S.A.

Phone: (408) 895-5032
EMail: srisuresh@yahoo.com


Kjeld Borch Egevang
Intel Denmark ApS

Phone: +45 44886556
Fax:   +45 44886051
EMail: kjeld.egevang@intel.com
http:  //www.freeyellow.com/members/kbe

## 전체 저작권 선언

Copyright (C) The Internet Society (2001). All Rights Reserved.

이 문서와 이 문서의 번역본은 복사되어 타인에게 제공될 수 있으며, 이 문서에 대해 논평하거나 달리 설명하거나 구현을 지원하는 파생 저작물은 어떤 종류의 제한 없이 전체 또는 일부로 작성, 복사, 출판 및 배포될 수 있다. 단, 위의 저작권 고지와 이 단락이 그러한 모든 복사본과 파생 저작물에 포함되어야 한다. 그러나 이 문서 자체는 인터넷 표준 개발 목적으로 저작권에 대해 정의된 절차를 따라야 하는 경우를 제외하고는, 또는 영어 이외의 언어로 번역하기 위해 필요한 경우를 제외하고는, 저작권 고지를 제거하거나 Internet Society 또는 기타 인터넷 조직에 대한 참조를 제거하는 등의 어떤 방식으로도 수정될 수 없다.

위에서 부여된 제한된 권한은 영구적이며 Internet Society 또는 그 후계자나 양수인에 의해 철회되지 않는다.

이 문서와 여기에 포함된 정보는 "있는 그대로" 제공되며, THE INTERNET SOCIETY AND THE INTERNET ENGINEERING TASK FORCE는 여기의 정보 사용이 어떤 권리도 침해하지 않을 것이라는 보증 또는 상품성이나 특정 목적에의 적합성에 대한 묵시적 보증을 포함하되 이에 국한되지 않는 모든 명시적 또는 묵시적 보증을 부인한다.

## 감사의 글

RFC 편집자 기능에 대한 자금은 현재 Internet Society에 의해 제공된다.
