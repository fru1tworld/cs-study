# RFC 9568 - Virtual Router Redundancy Protocol (VRRP) Version 3

> 발행일: 2024년 4월
> 대체 문서: RFC 5798
> 상태: Standards Track

## 1. 개요

RFC 9568은 로컬 영역 네트워크(LAN)에서 IPv4 및 IPv6 라우터에 대한 이중화를 제공하는 VRRP 버전 3을 정의합니다. 이 명세는 RFC 5798을 폐기하며, 포용적 언어와 기술적 명확화를 위한 상당한 업데이트를 포함합니다.

### VRRP가 제공하는 핵심 기능

| 기능 | 설명 |
|------|------|
| 동적 장애조치 | 활성 라우터 장애 시 백업 라우터가 자동으로 책임 인수 |
| 가상 IP 주소 | 호스트는 실제 라우터 주소 대신 가상 주소를 게이트웨이로 사용 |
| 선출 프로토콜 | 우선순위 기반으로 활성 라우터 결정 |

### 핵심 동작 원리

```
VRRP는 "LAN 상의 VRRP 라우터들 중 하나에게
가상 라우터의 책임을 동적으로 할당하는 선출 프로토콜"

활성 라우터(Active Router):
- 가상 IPv4/IPv6 주소로 향하는 패킷 전달
- ARP/ND 요청에 응답
- 주기적인 VRRP 광고 전송

백업 라우터(Backup Router):
- 활성 라우터 모니터링
- 장애 발생 시 책임 인수 준비
```

## 2. 패킷 형식

### 2.1 VRRP 패킷 구조

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version| Type  | Virtual Rtr ID|   Priority    |Count IPvX Addr|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|(rsvd) |     Max Adver Int     |          Checksum             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                       IPvX Address(es)                        |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 2.2 필드 설명

| 필드 | 크기 | 설명 |
|------|------|------|
| Version | 4비트 | VRRP 프로토콜 버전 (3) |
| Type | 4비트 | 패킷 유형 (1 = ADVERTISEMENT) |
| Virtual Rtr ID (VRID) | 8비트 | 가상 라우터 식별자 (1-255) |
| Priority | 8비트 | 라우터 우선순위 (0-255) |
| Count IPvX Addr | 8비트 | 패킷 내 IP 주소 수 |
| Max Adver Int | 12비트 | 광고 간격 (센티초 단위) |
| Checksum | 16비트 | 패킷 검증용 체크섬 |

### 2.3 우선순위 값

```
Priority 값의 의미:

255: 가상 IP 주소의 소유자 (가장 높은 우선순위)
     - 즉시 활성 상태로 전환
     - 다른 라우터보다 항상 우선

1-254: 일반 VRRP 라우터
     - 높은 값 = 높은 우선순위
     - 기본값: 100

0: 현재 활성 라우터의 폐기 신호
   - 빠른 장애조치 트리거
   - 백업 라우터들이 즉시 선출 시작
```

## 3. IPv4 및 IPv6 구성

### 3.1 IPv4 구성

| 항목 | 값 |
|------|-----|
| 프로토콜 번호 | 112 (IANA 할당) |
| 멀티캐스트 주소 | 224.0.0.18 |
| TTL | 255 (필수) |
| 출발지 주소 | 기본 인터페이스 IPv4 주소 |

### 3.2 IPv6 구성

| 항목 | 값 |
|------|-----|
| 프로토콜 번호 | 112 (IANA 할당) |
| 멀티캐스트 주소 | ff02:0:0:0:0:0:0:12 |
| 홉 제한 | 255 (필수) |
| 출발지 주소 | 인터페이스 링크-로컬 IPv6 주소 |

### 3.3 가상 라우터 MAC 주소

```
IPv4: 00-00-5E-00-01-{VRID}
IPv6: 00-00-5E-00-02-{VRID}

예시:
VRID = 1인 경우:
- IPv4 MAC: 00-00-5E-00-01-01
- IPv6 MAC: 00-00-5E-00-02-01

첫 세 옥텟 (00-00-5E): IANA의 조직 고유 식별자(OUI)
네 번째 옥텟: 00-01 (IPv4) 또는 00-02 (IPv6)
다섯 번째 옥텟: VRID 값
```

## 4. 상태 머신

### 4.1 세 가지 운영 상태

```
┌─────────────┐
│  Initialize │ ← 시작 상태
└──────┬──────┘
       │
       │ Startup 이벤트
       ▼
┌──────────────────────────────────────┐
│                                      │
│  ┌─────────┐        ┌─────────┐     │
│  │ Backup  │◄──────►│ Active  │     │
│  └─────────┘        └─────────┘     │
│                                      │
└──────────────────────────────────────┘
```

### 4.2 상태 설명

#### Initialize (초기화)

```
- 시작 구성 대기
- VRRP 광고 전송/수신 안 함
- 전환 조건:
  - Priority = 255 → Active 상태로
  - Priority < 255 → Backup 상태로
```

#### Backup (백업)

```
역할:
- 활성 라우터 모니터링
- 가상 IP에 대한 패킷 처리 안 함
- ARP/ND 요청에 응답 안 함

전환 조건:
- Active_Down_Timer 만료 → Active로
- Priority 0 광고 수신 → Active로 (빠른 전환)
- 더 높은 우선순위 광고 → Backup 유지
```

#### Active (활성)

```
역할:
- 가상 주소에 대한 패킷 전달
- ARP/ND 요청에 가상 MAC으로 응답
- 주기적 VRRP 광고 전송

전환 조건:
- 더 높은 우선순위 라우터 발견 → Backup으로 (Preempt 모드)
- 관리자에 의한 비활성화 → Initialize로
```

## 5. 타이머 메커니즘

### 5.1 주요 타이머

| 타이머 | 공식 | 설명 |
|--------|------|------|
| Advertisement_Interval | 구성값 | 광고 전송 간격 (기본 100 센티초 = 1초) |
| Active_Down_Interval | (3 × Adver_Interval) + Skew_Time | 활성 라우터 실패 판단 시간 |
| Skew_Time | ((256 - Priority) × Adver_Interval) / 256 | 우선순위 기반 지연 |

### 5.2 타이머 계산 예시

```
Priority = 100, Advertisement_Interval = 1초인 경우:

Skew_Time = ((256 - 100) × 1) / 256
          = 156 / 256
          = 0.609초

Active_Down_Interval = (3 × 1) + 0.609
                     = 3.609초

→ 3.609초 동안 광고를 받지 못하면 활성 라우터 실패로 판단
```

### 5.3 Skew_Time의 목적

```
Skew_Time은 우선순위에 따라 다른 대기 시간을 부여:

높은 우선순위 (예: 200):
- Skew_Time = ((256 - 200) × 1) / 256 = 0.219초
- 더 빨리 Active로 전환 시도

낮은 우선순위 (예: 50):
- Skew_Time = ((256 - 50) × 1) / 256 = 0.805초
- 더 늦게 Active로 전환 시도

→ 동시 Active 라우터 선출 방지
```

## 6. 패킷 수신 및 검증

### 6.1 필수 검증 항목

수신 라우터는 다음을 모두 검증해야 합니다:

```
1. TTL/홉 제한 = 255
   → 원격 공격 방지 (로컬 네트워크만 허용)

2. VRRP 버전 = 3
   → 호환성 확인

3. 패킷 유형 = 1 (ADVERTISEMENT)
   → 유효한 메시지 유형

4. 패킷 완전성
   → 손상된 패킷 거부

5. 체크섬 유효
   → 데이터 무결성 확인

6. VRID 일치
   → 구성된 가상 라우터와 매칭

7. 수신자 ≠ 주소 소유자
   → 자기 자신의 패킷 무시
```

### 6.2 검증 실패 시 동작

```
검증 실패 → 패킷 폐기 (조용히)
- 오류 응답 전송 안 함
- 로그 기록 권장
```

## 7. ARP 및 이웃 탐색

### 7.1 IPv4 ARP 처리

```
호스트가 가상 IP에 대한 ARP 요청 전송:
"Who has 192.168.1.1? Tell me your MAC address"

활성 라우터 응답:
"192.168.1.1 is at 00-00-5E-00-01-{VRID}"

백업 라우터:
- ARP 요청 무시
- 응답 전송 안 함
```

### 7.2 IPv6 이웃 탐색 처리

```
활성 라우터:
1. Neighbor Solicitation 수신
2. Neighbor Advertisement로 응답
   - Link-layer address = 00-00-5E-00-02-{VRID}
   - Router flag = Set

상태 전환 시:
- 새 활성 라우터가 비요청 Neighbor Advertisement 전송
- 호스트들의 이웃 캐시 업데이트
```

### 7.3 Gratuitous ARP/NA

```
활성 라우터로 전환 시:

IPv4:
- Gratuitous ARP 전송
- 네트워크의 모든 장치가 MAC 매핑 업데이트

IPv6:
- Unsolicited Neighbor Advertisement 전송
- Router 플래그 설정
- Override 플래그 설정
```

## 8. IPv6 특정 작업

### 8.1 Router Advertisement

```
활성 라우터는 Router Advertisement 전송:
- 가상 라우터의 링크-로컬 주소 사용
- 가상 MAC 주소를 Source Link-Layer Address로 포함
- 호스트들의 기본 게이트웨이로 동작
```

### 8.2 Solicited-Node 멀티캐스트

```
백업 라우터도 가입해야 함:
- 가상 IPv6 주소의 Solicited-Node 멀티캐스트 그룹
- 형식: ff02::1:ffXX:XXXX (XX:XXXX = 주소의 하위 24비트)

목적:
- Active로 전환 시 즉시 NS 응답 가능
```

## 9. 보안 고려사항

### 9.1 인증 부재

```
⚠️ VRRP에는 내장된 인증이 없음

위험:
- 악의적 노드가 높은 우선순위로 광고 가능
- 모든 정상 라우터가 Backup으로 전환
- 트래픽 가로채기 가능

완화책:
- L2 스위치에서 VRRP 패킷 필터링
- 신뢰할 수 있는 포트에서만 VRRP 허용
```

### 9.2 TTL/홉 제한 보호

```
TTL/Hop Limit = 255 요구사항:

목적:
- 원격에서 전송된 VRRP 패킷 거부
- 패킷이 라우터를 거치면 TTL 감소
- TTL < 255인 패킷 = 비로컬 = 거부

보호 범위:
- 외부 네트워크에서의 VRRP 주입 공격 방지
- 로컬 네트워크 내 공격은 방지 불가
```

### 9.3 L2 필터링

```
스위치 기반 보호:

1. VRRP 트래픽 제한
   - 지정된 포트에서만 VRRP 허용
   - 다른 포트의 VRRP 패킷 차단

2. MAC 주소 필터링
   - 가상 MAC 주소 소스 제한
   - 허가된 라우터 포트에서만 허용

3. 멀티캐스트 필터링
   - 224.0.0.18 및 ff02::12 트래픽 제어
```

## 10. 운영 권장사항

### 10.1 우선순위 구성

```
권장 사항:

1. VRID당 하나의 라우터만 Priority = 255
   - 주소 소유자로 동작
   - 가장 빠른 활성화

2. 다른 우선순위 값 사용
   - Priority = 150 (주 백업)
   - Priority = 100 (보조 백업)
   - 동시 선출 방지

3. Priority = 0 사용
   - 계획된 유지보수 시
   - 빠른 장애조치 트리거
```

### 10.2 광고 간격

```
일관된 Advertisement_Interval 사용:

문제 상황:
- Active: 1초 간격
- Backup: 3초 간격 기대
→ Backup이 조기에 Active로 전환 시도

해결:
- 모든 라우터에서 동일한 간격 구성
- 또는 Backup이 Active의 광고에서 간격 학습
```

### 10.3 서브초 타이머

```
1초 미만 광고 간격 사용 시:

주의사항:
- CPU 부하 증가
- 네트워크 혼잡 시 플래핑 가능
- 큐 지연으로 인한 오탐지

권장:
- 신중한 큐 관리
- QoS로 VRRP 패킷 우선 처리
- 모니터링 및 튜닝
```

## 11. VRRPv2/v3 상호운용

### 11.1 동시 운용

```
업그레이드 기간 중 지원:

활성 라우터 동작:
- VRRPv2와 VRRPv3 광고 모두 전송
- 두 버전의 백업 라우터 지원

백업 라우터 동작:
- 두 버전의 광고 수신 가능
- VRRPv3 광고 우선시
```

### 11.2 버전 차이

| 항목 | VRRPv2 | VRRPv3 |
|------|--------|--------|
| IPv6 지원 | 별도 RFC | 통합 |
| 광고 간격 | 초 단위 | 센티초 단위 |
| 용어 | Master/Backup | Active/Backup |
| 인증 | 지원 (약함) | 제거됨 |

## 12. IANA 할당

### 12.1 프로토콜 번호

```
IP 프로토콜 번호: 112

IPv4 및 IPv6 모두에서 동일하게 사용
```

### 12.2 멀티캐스트 주소

| 버전 | 주소 |
|------|------|
| IPv4 | 224.0.0.18 |
| IPv6 | ff02:0:0:0:0:0:0:12 (ff02::12) |

### 12.3 MAC 주소 블록

| 용도 | 범위 |
|------|------|
| IPv4 VRRP | 00-00-5E-00-01-00 ~ 00-00-5E-00-01-FF |
| IPv6 VRRP | 00-00-5E-00-02-00 ~ 00-00-5E-00-02-FF |

## 요약

RFC 9568 VRRP v3은 다음을 제공합니다:

- 동적 장애조치: 활성 라우터 실패 시 자동 전환
- IPv4/IPv6 통합: 단일 프로토콜로 두 버전 지원
- 우선순위 기반 선출: 예측 가능한 활성 라우터 결정
- 빠른 수렴: 센티초 단위 타이머로 빠른 감지
- 가상 MAC 주소: 장애조치 시 호스트 재구성 불필요

VRRP는 게이트웨이 이중화의 표준 프로토콜 로, 네트워크 가용성을 높이는 핵심 기술입니다.

---

*원본: https://datatracker.ietf.org/doc/rfc9568/*
