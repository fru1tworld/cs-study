# RFC 2131: Dynamic Host Configuration Protocol (DHCP)

> IP 주소를 자동으로 할당받는 과정 (Discover, Offer, Request, Ack)

## 1. 개요

DHCP(Dynamic Host Configuration Protocol)는 TCP/IP 네트워크의 호스트에 설정 정보를 자동으로 전달하는 프로토콜입니다. BOOTP를 기반으로 하며, 자동 주소 할당과 추가 설정 옵션 기능을 제공합니다.

### 핵심 목적
- 클라이언트의 수동 IP 설정 제거
- IP 주소의 동적 할당 및 재사용
- TCP/IP 스택의 모든 필수 매개변수 자동 전달
- 네트워크 관리자의 중앙 집중식 관리

### 세 가지 할당 메커니즘

| 방식 | 설명 |
|------|------|
| 자동 할당 (Automatic) | DHCP가 영구 IP 주소를 클라이언트에 할당 |
| 동적 할당 (Dynamic) | 제한된 기간(임대)의 IP 주소 할당, 만료 후 재할당 가능 |
| 수동 할당 (Manual) | 관리자가 미리 지정한 특정 주소를 클라이언트에 전달 |

---

## 2. DHCP 메시지 형식

DHCP는 BOOTP 메시지 형식을 기반으로 하며, UDP를 사용합니다.
- 서버 포트: 67
- 클라이언트 포트: 68

### 2.1 메시지 구조

```
   0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
  +---------------+---------------+---------------+---------------+
  |                            xid (4)                            |
  +-------------------------------+-------------------------------+
  |           secs (2)            |           flags (2)           |
  +-------------------------------+-------------------------------+
  |                          ciaddr  (4)                          |
  +---------------------------------------------------------------+
  |                          yiaddr  (4)                          |
  +---------------------------------------------------------------+
  |                          siaddr  (4)                          |
  +---------------------------------------------------------------+
  |                          giaddr  (4)                          |
  +---------------------------------------------------------------+
  |                          chaddr  (16)                         |
  +---------------------------------------------------------------+
  |                          sname   (64)                         |
  +---------------------------------------------------------------+
  |                          file    (128)                        |
  +---------------------------------------------------------------+
  |                          options (variable)                   |
  +---------------------------------------------------------------+
```

### 2.2 필드 설명

| 필드 | 크기 | 설명 |
|------|------|------|
| op | 1 octet | 메시지 타입: BOOTREQUEST(1), BOOTREPLY(2) |
| htype | 1 octet | 하드웨어 주소 타입 (Ethernet=1) |
| hlen | 1 octet | 하드웨어 주소 길이 (Ethernet=6) |
| hops | 1 octet | 릴레이 에이전트가 사용, 클라이언트는 0 |
| xid | 4 octets | 트랜잭션 ID (클라이언트가 생성한 난수) |
| secs | 2 octets | 주소 요청 시작 이후 경과 시간 (초) |
| flags | 2 octets | 플래그 (bit 0: BROADCAST) |
| ciaddr | 4 octets | 클라이언트 IP (BOUND/RENEW 상태에서만) |
| yiaddr | 4 octets | 서버가 할당하는 클라이언트 IP |
| siaddr | 4 octets | 부트스트랩 서버의 IP 주소 |
| giaddr | 4 octets | 릴레이 에이전트 IP 주소 |
| chaddr | 16 octets | 클라이언트 하드웨어 주소 (MAC) |
| sname | 64 octets | 서버 호스트명 (옵션용으로 사용 가능) |
| file | 128 octets | 부트 파일명 (옵션용으로 사용 가능) |
| options | 가변 | DHCP 옵션들 |

### 2.3 ciaddr 필드 사용 규칙

`ciaddr` (Client IP Address) 필드는 클라이언트의 현재 IP 주소를 나타내며, 클라이언트 상태에 따라 엄격한 사용 규칙이 적용됩니다.

#### 상태별 ciaddr 설정 규칙

| 메시지 타입 | 클라이언트 상태 | ciaddr 값 | 설명 |
|------------|----------------|-----------|------|
| DHCPDISCOVER | INIT | 0.0.0.0 | IP 없음, 반드시 0 |
| DHCPREQUEST | SELECTING | 0.0.0.0 | OFFER 선택 중, 아직 IP 미확정 |
| DHCPREQUEST | INIT-REBOOT | 0.0.0.0 | 재부팅 중, 유효성 확인 전 |
| DHCPREQUEST | RENEWING | 현재 IP | 갱신 요청, 유효한 IP 보유 |
| DHCPREQUEST | REBINDING | 현재 IP | 재바인딩 요청, 유효한 IP 보유 |
| DHCPINFORM | N/A | 현재 IP | 추가 정보만 요청, 유효한 IP 보유 |
| DHCPRELEASE | N/A | 현재 IP | 임대 반환, 유효한 IP 보유 |
| DHCPDECLINE | N/A | 0.0.0.0 | 충돌 보고, IP 사용 거부 |

#### ciaddr 사용의 핵심 원칙

```
1. ciaddr이 0.0.0.0이 아닌 경우:
   - 클라이언트는 해당 IP로 유니캐스트 수신 가능
   - 서버는 ciaddr로 직접 응답 가능
   - ARP 해석 없이 통신 가능

2. ciaddr이 0.0.0.0인 경우:
   - 클라이언트는 유효한 IP 없음
   - 서버는 yiaddr에 할당 IP 기재
   - BROADCAST 플래그 또는 yiaddr+MAC 사용

3. 잘못된 ciaddr 사용 결과:
   - 서버가 잘못된 주소로 응답
   - 클라이언트가 응답을 수신하지 못함
   - 네트워크 충돌 발생 가능
```

#### DHCPREQUEST 시 ciaddr vs Requested IP Address

```
상태별 필드 사용:

SELECTING 상태:
- ciaddr: 0.0.0.0
- Requested IP Address 옵션: OFFER의 yiaddr 값
- Server Identifier 옵션: 선택한 서버 IP

INIT-REBOOT 상태:
- ciaddr: 0.0.0.0
- Requested IP Address 옵션: 이전에 사용한 IP
- Server Identifier 옵션: 없음 (특정 서버 지정 안 함)

RENEWING/REBINDING 상태:
- ciaddr: 현재 바인딩된 IP
- Requested IP Address 옵션: 포함하지 않음
- Server Identifier 옵션: 없음
```

### 2.4 옵션 필드 구조

```
+--------+--------+--------+--------+
|  99    |  130   |  83    |  99    |  <- Magic Cookie
+--------+--------+--------+--------+
|  Code  | Length |  Data  |  ...   |  <- 옵션 1 (TLV 형식)
+--------+--------+--------+--------+
|  Code  | Length |  Data  |  ...   |  <- 옵션 2
+--------+--------+--------+--------+
|  255   |                           <- End 옵션
+--------+
```

- Magic Cookie: 99.130.83.99 (DHCP 옵션 시작 표시)
- TLV 형식: Tag(1바이트) + Length(1바이트) + Value(가변)
- End 옵션: 255 (옵션 종료 표시)

### 2.4 Option Overload 메커니즘

DHCP 옵션이 options 필드(312바이트)를 초과하는 경우, `sname`과 `file` 필드를 추가 옵션 공간으로 사용할 수 있습니다.

#### Option Overload (옵션 52)

```
+--------+--------+--------+
|   52   |   1    |  값    |
+--------+--------+--------+
   코드    길이     1-3
```

| 값 | 설명 |
|----|------|
| 1 | `file` 필드(128바이트)가 옵션을 포함 |
| 2 | `sname` 필드(64바이트)가 옵션을 포함 |
| 3 | `file`과 `sname` 필드 모두 옵션을 포함 |

#### 옵션 파싱 순서

```
1. options 필드 파싱 시작
2. Option Overload 옵션(52) 발견 시 값 기록
3. options 필드 완전히 파싱
4. 오버로드 값에 따라:
   - 값=1 또는 3: file 필드 파싱
   - 값=2 또는 3: sname 필드 파싱

주의사항:
- Option Overload 옵션은 반드시 options 필드에만 존재
- file/sname 필드 내에 Option Overload 옵션 포함 금지
- 오버로드 사용 시 해당 필드의 원래 용도 상실
```

#### 사용 예시

```
원본 메시지:
- sname: "dhcp.example.com" (서버명으로 사용)
- file: "pxelinux.0" (부트파일명으로 사용)

Option Overload 적용 시:
- sname: [DHCP 옵션 데이터] (옵션 공간으로 사용)
- file: [DHCP 옵션 데이터] (옵션 공간으로 사용)
- 실제 서버명/파일명은 옵션 66, 67로 전달
```

---

## 3. DHCP 동작 과정 (DORA)

### 3.1 초기 주소 할당 흐름

```
    클라이언트                                  서버
        |                                        |
        |  1. DHCPDISCOVER (브로드캐스트)        |
        |--------------------------------------->|
        |                                        |
        |  2. DHCPOFFER (유니캐스트/브로드캐스트) |
        |<---------------------------------------|
        |                                        |
        |  3. DHCPREQUEST (브로드캐스트)         |
        |--------------------------------------->|
        |                                        |
        |  4. DHCPACK (유니캐스트/브로드캐스트)   |
        |<---------------------------------------|
        |                                        |
```

### 3.2 단계별 상세 설명

#### 1단계: DHCPDISCOVER

클라이언트가 네트워크에서 DHCP 서버를 찾습니다.

```
클라이언트 → 브로드캐스트 (255.255.255.255)

주요 필드:
- op: BOOTREQUEST (1)
- ciaddr: 0.0.0.0 (IP 주소 없음)
- yiaddr: 0.0.0.0
- xid: 랜덤 트랜잭션 ID
- chaddr: 클라이언트 MAC 주소

옵션:
- DHCP Message Type: DHCPDISCOVER (1)
- Requested IP Address: (있으면) 이전에 사용한 IP
- Parameter Request List: 요청하는 옵션 목록
```

재전송 전략 (지수 백오프):

DHCP 클라이언트는 메시지 손실에 대비하여 지수 백오프(Exponential Backoff) 알고리즘을 사용합니다:

```
재전송 타이밍:
┌────────┬────────────┬───────────────────────────────────┐
│ 시도   │ 대기 시간   │ 설명                              │
├────────┼────────────┼───────────────────────────────────┤
│ 초기   │ 0-1초      │ 초기 랜덤 지연 (동기화 방지)      │
│ 1차    │ 4초 ±1초   │ 첫 번째 전송                      │
│ 2차    │ 8초 ±1초   │ 응답 없을 경우 재전송             │
│ 3차    │ 16초 ±1초  │ 계속 응답 없을 경우               │
│ 4차    │ 32초 ±1초  │ 지수적 증가                       │
│ 5차    │ 64초 ±1초  │ 최대 대기 시간 도달               │
│ 이후   │ 64초 ±1초  │ 64초에서 고정                     │
└────────┴────────────┴───────────────────────────────────┘

랜덤 요소 (-1초 ~ +1초):
- 네트워크 동기화 문제 방지
- 다수 클라이언트의 동시 재전송 분산
- 서버 과부하 방지
```

초기 대기 (0-10초 랜덤):
- 전원 복구, 네트워크 장애 복구 시 다수 클라이언트의 동시 DISCOVER 방지
- 초기 대기 후 첫 DHCPDISCOVER 전송

secs 필드 업데이트:
- 각 재전송 시 secs 필드를 경과 시간으로 업데이트
- 서버는 secs 값이 높은 요청에 우선 응답 가능

#### 2단계: DHCPOFFER

서버가 사용 가능한 IP 주소를 제안합니다.

```
서버 → 클라이언트

주요 필드:
- op: BOOTREPLY (2)
- yiaddr: 제안하는 IP 주소
- siaddr: 서버 IP
- xid: 클라이언트의 트랜잭션 ID

옵션:
- DHCP Message Type: DHCPOFFER (2)
- Server Identifier: 서버 IP 주소
- IP Address Lease Time: 임대 기간 (초)
- Subnet Mask: 서브넷 마스크
- Router: 기본 게이트웨이
- DNS Server: DNS 서버 주소
```

서버의 주소 선택 우선순위:
1. 클라이언트의 현재 바인딩된 주소
2. 이전에 사용했던 주소 (만료/릴리스됨)
3. Requested IP Address 옵션의 주소
4. 서버 풀에서 새 주소

클라이언트의 OFFER 선택 기준:

클라이언트가 여러 서버로부터 DHCPOFFER를 수신한 경우, 다음 기준으로 선택합니다:

| 우선순위 | 기준 | 설명 |
|---------|------|------|
| 1 | 이전 서버 | 이전에 임대받았던 서버의 OFFER 우선 |
| 2 | Requested IP 매칭 | 클라이언트가 요청한 IP를 제공하는 OFFER |
| 3 | 설정 옵션 완전성 | Parameter Request List의 모든 옵션을 제공하는 OFFER |
| 4 | 임대 시간 | 더 긴 임대 시간을 제공하는 OFFER |
| 5 | 수신 순서 | 위 조건이 동일하면 먼저 수신된 OFFER |

```
OFFER 수집 절차:
1. 첫 OFFER 수신 후 일정 시간 대기 (구현에 따라 다름)
2. 대기 시간 내 수신된 모든 OFFER 비교
3. 위 기준에 따라 최적의 OFFER 선택
4. 선택된 서버에 DHCPREQUEST 전송

권장사항:
- 클라이언트는 최소 하나 이상의 OFFER를 수집해야 함
- 과도한 대기는 네트워크 연결 지연을 야기
- 일반적으로 1-2초 대기 후 선택
```

#### 3단계: DHCPREQUEST

클라이언트가 제안된 주소를 수락합니다.

```
클라이언트 → 브로드캐스트

주요 필드:
- op: BOOTREQUEST (1)
- ciaddr: 0.0.0.0 (아직 설정 안 됨)

옵션:
- DHCP Message Type: DHCPREQUEST (3)
- Server Identifier: 선택한 서버의 IP (필수)
- Requested IP Address: DHCPOFFER의 yiaddr 값
```

브로드캐스트하는 이유:
- 다른 DHCP 서버들에게 제안 거절을 알림
- 선택되지 않은 서버들이 주소를 풀에 반환

#### 4단계: DHCPACK

서버가 할당을 확인하고 구성 정보를 전송합니다.

```
서버 → 클라이언트

주요 필드:
- op: BOOTREPLY (2)
- yiaddr: 할당된 IP 주소

옵션:
- DHCP Message Type: DHCPACK (5)
- IP Address Lease Time: 최종 임대 기간
- (추가 구성 옵션들)
```

클라이언트 최종 확인:
- ARP를 통해 IP 주소 중복 확인
- 중복 발견 시 DHCPDECLINE 전송

---

## 4. 클라이언트 상태 전이

```
                               ┌──────────────┐
                               │     INIT     │
                               └──────┬───────┘
                                      │ DHCPDISCOVER 전송
                                      ▼
                               ┌──────────────┐
              DHCPOFFER 수신 → │  SELECTING   │
                               └──────┬───────┘
                                      │ DHCPREQUEST 전송
                                      ▼
                               ┌──────────────┐
               DHCPACK 수신 → │  REQUESTING  │ ← DHCPNAK → INIT
                               └──────┬───────┘
                                      │ 바인딩 완료
                                      ▼
    ┌────────────────────────────────────────────────────────────┐
    │                          BOUND                             │
    │                    (정상 동작 상태)                         │
    └────────────────────────────────────────────────────────────┘
            │                               │
            │ T1 만료 (50%)                 │ T2 만료 (87.5%)
            ▼                               ▼
    ┌──────────────┐                ┌──────────────┐
    │   RENEWING   │ ──T2 만료──→  │  REBINDING   │
    │  (유니캐스트) │                │ (브로드캐스트) │
    └──────────────┘                └──────────────┘
            │                               │
            │ DHCPACK                       │ DHCPACK
            └───────── BOUND ◄──────────────┘
                         │
                         │ 임대 만료
                         ▼
                       INIT

    ※ INIT-REBOOT: 재부팅 시 이전 IP로 직접 REQUEST
```

### 4.1 상태별 설명

| 상태 | 설명 |
|------|------|
| INIT | 초기 상태, DHCPDISCOVER 전송 |
| SELECTING | 여러 OFFER 중 선택 |
| REQUESTING | 선택한 서버에 REQUEST 전송 |
| BOUND | 정상 동작, IP 주소 사용 중 |
| RENEWING | 서버에 유니캐스트로 갱신 요청 |
| REBINDING | 브로드캐스트로 갱신 요청 |
| INIT-REBOOT | 재부팅 후 이전 IP 재사용 시도 |

### 4.2 INIT-REBOOT 프로세스

클라이언트가 이전에 사용한 IP 주소를 기억하는 경우:

```
클라이언트 → 브로드캐스트

DHCPREQUEST:
- Server Identifier: 없음 (특정 서버 지정 안 함)
- Requested IP Address: 이전에 사용한 IP
- ciaddr: 0.0.0.0

서버 응답:
- DHCPACK: 주소가 유효하면
- DHCPNAK: 주소가 유효하지 않으면 (클라이언트는 INIT으로)
```

---

## 5. 임대(Lease) 메커니즘

### 5.1 임대 시간 표현

- 단위: 초
- 범위: 32비트 부호 없는 정수 (약 136년)
- 무한 임대: 0xFFFFFFFF

### 5.2 임대 타이머

```
시간 ──────────────────────────────────────────────────────────►

T0 (시작)         T1 (50%)          T2 (87.5%)      만료
   │                  │                  │             │
   │    BOUND 상태    │   RENEWING 상태  │ REBINDING │ │
   │                  │                  │    상태    │ │
   ├──────────────────┼──────────────────┼───────────┼─┤
   │                  │                  │           │ │
   │  정상 사용 기간   │  갱신 시도 기간   │  최후 시도 │만료
```

기본 값:
- T1: 임대 시간 × 0.5 (갱신 시작)
- T2: 임대 시간 × 0.875 (재바인딩 시작)

### 5.3 갱신 프로세스

#### RENEWING (T1 이후)
```
클라이언트 → 서버 (유니캐스트)

DHCPREQUEST:
- ciaddr: 현재 IP 주소
- Server Identifier: 없음

성공 시: DHCPACK → BOUND (타이머 리셋)
실패 시: T2까지 재시도 → REBINDING 전환
```

#### REBINDING (T2 이후)
```
클라이언트 → 브로드캐스트

DHCPREQUEST:
- ciaddr: 현재 IP 주소
- Server Identifier: 없음

성공 시: DHCPACK → BOUND
실패 시: 만료까지 재시도 → INIT (IP 포기)
```

---

## 6. 기타 DHCP 메시지

### 6.1 DHCPNAK

서버가 클라이언트의 요청을 거부할 때:

```
사용 상황:
- 클라이언트가 요청한 IP가 유효하지 않음
- 클라이언트가 잘못된 서브넷에 있음

클라이언트 동작:
- INIT 상태로 복귀
- 새로운 DHCPDISCOVER 시작
```

### 6.2 DHCPDECLINE

클라이언트가 할당받은 IP가 이미 사용 중임을 발견했을 때:

```
클라이언트 → 서버

상황: ARP 확인 시 IP 충돌 발견

서버 동작:
- 해당 IP를 사용 불가능으로 표시
- 관리자에게 알림 (수동 해결 필요)

클라이언트 동작:
- INIT 상태로 복귀
- 최소 10초 대기 후 재시도
```

### 6.3 DHCPRELEASE

클라이언트가 IP 주소를 반환할 때:

```
클라이언트 → 서버 (유니캐스트)

상황:
- 클라이언트 정상 종료
- 네트워크 인터페이스 비활성화

서버 동작:
- 주소를 미할당 상태로 변경
- 클라이언트 정보 보관 (재할당 시 활용)
```

### 6.4 DHCPINFORM

이미 IP 주소가 있는 클라이언트가 추가 설정만 요청할 때:

```
클라이언트 → 서버

상황:
- 수동으로 IP 설정됨
- 다른 정보(DNS, 게이트웨이 등)만 필요

필드:
- ciaddr: 현재 IP 주소

서버 응답:
- yiaddr 비워둠
- 임대 시간 없음
- 요청된 옵션만 제공
```

---

## 7. 주요 DHCP 옵션

### 7.1 필수/중요 옵션

| 코드 | 이름 | 길이 | 설명 |
|------|------|------|------|
| 1 | Subnet Mask | 4 | 서브넷 마스크 |
| 3 | Router | N×4 | 기본 게이트웨이 목록 |
| 6 | DNS Server | N×4 | DNS 서버 목록 |
| 12 | Host Name | N | 클라이언트 호스트명 |
| 15 | Domain Name | N | DNS 도메인명 |
| 28 | Broadcast Address | 4 | 브로드캐스트 주소 |
| 50 | Requested IP | 4 | 요청하는 IP 주소 |
| 51 | Lease Time | 4 | 임대 기간 (초) |
| 53 | Message Type | 1 | DHCP 메시지 타입 |
| 54 | Server Identifier | 4 | 서버 IP 주소 |
| 55 | Parameter List | N | 요청 옵션 목록 |
| 57 | Max Message Size | 2 | 최대 메시지 크기 |
| 58 | Renewal Time (T1) | 4 | 갱신 시작 시간 |
| 59 | Rebinding Time (T2) | 4 | 재바인딩 시작 시간 |
| 61 | Client Identifier | N | 클라이언트 고유 ID |

### 7.2 DHCP 메시지 타입 (옵션 53)

| 값 | 타입 | 설명 |
|----|------|------|
| 1 | DHCPDISCOVER | 서버 탐색 |
| 2 | DHCPOFFER | 주소 제안 |
| 3 | DHCPREQUEST | 주소 요청/갱신 |
| 4 | DHCPDECLINE | 주소 거부 (충돌) |
| 5 | DHCPACK | 주소 확인 |
| 6 | DHCPNAK | 요청 거부 |
| 7 | DHCPRELEASE | 주소 반환 |
| 8 | DHCPINFORM | 정보만 요청 |

---

## 8. BROADCAST 플래그

### 목적
일부 클라이언트는 IP 주소가 설정되기 전에 유니캐스트 수신이 불가능합니다.

### 동작

```
Flags 필드:
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|B |                    MBZ                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+

B: BROADCAST 플래그
MBZ: Must Be Zero (예약)
```

| B 값 | 클라이언트 | 서버 응답 |
|------|-----------|----------|
| 0 | 유니캐스트 수신 가능 | yiaddr로 유니캐스트 |
| 1 | 유니캐스트 수신 불가 | 255.255.255.255로 브로드캐스트 |

---

## 9. 릴레이 에이전트

### 9.1 목적
모든 서브넷에 DHCP 서버를 둘 필요 없이, 다른 서브넷의 서버와 통신

### 9.2 기본 동작

```
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│ 클라이언트 │ ──► │ 릴레이 에이전트 │ ──► │  DHCP 서버   │
│ (서브넷 A) │     │   (게이트웨이)  │     │  (서브넷 B)  │
└──────────┘     └──────────────┘     └──────────────┘

1. 클라이언트: 브로드캐스트 DHCPDISCOVER
2. 릴레이: giaddr 필드에 자신의 IP 설정
3. 릴레이: 서버로 유니캐스트 전달
4. 서버: giaddr 기반으로 적절한 주소 풀 선택
5. 서버: 릴레이로 응답
6. 릴레이: 클라이언트에게 전달 (브로드캐스트/유니캐스트)
```

### 9.3 필드 변경
- hops: 릴레이 경유 시마다 증가
- giaddr: 첫 릴레이가 자신의 IP 설정
- secs: 서버가 우선순위 판단에 사용

### 9.4 릴레이 에이전트 상세 동작

#### 클라이언트 → 서버 방향 처리

```
릴레이 에이전트가 DHCP 브로드캐스트를 수신했을 때:

1. 메시지 검증:
   - hops 필드 확인 (보통 16 미만)
   - hops >= 16이면 메시지 폐기

2. giaddr 필드 처리:
   - giaddr이 0이면: 수신한 인터페이스 IP로 설정
   - giaddr이 0이 아니면: 변경하지 않음 (이미 다른 릴레이가 설정)

3. hops 필드 증가:
   - hops = hops + 1

4. 서버로 전달:
   - 설정된 DHCP 서버 IP로 유니캐스트 전송
   - 목적지 포트: 67 (서버 포트)
```

#### 서버 → 클라이언트 방향 처리

```
릴레이 에이전트가 DHCP 서버로부터 응답을 수신했을 때:

1. giaddr 확인:
   - 자신의 IP와 일치하는지 확인
   - 일치하지 않으면 다른 릴레이용이므로 처리하지 않음

2. 전달 방식 결정:
   ┌─────────────────────────────────────────────────────────┐
   │ 조건                        │ 전달 방식                 │
   ├─────────────────────────────────────────────────────────┤
   │ BROADCAST 플래그 = 1        │ 255.255.255.255 브로드캐스트│
   │ ciaddr != 0.0.0.0           │ ciaddr로 유니캐스트       │
   │ yiaddr != 0.0.0.0           │ yiaddr로 유니캐스트       │
   │                             │ (링크 계층 주소 사용)     │
   └─────────────────────────────────────────────────────────┘

3. 클라이언트 인터페이스로 전달:
   - 목적지 포트: 68 (클라이언트 포트)
```

### 9.5 다중 릴레이 에이전트 (체인)

여러 네트워크를 거쳐 DHCP 메시지가 전달되는 경우:

```
┌──────────┐     ┌─────────┐     ┌─────────┐     ┌────────┐
│클라이언트│ ──► │ 릴레이1  │ ──► │ 릴레이2  │ ──► │ 서버   │
│          │     │giaddr=A │     │giaddr=A │     │        │
│          │     │hops=1   │     │hops=2   │     │        │
└──────────┘     └─────────┘     └─────────┘     └────────┘

주요 규칙:
- 첫 번째 릴레이만 giaddr 설정
- 이후 릴레이는 giaddr 유지, hops만 증가
- 서버는 giaddr로 첫 번째 릴레이의 서브넷 파악
- 응답은 giaddr의 릴레이로 전송
```

### 9.6 릴레이 에이전트 설정 예시

```
# 일반적인 릴레이 에이전트 설정 요소

1. DHCP 서버 IP 목록:
   - 기본 서버: 10.0.0.1
   - 보조 서버: 10.0.0.2

2. 인터페이스별 설정:
   - eth0: 192.168.1.1 (클라이언트 측)
   - eth1: 10.0.0.254 (서버 측)

3. 릴레이 동작:
   - eth0에서 수신한 브로드캐스트를
   - giaddr=192.168.1.1로 설정하여
   - 10.0.0.1, 10.0.0.2로 유니캐스트 전달
```

### 9.7 서버의 giaddr 처리

```
서버가 giaddr이 0이 아닌 메시지를 수신했을 때:

1. 주소 풀 선택:
   - giaddr이 속한 서브넷의 주소 풀 사용
   - 직접 연결된 서브넷이 아님을 인식

2. 응답 전송:
   - giaddr 주소로 유니캐스트 응답
   - 목적지 포트: 67 (릴레이가 서버 포트에서 수신)

3. 라우팅 정보:
   - 할당할 IP는 giaddr과 같은 서브넷이어야 함
   - 게이트웨이, DNS 등도 해당 서브넷에 맞게 설정
```

---

## 10. 보안 고려사항

RFC 2131의 DHCP는 기본적인 보안 메커니즘이 없습니다.

### 알려진 취약점

| 공격 | 설명 |
|------|------|
| DHCP 스푸핑 | 악성 서버가 잘못된 설정 제공 |
| DHCP 스타베이션 | 모든 IP를 소진시키는 공격 |
| 중간자 공격 | 트래픽 리다이렉션 |

### 대응책 (이후 RFC)

- RFC 3118: DHCP 인증 옵션
- 802.1X: 포트 기반 네트워크 접근 제어
- DHCP 스누핑: 스위치에서 DHCP 트래픽 필터링

---

## 11. 실제 예시

### 전형적인 DHCP 교환

```
시간  메시지               주요 내용
────────────────────────────────────────────────────────
0s    DHCPDISCOVER        xid=0x12345678
                          chaddr=00:11:22:33:44:55

1s    DHCPOFFER           yiaddr=192.168.1.100
                          lease=86400 (24시간)
                          router=192.168.1.1
                          dns=8.8.8.8

1s    DHCPREQUEST         requested_ip=192.168.1.100
                          server_id=192.168.1.254

1s    DHCPACK             yiaddr=192.168.1.100
                          lease=86400
                          (완료)
```

### 임대 갱신 타임라인 (24시간 임대 기준)

```
시간     이벤트
────────────────────────
T+0h     DHCPACK 수신, BOUND 상태
T+12h    T1 만료, RENEWING 시작
         서버로 유니캐스트 DHCPREQUEST
T+21h    T2 만료 (갱신 실패 시), REBINDING 시작
         브로드캐스트 DHCPREQUEST
T+24h    임대 만료, INIT 상태로 복귀
         (갱신 실패 시)
```

---

## 12. 관련 RFC

| RFC | 제목 |
|-----|------|
| RFC 951 | Bootstrap Protocol (BOOTP) |
| RFC 2131 | Dynamic Host Configuration Protocol (본 문서) |
| RFC 2132 | DHCP Options and BOOTP Vendor Extensions |
| RFC 3118 | Authentication for DHCP Messages |
| RFC 3315 | DHCPv6 (IPv6용 DHCP) |
| RFC 4361 | Node-specific Client Identifiers |
