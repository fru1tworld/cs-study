# RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)

> 발행일: 2015년 5월
> 상태: Standards Track

## 1. 개요

HTTP/2는 HTTP/1.1의 성능 문제를 해결하기 위해 설계된 프로토콜입니다. HTTP의 의미론(메서드, 상태 코드, 헤더)은 유지하면서 전송 계층을 완전히 재설계 했습니다.

### HTTP/1.1의 문제점

```
HTTP/1.1 클라이언트가 동시 요청을 위해 여러 연결을 사용해야 함
→ 비효율적인 네트워크 리소스 사용
→ Head-of-Line Blocking 문제
```

### HTTP/2의 핵심 개선사항

| 기능 | 설명 | 효과 |
|------|------|------|
| 헤더 압축 | HPACK 알고리즘 | 오버헤드 감소 |
| 멀티플렉싱 | 단일 연결에서 동시 요청/응답 | 지연시간 감소 |
| 바이너리 프레이밍 | 텍스트 → 바이너리 | 파싱 효율성 향상 |
| 서버 푸시 | 사전 리소스 전송 | 로딩 시간 단축 |

## 2. 프레임 구조

HTTP/2 통신은 프레임(Frame) 이라는 기본 단위로 이루어집니다.

### 2.1 프레임 헤더 형식

```
+-----------------------------------------------+
|                 Length (24)                   |
+---------------+---------------+---------------+
|   Type (8)    |   Flags (8)   |
+-+-------------+---------------+-------------------------------+
|R|                 Stream Identifier (31)                      |
+=+=============================================================+
|                   Frame Payload (0...)                      ...
+---------------------------------------------------------------+
```

| 필드 | 크기 | 설명 |
|------|------|------|
| Length | 24비트 | 페이로드 크기 (최대 16,384 바이트 기본) |
| Type | 8비트 | 프레임 유형 식별자 |
| Flags | 8비트 | 유형별 불리언 플래그 |
| R | 1비트 | 예약 (0으로 설정) |
| Stream Identifier | 31비트 | 스트림 ID (0은 연결 레벨) |

### 2.2 프레임 유형

| 유형 | 코드 | 설명 |
|------|------|------|
| DATA | 0x0 | 요청/응답 본문 데이터 |
| HEADERS | 0x1 | 헤더 필드 블록 |
| PRIORITY | 0x2 | 스트림 우선순위 |
| RST_STREAM | 0x3 | 스트림 종료 |
| SETTINGS | 0x4 | 연결 설정 |
| PUSH_PROMISE | 0x5 | 서버 푸시 예약 |
| PING | 0x6 | 연결 상태 확인 |
| GOAWAY | 0x7 | 연결 종료 알림 |
| WINDOW_UPDATE | 0x8 | 흐름 제어 윈도우 업데이트 |
| CONTINUATION | 0x9 | 헤더 블록 연속 |

### 2.3 주요 프레임 상세

#### DATA 프레임
```
+---------------+
|Pad Length? (8)|
+---------------+-----------------------------------------------+
|                            Data (*)                         ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- END_STREAM 플래그로 본문 종료 표시
- 흐름 제어 대상

#### HEADERS 프레임
```
+---------------+
|Pad Length? (8)|
+-+-------------+-----------------------------------------------+
|E|                 Stream Dependency? (31)                     |
+-+-------------+-----------------------------------------------+
|  Weight? (8)  |
+-+-------------+-----------------------------------------------+
|                   Header Block Fragment (*)                 ...
+---------------------------------------------------------------+
|                           Padding (*)                       ...
+---------------------------------------------------------------+
```

- END_HEADERS: 헤더 블록 완료
- END_STREAM: 스트림 종료
- PRIORITY: 우선순위 정보 포함

## 3. 스트림과 멀티플렉싱

### 3.1 스트림 개념

스트림(Stream) 은 HTTP/2 연결 내의 독립적인 양방향 프레임 시퀀스입니다.

```
┌─────────────────────── HTTP/2 Connection ───────────────────────┐
│                                                                  │
│  ┌─ Stream 1 ─┐  ┌─ Stream 3 ─┐  ┌─ Stream 5 ─┐                 │
│  │ Request 1  │  │ Request 2  │  │ Request 3  │                 │
│  │ Response 1 │  │ Response 2 │  │ Response 3 │                 │
│  └────────────┘  └────────────┘  └────────────┘                 │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 3.2 스트림 식별

| 시작자 | 스트림 ID |
|--------|-----------|
| 클라이언트 | 홀수 (1, 3, 5, ...) |
| 서버 | 짝수 (2, 4, 6, ...) |
| 연결 제어 | 0 (예약) |

### 3.3 스트림 상태 머신

```
                             +--------+
                     send PP |        | recv PP
                    ,--------|  idle  |--------.
                   /         |        |         \
                  v          +--------+          v
           +----------+          |           +----------+
           |          |          | send H /  |          |
    ,------| reserved |          | recv H    | reserved |------.
    |      | (local)  |          |           | (remote) |      |
    |      +----------+          v           +----------+      |
    |          |             +--------+             |          |
    |          |     recv ES |        | send ES    |          |
    |   send H |     ,-------|  open  |-------.    | recv H   |
    |          |    /        |        |        \   |          |
    |          v   v         +--------+         v  v          |
    |      +----------+          |           +----------+      |
    |      |   half   |          |           |   half   |      |
    |      |  closed  |          | send R /  |  closed  |      |
    |      | (remote) |          | recv R    | (local)  |      |
    |      +----------+          |           +----------+      |
    |           |                |                 |           |
    |           | send ES /      |       recv ES / |           |
    |           | send R /       v        send R / |           |
    |           | recv R     +--------+   recv R   |           |
    | send R /  `----------->|        |<-----------'  send R / |
    | recv R                 | closed |               recv R   |
    `----------------------->|        |<-----------------------'
                             +--------+
```

상태 설명:
- idle: 초기 상태
- reserved: 서버 푸시용 예약
- open: 양방향 데이터 전송 가능
- half-closed: 한 방향만 전송 가능
- closed: 스트림 종료

### 3.4 멀티플렉싱

단일 TCP 연결에서 여러 요청/응답을 인터리빙:

```
HTTP/1.1 (순차적):
┌──────────────────────────────────────────────┐
│ Req1 → Res1 │ Req2 → Res2 │ Req3 → Res3     │
└──────────────────────────────────────────────┘

HTTP/2 (멀티플렉싱):
┌──────────────────────────────────────────────┐
│ H1│D1│H2│D1│D2│H3│D1│D2│D3│D2│D3│D3         │
└──────────────────────────────────────────────┘
(H=Headers, D=Data, 숫자=스트림 번호)
```

장점:
- Head-of-Line Blocking 방지
- 하나의 요청이 지연되어도 다른 요청에 영향 없음
- 연결 수 감소

### 3.5 동시성 제어

`SETTINGS_MAX_CONCURRENT_STREAMS`: 동시 활성 스트림 수 제한

```
"open" 또는 "half-closed" 상태의 스트림만 한계에 포함
```

## 4. 흐름 제어 (Flow Control)

### 4.1 개요

HTTP/2는 크레딧 기반 흐름 제어 를 WINDOW_UPDATE 프레임으로 구현합니다.

### 4.2 핵심 원칙

| 원칙 | 설명 |
|------|------|
| 초기 윈도우 크기 | 65,535 옥텟 (스트림 및 연결) |
| 방향성 | 수신자가 윈도우 크기 광고 |
| DATA 프레임만 대상 | HEADERS 등은 흐름 제어 대상 아님 |
| 비활성화 불가 | 흐름 제어는 항상 활성화 |

### 4.3 동작 방식

```
1. 초기 윈도우: 65,535 바이트

2. 송신자가 DATA 전송:
   윈도우 -= 전송 바이트 수

3. 수신자가 WINDOW_UPDATE 전송:
   윈도우 += 증가량

4. 윈도우가 0이면 송신 중단
```

예시:
```
[연결 윈도우: 65535] [스트림1 윈도우: 65535]

→ DATA (10000 bytes) on Stream 1
[연결 윈도우: 55535] [스트림1 윈도우: 55535]

← WINDOW_UPDATE (stream=0, increment=10000)
← WINDOW_UPDATE (stream=1, increment=10000)
[연결 윈도우: 65535] [스트림1 윈도우: 65535]
```

### 4.4 두 가지 윈도우

| 윈도우 | 스트림 ID | 적용 범위 |
|--------|-----------|-----------|
| 연결 레벨 | 0 | 전체 연결의 모든 DATA 프레임 |
| 스트림 레벨 | 1+ | 개별 스트림의 DATA 프레임 |

## 5. 헤더 압축 (HPACK)

### 5.1 개요

HPACK은 HTTP/2의 헤더 압축 알고리즘으로, 연결 전체에서 상태 유지 압축 컨텍스트 를 사용합니다.

### 5.2 압축 방식

```
┌─────────────────────────────────────────────────┐
│                  HPACK 압축                      │
├─────────────────────────────────────────────────┤
│ 1. 정적 테이블: 자주 사용되는 헤더 미리 정의    │
│ 2. 동적 테이블: 연결 중 학습된 헤더 저장        │
│ 3. Huffman 인코딩: 문자열 압축                  │
└─────────────────────────────────────────────────┘
```

### 5.3 정적 테이블 (Static Table)

미리 정의된 61개의 헤더:

| 인덱스 | 헤더 이름 | 헤더 값 |
|--------|-----------|---------|
| 1 | :authority | |
| 2 | :method | GET |
| 3 | :method | POST |
| 4 | :path | / |
| 5 | :path | /index.html |
| 6 | :scheme | http |
| 7 | :scheme | https |
| 8 | :status | 200 |
| ... | ... | ... |

### 5.4 동적 테이블 (Dynamic Table)

```
요청 1: user-agent: Mozilla/5.0 → 동적 테이블에 추가 (인덱스 62)
요청 2: user-agent: Mozilla/5.0 → 인덱스 62로 참조 (1바이트)
```

### 5.5 압축 효과

```
HTTP/1.1 (매 요청마다 전송):
GET / HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
Accept: text/html,application/xhtml+xml
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8
Cookie: session=abc123...
(~500 bytes)

HTTP/2 (HPACK 압축 후):
인덱스 참조 + 차이값만 전송
(~50 bytes, 90% 감소)
```

### 5.6 보안 고려사항

- 압축 컨텍스트는 연결별로 분리
- 디코딩 오류는 연결 오류 로 처리 (GOAWAY)

## 6. 서버 푸시 (Server Push)

### 6.1 개요

서버가 클라이언트 요청 없이 사전에 리소스를 전송 하는 기능입니다.

### 6.2 동작 방식

```
┌──────────┐                      ┌──────────┐
│  Client  │                      │  Server  │
└────┬─────┘                      └────┬─────┘
     │                                 │
     │ GET /index.html (Stream 1)      │
     │────────────────────────────────>│
     │                                 │
     │ PUSH_PROMISE /style.css (Stream 2)
     │<────────────────────────────────│
     │                                 │
     │ HEADERS /index.html (Stream 1)  │
     │<────────────────────────────────│
     │ DATA /index.html (Stream 1)     │
     │<────────────────────────────────│
     │                                 │
     │ HEADERS /style.css (Stream 2)   │
     │<────────────────────────────────│
     │ DATA /style.css (Stream 2)      │
     │<────────────────────────────────│
```

### 6.3 PUSH_PROMISE 프레임

```
+---------------+
|Pad Length? (8)|
+-+-------------+-----------------------------------------------+
|R|                  Promised Stream ID (31)                    |
+-+-----------------------------+-------------------------------+
|                   Header Block Fragment (*)                 ...
+---------------------------------------------------------------+
```

- 열린 스트림에서 전송
- 새 스트림 ID 예약 (서버 시작이므로 짝수)

### 6.4 푸시 비활성화

클라이언트가 푸시를 원하지 않으면:

```
SETTINGS_ENABLE_PUSH = 0
```

비활성화된 상태에서 PUSH_PROMISE 수신 시 연결 오류

### 6.5 푸시 거부

클라이언트가 특정 푸시를 거부:

```
RST_STREAM (stream=promised_stream_id, error=CANCEL)
```

## 7. 연결 관리

### 7.1 연결 설정

#### TLS + ALPN (HTTPS)

```
Client                              Server
   │                                   │
   │──── TLS ClientHello ────────────>│
   │     (ALPN: h2, http/1.1)         │
   │                                   │
   │<─── TLS ServerHello ─────────────│
   │     (ALPN: h2)                   │
   │                                   │
   │<─────── TLS Handshake ───────────│
   │                                   │
   │──── Connection Preface ─────────>│
   │<─── Connection Preface ──────────│
```

#### HTTP Upgrade (HTTP)

```http
GET / HTTP/1.1
Host: example.com
Connection: Upgrade, HTTP2-Settings
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA

HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: h2c
```

### 7.2 연결 프리페이스 (Connection Preface)

#### 클라이언트 프리페이스

```
1. 매직 문자열 (24 옥텟):
   "PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"

2. SETTINGS 프레임
```

#### 서버 프리페이스

```
1. SETTINGS 프레임 (첫 번째 프레임으로)
```

### 7.3 SETTINGS 프레임

```
+-------------------------------+
|       Identifier (16)         |
+-------------------------------+-------------------------------+
|                        Value (32)                             |
+---------------------------------------------------------------+
```

| 설정 | 기본값 | 설명 |
|------|--------|------|
| SETTINGS_HEADER_TABLE_SIZE | 4096 | HPACK 동적 테이블 크기 |
| SETTINGS_ENABLE_PUSH | 1 | 서버 푸시 허용 |
| SETTINGS_MAX_CONCURRENT_STREAMS | 무제한 | 최대 동시 스트림 |
| SETTINGS_INITIAL_WINDOW_SIZE | 65535 | 초기 흐름 제어 윈도우 |
| SETTINGS_MAX_FRAME_SIZE | 16384 | 최대 프레임 페이로드 |
| SETTINGS_MAX_HEADER_LIST_SIZE | 무제한 | 최대 헤더 목록 크기 |

### 7.4 연결 종료 (GOAWAY)

```
+---------------------------------------------------------------+
|R|                  Last-Stream-ID (31)                        |
+---------------------------------------------------------------+
|                      Error Code (32)                          |
+---------------------------------------------------------------+
|                  Additional Debug Data (*)                    |
+---------------------------------------------------------------+
```

용도:
- 우아한 종료 (graceful shutdown)
- 기존 스트림 완료 허용
- 새 스트림 생성 방지

예시:
```
GOAWAY(last_stream_id=7, error_code=NO_ERROR)
→ 스트림 1, 3, 5, 7은 완료됨
→ 스트림 9 이후는 처리되지 않음
```

### 7.5 오류 코드

| 코드 | 이름 | 설명 |
|------|------|------|
| 0x0 | NO_ERROR | 정상 종료 |
| 0x1 | PROTOCOL_ERROR | 프로토콜 오류 |
| 0x2 | INTERNAL_ERROR | 내부 오류 |
| 0x3 | FLOW_CONTROL_ERROR | 흐름 제어 위반 |
| 0x4 | SETTINGS_TIMEOUT | SETTINGS 응답 시간 초과 |
| 0x5 | STREAM_CLOSED | 닫힌 스트림에서 프레임 수신 |
| 0x6 | FRAME_SIZE_ERROR | 프레임 크기 오류 |
| 0x7 | REFUSED_STREAM | 스트림 거부 |
| 0x8 | CANCEL | 스트림 취소 |
| 0x9 | COMPRESSION_ERROR | 압축 오류 |
| 0xa | CONNECT_ERROR | CONNECT 오류 |
| 0xb | ENHANCE_YOUR_CALM | 과도한 부하 |
| 0xc | INADEQUATE_SECURITY | 보안 요구사항 미충족 |
| 0xd | HTTP_1_1_REQUIRED | HTTP/1.1 필요 |

## 8. HTTP/1.1 vs HTTP/2 비교

| 특성 | HTTP/1.1 | HTTP/2 |
|------|----------|--------|
| 프레이밍 | 텍스트 | 바이너리 |
| 연결당 요청 | 1 (파이프라이닝 시 순차) | 다수 (멀티플렉싱) |
| 헤더 압축 | 없음 | HPACK |
| 서버 푸시 | 없음 | 지원 |
| 흐름 제어 | TCP만 | 애플리케이션 레벨 |
| 우선순위 | 없음 | 스트림 우선순위 |

## 요약

RFC 7540 HTTP/2는 다음을 제공합니다:

- 바이너리 프레이밍: 효율적인 파싱과 전송
- 멀티플렉싱: 단일 연결에서 다수 스트림 동시 처리
- HPACK 헤더 압축: 중복 헤더 제거로 대역폭 절약
- 흐름 제어: 세밀한 데이터 전송 관리
- 서버 푸시: 사전 리소스 전송으로 지연 감소
- 스트림 우선순위: 중요 리소스 우선 처리

HTTP/2는 HTTP의 의미론을 유지하면서 전송 효율성을 획기적으로 개선 합니다.
