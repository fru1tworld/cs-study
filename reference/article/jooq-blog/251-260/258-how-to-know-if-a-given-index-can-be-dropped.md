# 주어진 인덱스를 삭제할 수 있는지 알아보는 방법

> 원문: https://blog.jooq.org/how-to-know-if-a-given-index-can-be-dropped/

"완벽함이란 더 이상 추가할 것이 없을 때가 아니라, 더 이상 제거할 것이 없을 때 달성되는 것 같다." – 앙투안 드 생텍쥐페리, Terre des Hommes

SQL 개발자로서 우리는 테이블에 점점 더 많은 인덱스를 추가합니다. 잠재적으로 느린 새로운 쿼리를 실행할 때마다 새 인덱스가 문제를 해결할 수 있습니다. 하지만 이것은 또한 새로운 문제를 만들어냅니다. 인덱스가 많을수록 삽입과 업데이트가 느려지고, 당연히 데이터가 사용하는 디스크 공간도 늘어납니다.

그렇다면 기존 인덱스를 제거해도 되는지 어떻게 알 수 있을까요? 성능 저하가 발생하지 않을 것이라는 것을 어떻게 알 수 있을까요?

Oracle에서는 이 질문에 답할 수 있는 방법이 있습니다! 프로덕션 시스템의 커서 캐시를 살펴보면 됩니다.

UNIQUE 제약 조건에 관한 이전 블로그 게시물에서 우리는 데이터베이스에 "I1DATA"라는 인덱스를 추가하고, 이 인덱스를 사용하는 몇 가지 쿼리를 실행했습니다. 며칠 후, 우리는 그 인덱스가 "프로덕션" 데이터베이스에서 여전히 사용되고 있는지 알고 싶습니다. 다음 쿼리를 실행하면 됩니다:

```sql
SELECT *
FROM v$sql
JOIN v$sql_plan USING (sql_id)
WHERE object_name = 'I1DATA'
```

이 쿼리는 프로덕션 시스템에 대한 수많은 정보를 보여주는 Oracle의 훌륭한 시스템 뷰를 사용합니다. 특히 v$sql과 v$sql_plan을 배워서 동료들에게 깊은 인상을 주세요! 위 쿼리는 다음과 같은 데이터를 반환합니다:

| SQL_TEXT | LAST_ACTIVE |
|---|---|
| SELECT COUNT(*) FROM X1 JOIN Y1 ... | 14.07.16 |
| SELECT count(*) FROM x1 JOIN y1 ... | 14.07.16 |
| SELECT count(*) FROM x1 WHERE a ... | 14.07.16 |
| SELECT COUNT(*) FROM X1 WHERE A ... | 14.07.16 |

네, 인덱스는 커서 캐시의 여러 쿼리에서 여전히 사용되고 있습니다 – 따라서 아직 삭제할 수 없을 것 같습니다.

## 주의

이러한 뷰는 인덱스가 사용되는지 신뢰성 있게 알려주지 않습니다. 이것들은 커서 캐시를 사용하는데, 커서 캐시는 커서를 오래 캐시하지 않거나 모든 커서를 캐시하지 않는 것을 포함하여 다양한 방식으로 구성될 수 있습니다. 어쨌든 다음과 같은 규칙을 세울 수 있습니다:

- 인덱스가 커서 캐시에 여러 번 나타나면 제거하지 않아야 합니다
- 인덱스가 커서 캐시에 한 번만 나타나면, 해당 특정 쿼리에 실제로 필요하지 않을 수도 있습니다. 분석하세요
- 인덱스가 커서 캐시에 나타나지 않으면, 쿼리를 자주 다시 실행하고, 시간이 지난 후(확신이 들면) 제거할 수 있습니다

## 주의 사항

- 일부 인덱스는 매우 드물게 실행되는 보고서를 위해 생성되었을 수 있습니다. 제안된 접근 방식은 이러한 시나리오를 다루지 못합니다
- 이 정보는 프로덕션 시스템에서 가장 신뢰할 수 있습니다. 개발자 컴퓨터에서는 의미 있는 정보를 얻을 수 없습니다

## 결론

이것은 그저 유용한 트릭일 뿐입니다. 신뢰할 수 있는 규칙이 아닙니다. 하지만 유용해 보이지 않는 크고 비용이 많이 드는 인덱스를 안전하게 제거할 수 있는지 평가하는 데 확실히 도움이 됩니다.
