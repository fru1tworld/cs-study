# jOOQ 화요일: Gerald Sangudi와 Keshav Murthy가 N1QL의 비밀을 밝히다 (JSON 기반 SQL)

> 원문: https://blog.jooq.org/jooq-tuesdays-gerald-sangudi-and-keshav-murthy-reveal-the-secrets-of-n1ql-sql-on-json/

jOOQ 화요일 시리즈에 오신 것을 환영합니다. 이 시리즈에서는 격월로 셋째 주 화요일마다 jOOQ 관점에서 우리 업계에서 흥미롭다고 생각되는 분들을 인터뷰한 글을 게시합니다. 여기에는 SQL, Java, 오픈 소스 및 다양한 관련 주제를 다루는 분들이 포함됩니다.

오늘은 N1QL 쿼리 언어의 창시자인 Gerald Sangudi와 Keshav Murthy를 소개하게 되어 매우 기쁩니다. N1QL은 CouchBase의 SQL 기반 JSON 쿼리 언어입니다.

## 두 분은 어떻게 만나셨나요?

Keshav: Gerald가 Couchbase 입사 면접에서 저를 인터뷰했습니다.

Gerald: 우리가 내린 최고의 결정이었습니다.

## JSON을 선택하게 된 계기는 무엇인가요?

Keshav: 저는 IBM에서 일했고, 특히 Informix 데이터베이스를 담당했습니다. 2013년에 Websphere 팀에서 JSON 지원이 필요했습니다. 저는 메타데이터 관리를 제외하고는 데이터 관리를 위한 JSON에 회의적이었습니다. 몇 년 전에 Informix 내부에 XML과 XQuery를 구현하는 것을 성공적으로 반대한 적이 있었습니다. 그러다가 NoSQL 컨퍼런스에 참석했는데, 거기서 기업들이 실제 애플리케이션에서 JSON을 사용하는 것을 보았습니다. eBay, Cisco 같은 기업들이 NoSQL과 JSON을 기반으로 엔터프라이즈 애플리케이션을 개발하는 것을 보았습니다.

RDBMS 고객들은 새로운 컬럼을 추가해야 할 때 ALTER TABLE ONLINE을 요청해 왔습니다. 일반적으로 사용하지 않는 추가 컬럼들을 미리 만들어 두고 필요할 때 이름을 바꾸곤 했습니다. 분명히, 이것은 최적의 솔루션이 아니었고 좋은 해결책도 아니었습니다. 왜냐하면 이런 컬럼들이 부족해질 수 있고, 타입이나 구조가 유연하지 않았기 때문입니다.

수년간 고객들은 애플리케이션이 온라인 상태일 때 ALTER TABLE을 요청해 왔습니다. 저는 JSON이 이것을 제공하는 좋은 방법이라는 것을 깨달았습니다. 그때 우리는 JSON을 타입으로 추가하고, 샤딩을 추가하고, JSON을 지원하도록 SQL을 확장하기 시작했습니다. 좋은 관계형 데이터베이스는 JSON에 많은 가치를 제공할 수 있습니다. 그래서 우리는 관계형 테이블에서 스키마 유연성을 제공하기 위해 JSON을 활용하는 메커니즘을 개발했고, 이에 대한 특허를 받았습니다: http://bit.ly/2og1uXe.

Couchbase에서 데이터는 JSON으로 저장되며, N1QL은 JSON을 위한 SQL로 설계되었습니다. 그래서 우리는 침착하게 JSON을 사용합니다.

Gerald: 저는 더 이상 Couchbase에 있지 않지만, 4년간 그곳에 있었습니다. Couchbase는 memcached와 CouchDB에 뿌리를 두고 있어서, N1QL 이전에, 그리고 우리가 도착하기 전부터 이미 JSON 데이터를 저장하고 관리하고 있었습니다. N1QL은 사용자들이 자신의 JSON 데이터를 쿼리하고 조작할 수 있도록 개발되었습니다.

## SQL 언어가 완전한 순환을 이루었나요? SQL 구문이 왜 여러분에게 그렇게 잘 맞나요?

Keshav: SQL의 공동 발명가인 Don Chamberlin이 이것을 말했습니다. XQuery 논의 당시, 그는 XML을 조작하기 위해 SQL을 사용하는 것에 반대했습니다. 이제 N1QL과 JSON용 SQL++를 통해, 그는 SQL이 JSON을 효과적으로 조작할 수 있는 엄청난 가능성을 보고 있습니다. 그래서 완전한 순환을 이루었다고 할 수 있습니다.

애플리케이션 관점에서, SQL이 복잡한 데이터 모델을 지원해야 한다는 요구사항은 항상 있었습니다. SQL-99는 언어에 구조화된 타입을 추가했지만, 스키마 유연성의 필요성을 인식하지 못했습니다.

Gerald가 매우 훌륭하게 한 것은 SQL을 계승하고 언어뿐만 아니라 기본 불리언 로직까지 확장한 것입니다.

SQL은 세 가지 값 로직을 가집니다: TRUE, FALSE, NULL. N1QL은 네 가지 값 로직을 가집니다: TRUE, FALSE, NULL 그리고 MISSING. SQL은 select-join-project 연산을 가지고 있습니다. N1QL은 이것들을 가지고 있으며, 배열 처리를 위한 NEST와 UNNEST 연산을 추가합니다. 로직과 연산, 타입 시스템을 갖추면, 중첩된 객체와 배열을 처리하기 위한 나머지 표현식들을 추가할 수 있습니다.

SQL과 비교하여 N1QL에는 또 다른 중요한 변화가 있습니다. SQL은 데이터를 조작하기 위한 쿼리 언어입니다. N1QL은 문서의 메타데이터(이름, 구조, 타입)를 동적으로 발견하고 그것에 대해 연산할 수 있습니다.

Gerald: SQL은 역사상 가장 위대하고 가장 성공적인 쿼리 언어입니다. 우리의 임무는 사용자들이 표준 SQL이 기대하는 것과 때로는 다른 데이터를 쿼리할 수 있도록 하는 것이었습니다. N1QL이 그것을 해내기를 바랍니다.

여담으로, N1QL의 "N1"은 비제1정규형(non-first normal form)을 의미합니다. Lukas 당신처럼 SQL 전문가는 "비제1"이 JSON 데이터와 관계형 데이터 사이의 주요 차이점 중 하나라는 것을 알 것입니다. 다른 주요 차이점들은 스키마와 균일성입니다.

## 관계형 데이터베이스 경쟁자들이 N1QL의 기능을 가져갈 것인가요? 아니면 여러분이 그들로부터 더 많은 기능을 가져올 것인가요?

Keshav: 저는 관계형 데이터베이스들이 N1QL의 기능을 가져가기를 바랍니다. 공통된 접근 방식으로 문제를 해결하면 고객이 올바른 문제에 적합한 데이터베이스를 선택하기가 더 쉬워집니다. 고객들이 RDBMS보다 Couchbase를 더 자주 선택하기를 바랍니다!

Gerald는 항상 좋은 이유가 없는 한 SQL과 다르게 하지 않는다고 말합니다. 그런 의미에서, 우리는 이미 관계형 데이터베이스의 많은 기능을 가져왔습니다. 또한, 인덱스 설계, 쿼리 최적화, 보안 및 모니터링과 같은 것들에 대해 관계형 데이터베이스의 성공적인 모델을 배웁니다. 우리는 거인의 어깨 위에 서 있습니다.

Gerald: 우리는 관계형과 비관계형 벤더 모두가 서로의 기능을 가져가기를 바랍니다. SQL++라는 것에 대한 협력적 노력이 있는데, 이것은 SQL과 N1QL 모두의 상위 집합입니다. 우리는 SQL++가 수렴 지점이 되기를 바랍니다. SQL의 성공에서 얻은 한 가지 교훈은 표준이 사용자와 벤더 모두에게 좋다는 것입니다.

## "스키마 없는" 데이터베이스에서 최적화는 어떻게 작동하나요?

Keshav: 사실, 정적 스키마는 구조를 제공하지만 데이터 분포는 제공하지 않습니다. 데이터 분포는 실행 비용을 계산하는 데 주요 요소입니다. N1QL은 쿼리 내의 정보와 사용 가능한 인덱스를 사용하여 구조를 파악하고 계획을 결정합니다. 예를 들어, `WHERE state = "CA" and zipcode = "94040"`이라는 조건을 가진 쿼리가 있고, state, zipcode 또는 둘 다에 인덱스가 있다면, 우리는 이러한 키-값이 문서에 존재한다고 가정하고 인덱스 스캔에 조건을 푸시다운합니다. DZone의 글에서 더 자세한 내용을 제공합니다: https://dzone.com/articles/a-deep-dive-into-couchbase-n1ql-query-optimization

별도로, 샘플링을 통해 스키마를 INFER(추론)하는 메커니즘이 있습니다. 현재, 추론된 스키마를 보여주어 사용자가 구조를 이해할 수 있게 합니다. 또한 워크벤치 내에서 힌트와 유효성 검사를 통해 쿼리 편집을 더 쉽게 만들기 위해 추론된 스키마를 사용합니다. 이것을 사용하고, 추가 통계를 수집하여 옵티마이저의 결정을 개선할 계획이 있습니다.

Gerald: N1QL 옵티마이저는 N1QL 작업의 즐거움 중 하나입니다. Keshav가 말한 대로, 대부분의 SQL 최적화 기술이 N1QL로 이어집니다. 데이터에는 정적 스키마가 없을 수 있지만, 쿼리에는 암시적 스키마가 있고, 인덱스에도 암시적 스키마가 있습니다. 즉, 쿼리에는 조건과 다른 특성이 있고, 각 인덱스에는 키와 다른 특성이 있습니다. 그것만으로도 옵티마이저가 바쁘게 일하기에 충분합니다.

## 데이터베이스 시장에서 다음 큰 흐름은 무엇이 될까요?

Keshav: 우리의 혁신 지표는 고객이 비즈니스에서 이루려는 진전입니다. 그래서 우리는 고객의 과제라는 제약 내에서 혁신합니다. 이것은 고객 관점에서 혁신하고 그 성공을 측정하는 데 도움이 됩니다.

우리는 고객들이 참여 시스템(systems of engagement)과 같은 새로운 패턴을 위해 NoSQL 데이터베이스를 배포하는 것을 봅니다.

휴가를 계획할 때, 구매하기 전에 많이 검색합니다. 장소, 호텔, 항공사, 할 것들을 검색합니다. 그런 다음 최종 구매 전에 비용, 평점을 비교합니다. 여행 회사의 경우, 이것은 낮은 지연 시간과 매우 낮은 비용으로 많은 수의 쿼리를 지원하기 위한 상당한 데이터베이스 인프라가 필요합니다.

우리는 고객들이 많은 고객 참여 및 정보 요구 사용 사례를 지원하기 위해 NoSQL 데이터베이스를 배포하는 것을 봅니다. RDBMS는 여전히 구매-판매-취소-체크인 등의 작업을 위한 기록 시스템(system of record)으로 사용되지만, 고객 경험을 향상시키기 위해 참여 시스템 데이터베이스와 통합될 것입니다.

이것을 효과적으로 수행하려면 데이터 플랫폼 설계, 스케일 아웃, 쿼리 처리, 인덱스 설계 및 관리 용이성의 모든 영역에서 혁신이 필요합니다.

Gerald: 저는 Jeff Bezos의 최신 주주 서한을 읽었습니다. 그는 변하지 않는 것이 변하는 것보다 더 중요하다고 말합니다. 데이터베이스는 데이터를 안정적으로 저장하고 빠르게 답변과 업데이트를 제공해야 합니다. 데이터베이스 벤더들이 그것을 계속 한다면, 우리는 괜찮을 것입니다.
