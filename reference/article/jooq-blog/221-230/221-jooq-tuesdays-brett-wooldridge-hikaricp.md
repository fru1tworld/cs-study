> 원문: https://blog.jooq.org/jooq-tuesdays-brett-wooldridge-shows-what-it-takes-to-write-the-fastest-java-connection-pool/

# jOOQ 화요일: Brett Wooldridge가 보여주는 가장 빠른 자바 커넥션 풀(Connection Pool) 작성법

jOOQ 화요일 시리즈에 오신 것을 환영합니다. 이 시리즈에서는 이 블로그에서 jOOQ 사용자들이 관심을 가질 만한 주제에 대해 인터뷰를 진행합니다.

저는 가장 빠른 자바 커넥션 풀인 HikariCP의 창시자 Brett Wooldridge를 만나 이야기를 나누었습니다.

## Brett, HikariCP를 그토록 유명하게 만든 것은 무엇인가요?

흥미로운 질문입니다, Lukas씨. 시작할 때, 저는 기존의 커넥션 풀들을 대체할 만큼 충분히 빠르다면 이미 존재하는 솔루션들을 밀어낼 정도의 추진력을 얻을 수 있을 것이라고 생각했습니다. 저는 성능 강조에 집중하며 마케팅을 시작했습니다.

HikariCP를 만들게 된 계기는 좌절감에서 비롯되었습니다. 저희 팀이 프로토타입 시스템의 부하 테스트를 진행하고 있었는데, 사용 중이던 커넥션 풀에서 데드락(교착 상태, deadlock)이 발생했습니다. 저는 소스 코드를 살펴보았고 수천 줄의 코드와 복잡한 잠금 메커니즘을 발견했습니다. 게다가 이 풀들은 JDBC 계약을 위반하고 있었습니다 - 연결이 풀로 반환될 때 제대로 정리되지 않았던 것입니다.

저는 "정말로? 자바가 나온 지 20년이 지났는데 커넥션 풀 생태계가 이 수준이란 말인가?"라고 생각했습니다.

HikariCP는 정확성을 우선시합니다. 연결이 풀로 반환될 때 자동으로 Statement를 닫고, 경고를 지우고, 변경된 속성들을 재설정합니다. 저는 처음에 소셜 미디어를 통해 성능을 홍보했고, 이것이 유기적인 채택으로 이어졌습니다. 특히 Wix 엔지니어링 팀이 그들의 전환 경험을 공개한 후 입소문을 통한 채택이 이어졌습니다.

## 복잡성이 증가하는 상황에서 어떻게 단순함을 유지하시나요?

저는 대부분의 기능 요청을 거절하여 단순함을 유지합니다. Saint-Exupery의 말을 인용하자면: 핵심 기능을 제거하지 않으면서 표면적을 최소화해야 합니다.

처음에 HikariCP는 고정 크기 풀만 지원했으며, 일정한 부하를 받는 시스템을 위해 설계되었습니다. 결국 채택 장벽이 분명해지면서 동적 크기 조정을 추가했지만, 구성 매개변수와 코드 표면적을 최소화하는 것은 계속하고 있습니다.

저희 뇌에는 한 번에 '시야에' 담을 수 있는 맥락 정보의 양에 한계가 있습니다. 단순함은 신뢰성의 전제 조건입니다.

## 바이트코드 수준의 최적화가 프로덕션 사용자에게 실제로 도움이 되나요?

네, 실제 환경에서 개선이 발생합니다. 한 사용자는 Tomcat CP에서 HikariCP로 전환하면서 70%의 실행 시간 감소를 보고했습니다. 다른 사용자는 2배 빨라졌다고 보고하기도 했습니다.

하지만 저는 Knuth의 "성급한 최적화(premature optimization)"에 대한 원칙을 따릅니다. HikariCP 성능 향상의 약 절반은 저수준 최적화가 아닌 알고리즘 변경에서 나왔습니다. 저는 Aleksey Shipilev의 JMH 프레임워크를 사용하여 JVM에서 실제로 무엇이 작동하는지 식별했습니다.

핵심은 JVM의 동작, 데드 코드 제거(dead code elimination), 자바 메모리 모델(Java Memory Model)의 의미론을 이해하고, 공유 상태에 대한 경합을 제거하는 것입니다. 가장 빠른 코드는 실행되지 않는 코드입니다.

## 당신의 작업은 큐잉 이론(Queueing Theory) 접근법과 어떻게 비교되나요?

커넥션 풀은 M/G/k 큐로 나타납니다 - 수학적으로 어려운 문제입니다. 저는 동적 튜닝을 시도하는 Vlad Mihalcea의 FlexyPool을 존경합니다.

제 풀 크기 조정 가이드라인은 데이터베이스 동시성 용량에 기반한 상한 제약에 초점을 맞추며, Vlad Mihalcea의 동적 풀 최적화에 대한 큐잉 이론 연구를 보완합니다.

## 일본어인 "Hikari"를 이름으로 선택한 이유는 무엇인가요?

저는 2008년부터 도쿄에 살고 있습니다. "Hikari"(光, "빛")는 이중적 의미를 담고 있습니다: 빛의 속도와 가벼운 코드라는 의미입니다.
