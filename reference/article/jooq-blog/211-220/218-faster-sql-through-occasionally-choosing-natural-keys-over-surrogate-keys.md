# 자연키(Natural Key)를 선택하여 SQL 성능 향상시키기

> 원문: https://blog.jooq.org/faster-sql-through-occasionally-choosing-natural-keys-over-surrogate-keys/

## 서론

데이터베이스 설계에서 대리키(Surrogate Key, 자동 생성되는 ID 등)를 사용하는 것이 일반적인 관례입니다. 하지만 이 글에서는 자연키(Natural Key)가 때때로 상당한 SQL 성능 향상을 가져올 수 있다는 점을 설명합니다.

자연키는 다루기 번거로울 수 있지만, 특정 상황에서는 측정 가능한 성능 이점을 제공합니다.

## 핵심 예제: 영화 카테고리

Sakila 데이터베이스를 사용하여 이 개념을 설명하겠습니다. 대리키를 사용하는 전통적인 스키마에서는 영화와 카테고리를 조인할 때 여러 테이블을 거쳐야 합니다. 반면 카테고리 이름을 자연키로 사용하면 하나의 JOIN을 완전히 제거할 수 있습니다.

### 대리키를 사용한 원본 쿼리

```sql
SELECT c.name, count(*)
FROM film_actor fa USING (actor_id)
JOIN film_category fc USING (film_id)
JOIN category c USING (category_id)
WHERE actor_id = 1
GROUP BY c.name
ORDER BY count(*) DESC
```

카테고리 테이블을 매번 조인하는 유일한 이유는 사용자에게 의미 있는 카테고리의 비즈니스 값을 표시해야 하기 때문입니다.

### 자연키를 사용한 최적화된 쿼리

```sql
SELECT fc.name, count(*)
FROM film_actor fa
JOIN film_category_natural fc USING (film_id)
WHERE actor_id = 1
GROUP BY fc.name
ORDER BY count(*) DESC
```

## 성능 결과

Oracle 실행 계획 분석에 따르면 자연키 접근 방식은 하나의 테이블 접근을 완전히 제거했습니다. 벤치마크 테스트(100회 반복)에서 극적인 개선이 나타났습니다:

| 쿼리 유형 | 실행 시간 |
|-----------|-----------|
| 대리키 사용 | 00:00:00.122070000 |
| 자연키 사용 | 00:00:00.051179000 |

결과: 2.5배 빠른 실행 속도

## 자연키가 적합한 경우

다음과 같은 엔티티들은 의미 있고 변하지 않는 식별자를 가지고 있어 자연키를 사용하기에 적합합니다:

- 카테고리 테이블: 이름을 키로 사용
- 번역/레이블 테이블
- 국가 테이블: ISO 3166 코드
- 언어 테이블: ISO 639 코드
- 통화 테이블: ISO 4217 코드
- 주식 심볼: ISIN 코드

## 주의사항

1. 저장 공간 문제: 자연키 값이 길수록 대리키보다 더 많은 디스크 공간을 소비합니다.

2. 유지보수의 어려움: 사용자가 기본키로 사용되어야 할 불변 값을 수정하고 싶어할 수 있습니다.

3. 보편적인 해결책이 아님: 이 글에서 강조하는 것처럼 이 최적화는 "가끔" 적용되는 것이지, 항상 적용되는 것이 아닙니다.

4. 데이터 무결성: 참조 테이블의 유일한 컬럼이 자연키가 되더라도, 제약 조건 적용을 위해 참조 테이블을 유지해야 할 수 있습니다.

## 결론

표준화된 패턴을 경직되게 따르기보다는 사려 깊은 스키마 설계가 필요합니다. 데이터가 기술적 식별자가 아닌 안정적이고 의미 있는 비즈니스 개념을 나타낼 때, 자연키는 쿼리 복잡성을 줄이고 성능을 향상시킬 수 있습니다.

> "여러분의 쿼리는 즉시 더 빨라질 것입니다—반드시 훨씬 빨라지는 것은 아니지만, 상당수의 쿼리 속도를 높일 수 있을 것입니다."
