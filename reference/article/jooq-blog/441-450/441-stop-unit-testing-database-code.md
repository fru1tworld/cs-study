# 데이터베이스 코드를 단위 테스트하지 마라

> 원문: https://blog.jooq.org/stop-unit-testing-database-code/

2014년 6월 26일 lukaseder 작성

> "실제 데이터베이스를 사용하는 테스트를 작성하는 것은 어렵다."

마침표.

이제 이 사실이 확립되었으니, 트랜잭션과 관련하여 데이터베이스 코드를 테스트할 때의 다양한 옵션을 상세히 설명한 Marco Behler의 블로그 글을 살펴보자. 데이터베이스 트랜잭션을 테스트하는 것은 단순히 데이터베이스 코드를 테스트하는 것보다 훨씬 더 어렵다. Marco는 이러한 테스트를 작성하기 _"더 쉽게"_ 만들기 위해 테스트를 조정하는 몇 가지 옵션을 나열한다.

그 옵션 중 하나는 다음과 같다:

> "3. 테스트에서 flush-mode를 FlushMode.ALWAYS로 설정하라"

(참고로, 이것은 Hibernate 코드 테스트에 관한 것이다).

Marco는 프로덕션과 다른 동작을 테스트하는 것이 좋은 아이디어인지 100% 확신하지 못하기 때문에 이 옵션을 괄호 안에 넣었다. 여기에 대한 우리의 견해가 있다:

### 데이터베이스 코드를 단위 테스트하지 마라

"더 간단한" 트랜잭션 동작을 달성하기 위해 테스트 설정을 조정하는 것에 대해 생각하기 시작하는 순간(또는 더 나쁘게는 데이터베이스에 목(mock)을 사용하는 것), 당신은 거의 실패한 것이나 다름없다. 당신은 프로덕션 시스템과 크게 벗어나는 _대안적인_ 시스템을 만들기 시작한다. 이것은 본질적으로 다음을 의미한다:

* 테스트 시스템에 대한 테스트 결과는 (거의) 아무런 의미가 없다
* 테스트가 프로덕션 시스템의 가장 복잡한 측면들 중 일부를 다루지 못할 것이다
* 유용한 비즈니스 로직을 구현하는 대신 테스트를 조정하는 데 너무 많은 시간을 쓰기 시작할 것이다

대신, 매우 높은 수준에서, 즉 아키텍처에 그런 것이 있다면 "서비스 레이어" 수준에서 비즈니스 로직을 테스트하는 _통합 테스트_ 작성에 집중하라. EJB를 사용한다면, 이것은 아마도 세션 빈 수준일 것이다. REST나 SOAP를 사용한다면, 이것은 REST나 SOAP 서비스 수준일 것이다. HTTP를 사용한다면(REST의 _레트로 이름_), 이것은 HTTP 서비스 수준일 것이다.

이 접근 방식의 장점은 다음과 같다:

* 100% 커버리지를 달성하지 못할 수도 있지만, 정말로 _중요한_ 부분에 대해 80% 커버리지를 (20%의 노력으로) 얻을 수 있다. UI(또는 외부 시스템)도 가장 기이한 형태로 데이터베이스를 호출하지 않는다. 그것은 서비스를 호출한다. 왜 서비스 외에 다른 것을 테스트하겠는가?
* 테스트가 유지보수하기 매우 쉽다. UI(또는 외부 시스템)에 대한 공개 API가 있다. 그것은 형식적이고 이해하기 쉽다. 잘 정의된 입력과 출력 파라미터를 가진 블랙박스이므로 테스트를 읽고 쓰기가 쉽다.

### 데이터베이스는 상태를 가진다. 당연히

당신이 해야 할 일은 데이터베이스가 언젠가 _"단위"_(_"단위" 테스트_에서의 "단위")에 참여할 것이라는 생각을 버리는 것이다. 단위는 꽤 상태가 없으며, 따라서 예를 들어 함수형 알고리즘에 대해 상호 독립적인 단위 테스트를 작성하는 것은 _매우_ 쉽다.

데이터베이스는 이보다 더 상태가 없을 수 없다. 데이터베이스의 전체 아이디어는 상태를 관리하는 것이다. 그리고 그것은 매우 복잡하고 어떤 단위 테스트도 모델링할 수 없는 것과 완전히 반대된다. 가장 의미 있는 상태 전환 중 많은 것들이 여러 데이터베이스 상호작용, 또는 심지어 트랜잭션, 또는 어쩌면 서비스에까지 걸쳐 있다. 예를 들어, `CREATE_USER` 서비스 호출 직후에 `CHANGE_PASSWORD` 호출이 즉시 따라오는 것이 중요할 수 있다. 이것은 서비스 레이어에서만 통합 테스트할 수 있다. 믿지 못하겠는가? `CREATE_USER`가 외부 LDAP 시스템에 의존한다면 어떨까? 또는 저장 프로시저의 복잡한 보안 로직에 의존한다면? 통합 테스트는 그것을 다룰 수 있다.

### 핵심 요점

> "실제 데이터베이스를 사용하는 테스트를 작성하는 것은 어렵다."

그렇다. 그것은 변하지 않을 것이다. 하지만 당신의 인식은 변할 수 있다. 이 사실을 피해가려고 이것저것 조정하려 하지 마라. 잘 알려진 테스트 데이터베이스를 만들어라. 테스트 사이에 리셋하라. 그리고 매우 높은 수준에서 통합 테스트를 작성하라. 20/80의 비용/효익 비율이 더 나은 선택지를 남기지 않을 것이다.

우리가 jOOQ API를 16개의 실제 RDBMS에 대해 통합 테스트하는 방법에 대한 또 다른 블로그 글을 이 블로그에서 기대해 달라.
