# Jepsen 분석: Datomic Pro 1.0.7075

## 개요
Kyle Kingsbury의 Jepsen 테스트 보고서는 시간적 Entity-Attribute-Value 데이터베이스인 Datomic Pro 1.0.7075를 평가합니다. 분석 결과 트랜잭션 간 안전성이 주장을 초과하여 단일 피어 세션에 대해 "강력한 세션 직렬화 가능(Strong Session Serializable)"으로 나타났습니다. 그러나 트랜잭션 내 작업은 직렬이 아닌 동시에 실행되어 잠재적인 불변 위반을 생성합니다.

## 주요 발견사항

### 트랜잭션 간 안전성
테스트 결과 문서화된 것보다 더 강력한 속성이 드러났습니다. 동기화를 위해 `d/sync`를 사용할 때 쓰기 트랜잭션 히스토리가 엄격하게 직렬화 가능한 것으로 나타났습니다.

### 트랜잭션 내 의미론
단일 트랜잭션 내의 작업은 동시에 실행되는 것처럼 동작합니다. 모든 트랜잭션 함수는 중간 변경이 아닌 트랜잭션 시작 시점의 데이터베이스 상태를 관찰합니다. 이로 인해 비정상적인 동작이 발생합니다: 여러 증가 작업이 복합되지 않고 단일 증가로 축소됩니다.

## 기술적 아키텍처

Datomic은 트랜잭터(쓰기 실행), 피어(JVM 라이브러리를 내장한 두꺼운 클라이언트), 클라이언트(얇은 클라이언트)로 구성됩니다. 시스템은 DynamoDB와 같은 시스템에 저장된 불변 영속 트리를 사용하며, 일관성을 유지하기 위해 compare-and-set 작업을 사용합니다.

## 발견된 이상 현상

### 내부 일관성 문제
두 개의 CaS 작업이 한 트랜잭션에서 동일한 속성을 대상으로 할 때, 둘 다 첫 번째 결과가 아닌 초기 상태를 관찰합니다. 이는 전통적인 직렬 실행 모델의 기대를 위반합니다.

### 의사 쓰기 스큐
"grant" 워크로드가 불변 위반을 보여주었습니다. 전제 조건을 확인하는 트랜잭션 함수는 분리된 쓰기 세트로 단일 트랜잭션에서 구성될 때 안전하지 않을 수 있으며, 이는 스냅샷 격리의 쓰기 스큐와 유사합니다.

## 테스트 워크로드

1. 목록 추가: 읽기-쓰기 의존성 전반에 걸친 광범위한 일관성 검증을 위해 Elle 트랜잭션 검사기 사용
2. CaS를 사용한 목록 추가: compare-and-set 작업을 사용하여 스냅샷 격리 패턴 구현
3. 내부: 트랜잭션 내 일관성을 측정하는 수작업 테스트
4. Grant: 불변 구성 문제를 보여주는 상태 머신 워크로드

## 문서 명확화

보고서로 인해 Datomic이 안전성 문서를 수정하여 오해의 소지가 있는 "단일 작성자" 특성을 제거했습니다. 업데이트된 문서는 이제 트랜잭션 요청과 어설션 요청을 구분하고, 트랜잭션 함수가 값을 반환할 수 없음을 명확히 하며, 동시 트랜잭션 내 의미론을 더 명시적으로 문서화합니다.

## 사용자를 위한 권장 사항

사용자는 순차적 트랜잭션 내 실행에 대한 가정을 피해야 합니다. 엔터티 술어는 명시적으로 호출될 때 안전 메커니즘을 제공합니다. 충돌 검사기는 동일한 엔터티의 모순되는 단일 카디널리티 속성 업데이트가 있는 트랜잭션을 중단하여 많은 이상 현상을 방지하지만, 분리된 업데이트는 보호되지 않습니다.

## 연구적 시사점

분석은 직렬 트랜잭션 간이지만 동시 트랜잭션 내 의미론을 가진 데이터베이스에 주요 트랜잭션 격리 형식주의가 적용되는지에 대한 질문을 제기합니다. 보고서는 스냅샷 격리 이론 및 시간적 데이터베이스 연구와의 연결을 제안하고, 단조적 트랜잭션 함수 구성과 CALM 정리 적용에 대한 향후 조사를 제안합니다.
