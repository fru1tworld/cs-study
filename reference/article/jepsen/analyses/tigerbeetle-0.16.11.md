# Jepsen 분석: TigerBeetle 0.16.11

## 요약

Jepsen은 금융 거래를 위해 설계된 분산 OLTP 데이터베이스인 TigerBeetle 버전 0.16.11부터 0.16.30까지 종합적인 테스트를 수행했습니다. 분석 결과 2개의 안전성 문제, 7개의 클라이언트/서버 충돌, 그리고 여러 성능 문제를 식별했지만, 대부분은 버전 0.16.43에서 해결되었습니다.

## 주요 발견사항

### 안전성 문제

누락된 쿼리 결과 (#2544)
버전 0.16.13에서 여러 조건자가 있는 쿼리가 일상적으로 결과를 누락했습니다. 문제는 "여러 인덱스 간의 지그재그 병합 조인 버그"에서 비롯되어 조기 스캔 종료를 유발했습니다. 0.16.17에서 수정됨.

잘못된 타임스탬프 헤더 (#2495)
Java 클라이언트의 실험적 타임스탬프 API가 재사용되는 "변경 가능한 싱글톤 응답 객체"로 인해 중복 값을 반환했습니다. 0.16.14에서 해결됨.

### 심각한 충돌

1. 클라이언트 메모리 접근 (#2435): 클라이언트를 닫을 때 초기화되지 않은 필드로 인해 세그폴트 발생 (0.16.12에서 수정)
2. 클라이언트 제거 충돌 (#2484): 오류 반환 대신 세션 제거 시 프로세스 충돌 (0.16.13에서 수정)
3. 디스크 손상 패닉 (#2681): 패딩 영역의 비트플립으로 어설션 트리거 (0.16.26에서 수정)
4. 업그레이드 발산 (#2745): 0.16.26 업그레이드 중 체크포인트 발산 (해결 방법 문서화)
5. 릴리스 전환 패닉 (#2758): 빠른 업그레이드 중 과도한 어설션 (0.16.29에서 수정)
6. 사용되지 않는 메시지 유형 (#2763): 업그레이드 중 알 수 없는 메시지 유형으로 충돌 (0.16.29에서 수정)

### 성능 문제

단일 노드 장애 영향 (#2739)
링 토폴로지 복제로 인해 노드 장애 시 지연 시간이 "1밀리초 미만에서 10초로" 급증했습니다. 주(primary)가 순차적 링 노드로부터 승인을 기다려야 하므로 연쇄 지연이 발생합니다. 양방향 링 복제와 동적 토폴로지 적응을 통해 0.16.43에서 상당히 개선됨.

## 설계 관찰

### 재시도 철학
TigerBeetle 클라이언트는 "절대 타임아웃되지 않고" 무한히 재시도합니다. 거짓 음성을 피함으로써 안전성을 보존하지만, 확실한 오류를 무기한 오류로 변환합니다. 보고서는 이것이 오류 처리를 복잡하게 하고 애플리케이션 수준 복구 메커니즘을 방해한다고 언급합니다.

### 강력한 직렬화 가능성
테스트 결과 TigerBeetle이 장애 상황에서도 프로토콜 인식 복구와 광범위한 체크섬을 사용하는 Viewstamped Replication을 통해 강력한 직렬화 가능(Strong Serializable) 일관성을 유지함을 확인했습니다.

### 뛰어난 디스크 복원력
TigerBeetle은 비트플립, 잘못된 쓰기, 모든 복제본에 걸친 손상을 견뎠습니다—전체 데이터 손실 제외. 분석에서 치명적인 단일 노드 디스크 장애로부터 "복구를 위한 안전한 경로가 없음"을 발견했습니다. 버전 0.16.43에서 이 격차를 해결하는 `tigerbeetle recover` 명령이 도입되었습니다.

## 테스트 방법론

Jepsen은 타임스탬프 검증과 상태 머신 모델링을 결합한 정교한 검사기를 개발했습니다:
- Elle 그래프 분석을 통한 타임스탬프 순서 검증
- 1,600줄 이상의 Clojure 모델을 통한 의미적 정확성
- 결함 주입: 프로세스 충돌, 네트워크 분할, 클럭 스큐, 특정 영역에 걸친 디스크 손상

## 권장 사항

1. 0.16.43 이상으로 업그레이드
2. 0.16.26 업그레이드 중 주의; 클라이언트 일시 중지 및 클러스터 상태 확인
3. 스테이징 환경에서 단일 노드 장애 시나리오 테스트
4. 클라이언트 측 재시도에도 불구하고 애플리케이션 수준 타임아웃 처리 구현
5. 클러스터 합의 없이 실패한 노드 재포맷 금지

## 결론

분석은 복잡한 장애 시나리오에서 강력한 직렬화 가능성이 보존되는 "정확성에 대한 상쾌한 헌신"을 반영합니다. 대부분의 문제는 데이터 손상보다 충돌과 관련되었으며, 종종 방어적 어설션에 의해 트리거되었습니다. TigerBeetle의 결정론적 시뮬레이션 테스트, 통합 테스트 및 속성 기반 검증에 대한 투자가 문제 발견과 해결 모두에서 효과적임이 입증되었습니다.
