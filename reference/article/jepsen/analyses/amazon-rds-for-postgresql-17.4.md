# Amazon RDS for PostgreSQL 17.4 Jepsen 분석

## 기본 정보
- 저자: Kyle Kingsbury
- 발행일: 2025-04-29

## 핵심 발견사항

Jepsen의 연구팀은 "Amazon RDS for PostgreSQL multi-AZ 클러스터가 스냅샷 격리(Snapshot Isolation)를 위반한다"고 결론지었습니다.

### 구체적 문제

- 건강한 클러스터에서 Long Fork 및 G-nonadjacent 순환이 몇 분마다 발생
- 버전 13.15부터 17.4까지 모든 테스트 버전에서 동일 현상 관찰
- 대신 병렬 스냅샷 격리(Parallel Snapshot Isolation)를 제공할 가능성 제시

## 기술적 세부사항

### 테스트 설계
- 인스턴스: db.m6id.large
- 스토리지: gp3
- 워크로드: 정수 목록에 대한 트랜잭션 (읽기/쓰기)
- 동시성 수준: 초당 약 150개 쓰기 트랜잭션, 1600개 읽기 전용 트랜잭션

### 구체적 예시 (4개 트랜잭션 순환)

분석 대상 순환은 다음 패턴을 보였습니다:
- T₁: 행 89에 9 추가 → [4 9]
- T₂: T₁의 수정 관찰 ✓
- T₃: 행 90에 11 추가 → [11]
- T₄: T₃의 수정 관찰 ✓, T₁의 수정 미관찰 ✗

역설: T₂가 T₁을 관찰했으나 T₃은 미관찰, T₄가 T₃을 관찰했으나 T₁은 미관찰

## 근본 원인 (2025-05-03 업데이트)

AWS의 Sergey Melnik이 식별한 원인:
- PostgreSQL 주(Primary) 노드: 메모리 내 잠금으로 트랜잭션 순서 결정
- 보조(Secondary) 노드: Write-Ahead Log(WAL) 순서로 트랜잭션 표시
- 두 순서의 불일치로 인한 일관성 위반

## 사용자 권장사항

- 트랜잭션 구조에서 Long Fork 가능성 검토
- 안전성이 중요한 트랜잭션에 쓰기 작업 포함
- 가능하면 읽기 전용 보조 노드 대신 주 엔드포인트 사용

## 법적 고지
Jepsen 윤리 정책에 따른 독립적 수행, 보상 없이 실시
