# NATS 2.12.1 Jepsen 분석

## 개요
이 보고서는 NATS JetStream 버전 2.12.1의 데이터 내구성 및 일관성 보장에 대한 종합적인 분산 시스템 테스트 결과입니다.

## 주요 발견사항

### 발견된 중요한 문제들

1. 충돌 시 스트림 삭제 (2.10.22) - 버전 2.10.23에서 수정됨. 프로세스 충돌로 인해 JetStream이 모든 스트림에 대한 인식을 잃을 수 있었습니다.

2. 블록 파일 손상 (#7549) - "JetStream의 `.blk` 파일에서 단일 비트 오류 또는 잘림이 발생하면 클러스터가 대량의 쓰기를 손실할 수 있습니다." 한 테스트에서 총 1,367,069건의 쓰기 중 679,153건의 승인된 쓰기가 손실되었습니다. 상태: 미해결.

3. 스냅샷 파일 손상 (#7556) - 소수 노드에서의 파일 손상으로 인해 고아 스트림 선언과 완전한 데이터 삭제가 발생했습니다. 상태: 미해결.

4. 지연 fsync 기본값 (#7564) - "기본적으로 NATS는 2분마다 한 번만 `fsync`를 호출하여 데이터를 디스크에 플러시하지만, 메시지는 즉시 승인합니다." 이는 표준 Raft 합의 요구사항을 위반합니다. 상태: 문서화됨.

5. 단일 OS 충돌 분열 뇌 (#7567) - 네트워크 지연과 결합된 단일 전원 장애가 지속적인 복제본 발산을 유발할 수 있으며, 이로 인해 서로 다른 노드가 서로 다른 커밋된 데이터를 가질 수 있습니다. 상태: 미해결.

## 테스트 방법론

- JNATS Java 클라이언트(v2.24.0)와 함께 Jepsen 테스트 프레임워크 사용
- 복제 계수 5로 3-5개 노드 클러스터 테스트
- 주입된 결함: 프로세스 일시 중지, 충돌, 네트워크 분할, 파일 손상, LazyFS를 사용한 시뮬레이션된 전원 장애
- 최소 한 번 전달 의미론 측정

## 핵심 기술적 통찰

이 보고서는 합의 프로토콜이 일반적으로 "노드가 승인하기 전에 새 로그 항목을 디스크에 플러시해야 한다"고 요구한다고 언급하며, Paxos 및 Raft 문헌의 기초 연구를 인용합니다.
