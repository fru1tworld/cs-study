# Redpanda 21.10.1 Jepsen 분석

## 개요
이 종합적인 Jepsen 분석은 Redpanda 버전 21.10.1부터 21.11.2까지의 Kafka 호환 분산 스트리밍 기능을 테스트했습니다. 조사 결과 주의가 필요한 중요한 안전성 및 활성도 문제가 식별되었습니다.

## 주요 발견사항

발견된 문제: 총 10개 (안전성 7개, 활성도 3개)

### 중요한 안전성 문제

1. 중복 쓰기 - 멱등성 주장에도 불구하고 기본 설정에서 메시지 중복이 허용됨. Kafka Java 클라이언트의 "enable.idempotence = true" 설정이 명시적 서버 구성 없이는 Redpanda 21.10.1에서 효과가 없었음.

2. 일관성 없는 오프셋 - 네트워크 장애로 메시지가 다른 로그 위치에 다시 나타남. 프로세스 충돌로 수백 개의 메시지가 재정렬되어 동일한 메시지가 여러 오프셋에서 동시에 보임.

3. 손실/부실 메시지 - 가장 강력한 안전 설정(acks=all, retries=0)에도 불구하고 승인된 쓰기가 컨슈머 뷰에서 사라짐. 한 테스트에서 복구 시도 후 11,225개 메시지 중 9,988개가 영구적으로 누락됨.

4. 트랜잭션 이상:
   - 실패한 트랜잭션에도 불구하고 컨슈머에게 보이는 중단된 읽기
   - 트랜잭션 간 순환 정보 흐름
   - 트랜잭션 인터리빙을 허용하는 쓰기 사이클
   - 단일 트랜잭션 내에서 오프셋을 되감는 내부 비단조 폴

### 충돌 문제

- 잘못된 오류 메시지와 함께 파티션 해제 중 assert 실패
- 프로세스 충돌 중 fetch 응답 처리에서 assertion 실패

## 확인된 근본 원인

- Raft 합의 구현이 커밋 확인 전에 상태 머신 적용을 허용
- 시퀀스 번호가 순서 없이 도착할 때 중복 제거 실패
- 클라이언트 승인 전 트랜잭션 코디네이터 충돌
- 마지막 안정 오프셋 계산의 off-by-one 오류

## 해결 현황

해결됨 (21.10.3+):
- 명시적 멱등성이 활성화된 중복 쓰기
- 일관성 없는 오프셋 재정렬
- 중단된 읽기 및 순환 정보 흐름(wr-only)

최근 수정됨 (21.11.15):
- InvalidTxnState 오류가 있는 중단된 읽기
- 손실된 트랜잭션 쓰기

22.1.1로 예정:
- 기본 중복 쓰기 방지
- 파티션 ID 처리의 assert 실패

아직 미해결:
- 파티션 해제 충돌
- 손실/부실 메시지 복구 메커니즘

## 구성 권장사항

분석 결과 여러 결함 허용 불가 기본값이 드러남:

- `redpanda.enable_idempotence = true` 명시적 설정
- `redpanda.default_topic_replications = 3` 구성
- `redpanda.transaction_coordinator_replication = 3` 설정
- `redpanda.id_allocator_replication = 3` 설정
- 자동 토픽 생성 비활성화: `redpanda.auto_create_topics_enabled = false`

## 권장사항

1. 즉시 Redpanda 21.11.15로 업그레이드
2. 출시되면 22.1.1 업그레이드 계획
3. 모든 복제 계수를 명시적으로 3+로 구성
4. 기본 트랜잭션 격리 가정에 의존하지 않음
5. 트랜잭션 안전을 위한 사용자 정의 리밸런스 리스너 구현
6. 공식 소스와 함께 Confluent 및 타사 문서 검토
