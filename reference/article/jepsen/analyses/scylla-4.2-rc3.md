# Scylla 4.2-rc3 Jepsen 분석

## 개요
Kyle Kingsbury의 이 분석은 분산 데이터베이스 Scylla 4.2-rc3을 대상으로 한 종합적인 일관성 검증 보고서입니다. ScyllaDB의 자금 지원으로 수행되었으며, Jepsen 윤리 정책을 준수했습니다.

## 주요 발견사항

### 1. LWT(Lightweight Transactions) 문제

- 분할-뇌 현상(Split-Brain): 건강한 클러스터에서도 LWT 작업이 선형화 가능성을 위반했습니다. 예를 들어, 읽기가 "수십 초 전에 대체된 값"을 반환하는 현상이 관찰되었습니다.

- 중단된 읽기: LWT 쓰기가 실패한 것처럼 보였지만 실제로는 성공한 경우가 있었습니다. 시스템이 "쿼럼 일관성 수준에서 충분한 레플리카 없음" 예외를 반환했지만, 이후 읽기에서 해당 값이 보였습니다.

- 멤버십 변경 중 분할-뇌: 노드가 추가/제거될 때 완전히 독립적인 데이터 타임라인이 관찰되었습니다.

### 2. 비-LWT 작업의 격리 문제

"업데이트는 단일 파티션 내에서 원자적이고 격리된" 주장이 부정확했습니다. 연구팀은 다음을 관찰했습니다:

- 단일 쓰기 그룹의 다양한 값들이 섞여 있는 읽기
- 집합 및 지도 업데이트에서 "세 개의 완전히 별개 쓰기에서 온 값들"
- QUORUM 또는 ALL 일관성 수준으로도 방지 불가능한 문제

### 3. 배치 업데이트 반환 값 문제

배치 작업이 결과를 반환할 때:

- 행들이 배치 문에서의 순서가 아닌 클러스터링 키로 정렬됨
- 일부 경우 새로 삽입된 행에 대한 결과가 완전히 누락됨

이는 어느 반환된 행이 어느 업데이트에 해당하는지 식별 불가능하게 만들었습니다.

### 4. 파괴적 INSERT 동작

초기 빈 컬렉션 삽입(`{}`)이 이후 업데이트를 무효화할 수 있었습니다. 이는 "설계에 따른 것"이지만 대부분의 사용자가 예상하지 못하는 동작이었습니다.

## 수정 현황

| 이슈 | 설명 | 수정 버전 |
|------|------|---------|
| 7258 | 중단된 LWT 읽기 | 4.2.1 |
| 7113 | 배치 업데이트 누락 | 4.3.rc1 |
| 7170 | 격리 부족 | 문서화됨 |
| 7116 | 건강한 클러스터의 분할-뇌 | 4.2 |
| 7359, 7611, 7351 | 멤버십 변경 관련 문제 | 일부 미해결 |

## 권장사항

### 사용자를 위한 조언

- Scylla 4.2 이상으로 업그레이드 필수
- 안전이 중요한 경우 기존 데이터 업데이트에 LWT 사용
- 멤버십 변경 시 안전-중요 작업 일시 중지
- 노드 제거 전에 "진정으로 죽어있는" 상태 확인
- 초기 값 삽입 후 업데이트 구조 피하기

### 기술적 완화 전략

- 클럭 동기화 유지 및 모니터링
- 업데이트 빈도 감소
- LWT 조건 필드를 행 끝에 배치 (초기 버전에서)

## 결론

보고서는 "Scylla 4.2 개발 빌드가 제한된 트랜잭션(단일 파티션 내 단일 읽기 또는 배치 쓰기)에 대해 엄격한 직렬화 가능성을 제공하는 데 거의 근접"했다고 언급했습니다. Raft 기반 멤버십 시스템으로의 전환이 남은 문제 해결에 도움이 될 것으로 예상됩니다.
