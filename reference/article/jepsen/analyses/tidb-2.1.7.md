# TiDB 2.1.7 Jepsen 분석

## 개요
Kyle Kingsbury의 이 Jepsen 보고서는 Google의 Percolator 모델을 기반으로 한 분산 SQL 데이터베이스인 TiDB 2.1.7부터 3.0.0-rc.2까지를 평가합니다. 분석 결과 초기 버전에서 심각한 트랜잭션 일관성 문제가 드러났으며, 이후 릴리스에서 개선되었습니다.

## 중요한 발견사항

### 주요 문제

자동 재시도 메커니즘: TiDB의 기본 구성에는 스냅샷 격리 보장을 위반하는 두 개의 별도 재시도 메커니즘이 포함되어 있었습니다. 이들은 충돌 중에 업데이트를 무분별하게 다시 적용하여 "읽기 스큐, 손실된 업데이트, 호환되지 않는 순서"를 유발했습니다.

손실된 업데이트: 테스트에서 트랜잭션이 충돌하면서 "여러 '체인'의 값이 동시에 존재"하여 데이터 손상을 유발하는 인스턴스가 문서화되었습니다. 30초 테스트에서 "TiDB는 378개 삽입 중 64개를 손실"했습니다.

읽기 스큐: 은행 계좌 시뮬레이션에서 총액이 "변동"하고 "30초 이내에 두 배"가 되는 것을 보여주며, 스냅샷 격리 기대를 위반했습니다.

### 부차적 문제

- 시작 충돌: TiKV 노드가 Placement Driver에 대한 제한된 재연결 시도 후 충돌
- 스키마 경합 조건: 성공적으로 생성된 테이블이 가끔 존재하지 않는 것으로 보고됨
- 복제 부족: 새 클러스터가 복제본이 아닌 단일 노드에 저장된 쓰기를 수락하여 데이터 손실 위험
- Select...For Update 제한: 존재하지 않는 행에서 잠금 메커니즘 실패, 쓰기 스큐 허용

## 영향받는 버전

- 기본적으로 문제 있음: 2.1.7, 2.1.8, 3.0.0-beta.1, 3.0.0-beta.1-40
- 수정됨: 3.0.0-rc.2 (자동 재시도 기본적으로 비활성화)

## 해결 방법

사용자는 스냅샷 격리를 달성하기 위해 `tidb_retry_limit = 0`을 통해 두 재시도 메커니즘을 일시적으로 비활성화할 수 있었지만, 이로 인해 처리량이 감소했습니다.

## 권장사항

버전 3.0.0으로 업그레이드하거나 재시도 메커니즘을 비활성화하세요. 클러스터 초기화를 주의 깊게 모니터링하고 데이터를 쓰기 전에 전체 복제를 보장하세요.
