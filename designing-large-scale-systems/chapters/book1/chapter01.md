# 1장 사용자 수에 따른 규모 확장성

## 단일 서버

모든 컴포넌트가 단 한대의 단일 서버에서 실행되는 간단한 시스템

## 데이터베이스

사용자가 늘면 여러 서버를 두어야하고 보통 트래픽 처리, 데이터베이스 용으로 나눈다.

- RDBMS
- NoSQL(Not only SQL)
  - key-value store, graph store, column store, document store
  - 일반적으로 JOIN 지원하지 않음
- NoSQL을 고려해볼 수 있는 분야
  - 아주 낮은 latency가 요구됨
  - 비정형이라 관계형 데이터가 아님
  - serialize, deserialize를 할 수 있기만 하면 됨
  - 아주 많은 양의 데이터를 저장할 필요가 있음

## 수직 규모 확장 vs 수평적 구조 확장

- scale up(수직 규모 확장)
  - 서버에 고사양 자원 추가
- sacle out(수평 규모 확장)
  - 더 많은 서버를 추가
- 따라서 수직 규모 확장에는 한계가 존재함, 또한 자동복구(failover) 다중화(redundancy)를 제시하지 않음
- 대규모는 수평적 규모 확장이 보다 적절함

- 로드 밸런서 : 로드밸런서는 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 함

- master-slave 관계 : 원본과 사본을 따로 저장하고 쓰기 연산을 master에서 진행 slave는 읽기 연산을 지원
  - 이점: 더 나은 성능, 안정성, 가용성
- 부 서버가 다운되면 주서버로 이전될 수 있음, 새로운 부 서버가 장애 서버를 대체함
- 주 서버가 다운되면 부 서버가 일을 대체하는데 프로덕션 환경에서는 실제보다 더 복잡하다.

  - 최신 상태가 아닐 수 있음
  - 복구 스크립트를 추가해야하거나, 다중 마스터, 원형 다중화를 하면 대처하는데 도움이 될 수 있음

- 업데이트된 설계안
  - DNS로부터 로드밸런서의 공개 IP를 받는다.
  - HTTP 요청은 서버1, 2로 전달된다.
  - 웹 서버의 query 는 부 서버에서 처리
  - 웹 서버의 Command는 주 서버에서 처리
- latency 개선
  - 캐시와 CDN(Content Delivery Network)로 개선가능

## 캐시

- 자주 참조되거나 값비싼 연산결과를 넣어둠
- 주의점 : 데이터 일관성(consistency), DB
- 캐시 서버가 한대라면 SPOF(Single Point Of Failure)가 될 수 있음
  - 어떤 특정 지점에서의 장애가 전체 시스템의 동작을 중단시켜버릴 수 있는 경우
- 캐시 메모리: 너무 낮으면 eviction 되어 캐시 성능이 떨어짐
- 데이터 방출 정책, 보관 데이터의 만료 정책등을 고민해볼 수 있음
- 방출 정책(LRU, LFU, FIFO 등을 고민해볼 수 있음)
  - 마지막 사용 시점이 가장 오래된(Least Recently Used)
  - 가장 빈도가 낮은 데이터를 보내는 정책(Least Frequently Used)

## 콘텐츠 전송 네트워크

- CDN
  - 정적 콘텐츠를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크( 이미지 비디오 JS 파일 등을 캐시할 수 있음)
  - 동적 콘텐츠는 요청 경로, 질의 문자열, 쿠키, 요청 헤더 등의 정보를 기반하여 HTML 페이지를 캐시함
  - 고려사항
    - 비용
    - 적절한 만료 시한 설정
    - 장애 대처
    - 콘텐츠 무효화

## 무상태 웹 계층

- 상태 정보를 웹 계층에서 제거해야한다.
- 상태 정보를 DB에 저장할 필요가 있다.
- 이렇게 웹 계층에서는 상태 정보가 없고 필요할때 가져오는 것을 무상태 웹 계층이라 한다.
- 무상태 웹 계층의 이유
  - 같은 클라이언트는 같은 서버로 전송을 해야 인증 실패를 하지 않음
  - 이를 위해 로드밸런서에서 고정 세션을 제공하는데 이는 로드밸런서에 부하가 됨
  - 그 외 여러가지로 서버의 장애 및 로드 밸런스 뒷단에 서버 추가 및 삭제가 까다로움

## 데이터 센터

두 개의 데이터 센터를 이용할 경우 장애가 없다면 가장 가까운 곳으로 데이터 센터가 이동된다.

이 절차를 지리적 라우팅(geoDNS-routing, geo-routing)이라 한다.

데이터 센터의 장애가 발생하면 다른 데이터 센터로 전송된다.

다중 데이터 센터 구현을 위한 기술적 난제

- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야한다.
- 데이터 동기화 : 데이터 센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면 장애가 자동으로 복구되어 트래픽이 다른 데이터베이스를 우회해도 없을 수 있음 따라서 일반적으로는 여러 데이터 센터에 걸쳐 다중화를 해놨음
- 테스트와 배포: 여러 데이터 센터를 사용한다면 여러 위치에서 테스트를 할 필요가 있음
  - 자동화 배포 도구는 모든 데이터 센ㅌ너에 동일한 서비스가 설치되도록 하는데 중요한 역할을 함

시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴포넌트를 분리하여 각기 독립적으로 확장할 수 있어야함 이를 위해 메시지 큐를 사용하여 분산 시스템을 구현하려고함

## 메시지 큐
